<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WII PREIZKUS ZNANJA - SYSTEM V3 (Slike & Sync)</title>
    <style>
        :root {
            --bg-grey: #f0f0f0;
            --header-grey: #e0e0e0;
            --wii-blue: #0099ff;
            --wii-dark: #333;
            --nav-answered: #cceeff;
            --danger: #ff4444;
            --success: #00C851;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0; background-color: #888; height: 100vh;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        #app-container {
            width: 100%; max-width: 1200px; height: 95vh; background: #fff;
            display: flex; flex-direction: column; border: 2px solid #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        button { cursor: pointer; }
        input, select { padding: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        
        /* --- LOGIN --- */
        .center-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; text-align: center; background: var(--bg-grey);
        }
        .login-box {
            background: white; padding: 40px; border: 1px solid #999;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1); width: 320px;
        }

        /* --- EXAM UI --- */
        #exam-header {
            height: 50px; background: var(--header-grey); border-bottom: 1px solid #999;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-weight: bold;
        }
        #progress-container { width: 100%; height: 8px; background: #eee; border-bottom: 1px solid #ccc; }
        #progress-bar { height: 100%; width: 0%; background: var(--wii-blue); transition: width 0.3s; }
        
        #exam-body { display: flex; flex: 1; overflow: hidden; }
        #question-area { flex: 3; padding: 30px; overflow-y: auto; border-right: 1px solid #ccc; }
        #navigation-area { flex: 1; padding: 20px; background: #f9f9f9; display: flex; flex-direction: column; max-width: 300px; }

        .q-header { background: #f0f4f8; padding: 15px; border-left: 5px solid var(--wii-blue); margin-bottom: 20px; }
        
        /* SLIKA NA TESTU */
        .exam-image-container {
            text-align: center; margin: 15px 0; border: 1px solid #ddd; padding: 10px; background: #fafafa;
        }
        .exam-image { max-width: 100%; max-height: 300px; height: auto; display: block; margin: 0 auto; }

        .option-row { padding: 10px; margin: 5px 0; border: 1px solid #eee; cursor: pointer; display: flex; align-items: center; }
        .option-row:hover { background: #f0f0f0; }

        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .nav-box {
            height: 40px; border: 1px solid #999; display: flex; flex-direction: column; 
            cursor: pointer; position: relative; background: white;
        }
        .nav-box.current { border: 2px solid #000; }
        .nav-box.answered .nav-status { background: var(--nav-answered); flex: 1; border-top: 1px solid #ccc; }
        .nav-box.flagged::after {
            content: ''; position: absolute; top: 0; right: 0; border-style: solid; 
            border-width: 0 10px 10px 0; border-color: transparent red transparent transparent;
        }
        .nav-num { font-size: 10px; padding: 2px; } .nav-status { flex: 1; }

        /* --- MANAGER --- */
        .manager-header { background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .manager-tabs { background: #eee; padding: 10px 20px; border-bottom: 1px solid #ccc; display: flex; gap: 10px; }
        .tab-btn { padding: 8px 15px; border: 1px solid #999; background: white; font-weight: bold; }
        .tab-btn.active { background: var(--wii-blue); color: white; border-color: var(--wii-dark); }
        .manager-content { padding: 20px; overflow-y: auto; flex: 1; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.9em; }
        th { background: #eee; }
        .pass { color: green; font-weight: bold; } .fail { color: red; font-weight: bold; }

        /* --- MODAL --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: white; width: 90%; max-width: 800px; max-height: 90%;
            display: flex; flex-direction: column; border: 2px solid #333; box-shadow: 0 0 20px #000;
        }
        .modal-header { background: #eee; padding: 15px; border-bottom: 1px solid #ccc; font-weight: bold; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid #ccc; text-align: right; background: #f9f9f9; }

        .form-label { display: block; font-weight: bold; margin-bottom: 5px; margin-top: 10px; }
        .opt-item { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .btn-green { background: var(--success); color: white; border: none; padding: 8px 15px; }
        .btn-red { background: var(--danger); color: white; border: none; padding: 5px 10px; }
        
        .preview-img { max-width: 200px; max-height: 150px; border: 1px solid #ccc; margin-top: 5px; display: block; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="view-login" class="center-screen">
        <div class="login-box">
            <h2>WII EXAM SYSTEM</h2>
            <p>Sinhronizacija z: <b>wiiShopDBv5</b></p>
            <p style="font-size:0.9em; color:#666;">Vnesi osebno 코ifro ali 000 za Manager</p>
            <input type="password" id="login-code" placeholder="말fra zaposlenega">
            <button onclick="handleLogin()" style="margin-top:10px; width:100%; padding:10px; background:#333; color:white;">PRIJAVA</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;"></p>
        </div>
    </div>

    <div id="view-preflight" class="center-screen hidden">
        <div class="login-box" style="width: 400px; text-align: left;">
            <h3>Pozdravljeni!</h3>
            <p><b>Ime in priimek:</b> <span id="pf-name"></span></p>
            <p><b>말fra:</b> <span id="pf-id"></span></p>
            <p><b>Poskus 코t.:</b> <span id="pf-attempt"></span></p>
            <hr>
            <p>Izpit vsebuje <b id="pf-qcount"></b> vpra코anj. 캛as: <b id="pf-time"></b> min.</p>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="startExam()" style="background: var(--wii-blue); color: white; padding: 10px 20px; border:none;">ZA캛NI REEVANJE</button>
                <button onclick="logout()" style="padding: 10px 20px;">PREKLI캛I</button>
            </div>
        </div>
    </div>

    <div id="view-exam" class="hidden" style="flex-direction: column; height: 100%;">
        <div id="exam-header">
            <span>WII PREIZKUS ZNANJA</span>
            <span id="timer-display" style="font-family: monospace; font-size: 1.2em;">00:00</span>
        </div>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div id="exam-body">
            <div id="question-area"></div>
            <div id="navigation-area">
                <h3>Navigacija</h3>
                <div id="nav-grid" class="nav-grid"></div>
                <div style="margin-top: auto;">
                    <button onclick="confirmFinish()" style="width:100%; background: #333; color: white; padding: 15px;">KON캛AJ REEVANJE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-result" class="hidden" style="overflow-y: auto; padding: 20px;">
        <div class="result-summary" style="background:#f9f9f9; padding:20px; border:1px solid #ccc;">
            <h2 id="res-title">Rezultat</h2>
            <p id="res-message" style="font-size: 1.2em; font-weight: bold;"></p>
            <div>To캜ke: <span id="res-points"></span> | Odstotek: <span id="res-percent"></span></div>
        </div>
        <h3>Pregled odgovorov</h3>
        <div id="review-list"></div>
        <br>
        <button onclick="logout()" style="width:100%; padding: 15px;">ZAKLJU캛I IN ODJAVA</button>
    </div>

    <div id="view-manager" class="hidden" style="flex-direction: column; height: 100%;">
        <div class="manager-header">
            <span>ADMINISTRACIJA (000)</span>
            <button onclick="logout()" style="font-size: 0.8em; padding: 5px 10px; color:black;">ODJAVA</button>
        </div>
        <div class="manager-tabs">
            <button class="tab-btn active" onclick="switchManagerTab('results')">Rezultati</button>
            <button class="tab-btn" onclick="switchManagerTab('questions')">Baza Vpra코anj</button>
            <button class="tab-btn" onclick="switchManagerTab('settings')">Nastavitve</button>
        </div>
        
        <div id="tab-results" class="manager-content">
            <h3>Zgodovina testov</h3>
            <table id="manager-table">
                <thead><tr><th>Datum</th><th>Zaposleni</th><th>To캜ke</th><th>%</th><th>Status</th><th>Akcija</th></tr></thead>
                <tbody id="manager-table-body"></tbody>
            </table>
        </div>

        <div id="tab-questions" class="manager-content hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Urejanje vpra코anj</h3>
                <button class="btn-green" onclick="openEditor(null)">+ Novo vpra코anje</button>
            </div>
            <table id="questions-table">
                <thead><tr><th>ID</th><th>Slika</th><th>Vpra코anje</th><th>Tip</th><th>Status</th><th>Akcije</th></tr></thead>
                <tbody id="questions-table-body"></tbody>
            </table>
        </div>

        <div id="tab-settings" class="manager-content hidden">
            <h3>Nastavitve</h3>
            <div style="border:1px solid #ccc; padding:20px; width:300px;">
                <label class="form-label">맚. vpra코anj na izpitu:</label>
                <input type="number" id="set-q-count" min="1">
                <p>캛as (avto): <b id="calc-time"></b> min</p>
                <button class="btn-green" onclick="saveSettings()" style="width:100%; margin-top:10px;">SHRANI</button>
                <span id="settings-msg" style="color:green; display:none;">Shranjeno!</span>
            </div>
        </div>
    </div>

    <div id="modal-editor" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-header">
                <span id="editor-title">Urejanje</span>
                <button onclick="closeModal('modal-editor')">X</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                
                <label class="form-label">Besedilo vpra코anja:</label>
                <input type="text" id="edit-text" placeholder="Vpi코i vpra코anje...">

                <div style="background:#f0f8ff; padding:10px; margin-top:10px; border:1px solid #bde;">
                    <label class="form-label" style="margin-top:0;">Slika (neobvezno):</label>
                    <input type="file" id="edit-img-file" accept="image/*" onchange="previewImage()">
                    <input type="hidden" id="edit-img-data"> <div id="img-preview-container" style="margin-top:5px;">
                        <img id="edit-img-preview" class="preview-img hidden">
                        <button id="btn-remove-img" class="btn-red hidden" style="margin-top:5px;" onclick="removeImage()">Odstrani sliko</button>
                    </div>
                    <small style="color:#666;">Nasvet: Uporabi manj코e slike (jpg/png) za hitrej코e delovanje.</small>
                </div>

                <div style="display:flex; gap: 20px; margin-top:10px;">
                    <div style="flex:1">
                        <label class="form-label">To캜ke:</label>
                        <input type="number" id="edit-points" value="1" step="0.5">
                    </div>
                    <div style="flex:1">
                        <label class="form-label">Tip:</label>
                        <select id="edit-type" onchange="togglePartialOption()">
                            <option value="single">En odgovor (Radio)</option>
                            <option value="multi">Ve캜 odgovorov (Checkbox)</option>
                        </select>
                    </div>
                </div>

                <div id="div-partial" class="hidden" style="margin-top:10px; background:#eef; padding:5px;">
                    <label><input type="checkbox" id="edit-partial"> <b>Dovoli delne to캜ke?</b></label>
                </div>

                <div style="margin-top:15px; border-top:1px solid #ccc; padding-top:10px;">
                    <label class="form-label">Odgovori (Ozna캜i pravilne):</label>
                    <div id="edit-options-list"></div>
                    <button onclick="addEditorOption()" style="margin-top:5px;">+ Dodaj odgovor</button>
                </div>

                <div style="margin-top:15px;">
                    <label class="form-label">Status:</label>
                    <select id="edit-active">
                        <option value="true">Aktivno</option>
                        <option value="false">Neaktivno</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveQuestion()" class="btn-green">SHRANI VPRAㅁNJE</button>
            </div>
        </div>
    </div>

    <div id="modal-review" class="modal-overlay hidden">
        <div class="modal-box" style="height: 95%;">
            <div class="modal-header">
                <span>PREGLED IZPITA (Korektura csz)</span>
                <button onclick="closeModal('modal-review')">X</button>
            </div>
            <div class="modal-body" id="review-content"></div>
        </div>
    </div>

</div>

<script>
    /* ================= SYSTEM CONFIG ================= */
    const DB_KEY_EMPLOYEES = 'wiiShopDBv5'; // External Sync
    const QUESTIONS_KEY = 'wiiQuestions_v3';
    const RESULTS_KEY = 'wiiExamResults_v3';
    const SETTINGS_KEY = 'wiiSettings_v3';

    // Seeding dummy data if wiiShopDBv5 doesn't exist (for testing)
    if (!localStorage.getItem(DB_KEY_EMPLOYEES)) {
        console.log("Creating dummy employee DB...");
        const dummyDB = {
            employees: [
                { id: "101", name: "Janez Novak", code: "101" },
                { id: "102", name: "Maja Kos", code: "102" }
            ]
        };
        localStorage.setItem(DB_KEY_EMPLOYEES, JSON.stringify(dummyDB));
    }

    // Default Questions
    const initialPool = [
        { id: 1, text: "Ali je blagajna na sliki prijavljena?", points: 2, type: 'single', active: true, options: ["DA", "NE"], correct: [1] },
        { id: 2, text: "Kaj moramo vpisati ob prijavi?", points: 4, type: 'multi', partialCredit: true, active: true, options: ["ID", "Znesek", "Datum", "Depozit"], correct: [0, 3] }
    ];

    let currentUser = null;
    let examData = { questions: [], answers: {}, flags: {}, timer: 0, interval: null, currentIndex: 0 };

    /* ================= DATA HELPERS ================= */
    function getEmployeesDB() { return JSON.parse(localStorage.getItem(DB_KEY_EMPLOYEES)) || { employees: [] }; }
    function getQuestions() { 
        const q = localStorage.getItem(QUESTIONS_KEY);
        return q ? JSON.parse(q) : initialPool;
    }
    function saveQuestions(data) { localStorage.setItem(QUESTIONS_KEY, JSON.stringify(data)); }
    function getResults() { return JSON.parse(localStorage.getItem(RESULTS_KEY)) || []; }
    function saveResult(res) { 
        const r = getResults(); r.push(res); localStorage.setItem(RESULTS_KEY, JSON.stringify(r)); 
    }
    function getSettings() { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { qCount: 10 }; }
    function saveSettingsDB(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

    /* ================= LOGIN (SYNC LOGIC) ================= */
    function handleLogin() {
        const code = document.getElementById('login-code').value.trim();
        const errorMsg = document.getElementById('login-error');
        errorMsg.style.display = 'none';

        // 1. MANAGER
        if (code === '000') {
            currentUser = { name: "MANAGER", role: "MANAGER", id: "000" };
            showView('manager');
            switchManagerTab('results');
            return;
        }

        // 2. EMPLOYEE SYNC
        const db = getEmployeesDB();
        const employee = db.employees.find(e => e.code === code || e.id === code);

        if (employee) {
            currentUser = employee;
            showView('preflight');
            preparePreflight();
        } else {
            errorMsg.innerText = "Napa캜na 코ifra ali uporabnik ne obstaja v wiiShopDBv5!";
            errorMsg.style.display = 'block';
        }
    }

    function preparePreflight() {
        document.getElementById('pf-name').innerText = currentUser.name;
        document.getElementById('pf-id').innerText = currentUser.id;
        const attempts = getResults().filter(r => r.userId == currentUser.id).length;
        document.getElementById('pf-attempt').innerText = attempts + 1;
        
        const sets = getSettings();
        document.getElementById('pf-qcount').innerText = sets.qCount;
        document.getElementById('pf-time').innerText = Math.ceil(sets.qCount * 1.5);
    }

    function logout() {
        clearInterval(examData.interval);
        currentUser = null;
        document.getElementById('login-code').value = "";
        showView('login');
    }

    function showView(name) {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
    }

    /* ================= EXAM LOGIC ================= */
    function startExam() {
        const sets = getSettings();
        const all = getQuestions().filter(q => q.active);
        
        // Randomize
        examData.questions = [...all].sort(() => Math.random() - 0.5).slice(0, sets.qCount);
        examData.answers = {};
        examData.flags = {};
        examData.timer = Math.ceil(examData.questions.length * 1.5 * 60);
        examData.currentIndex = 0;

        showView('exam');
        renderNavGrid();
        loadQuestion(0);
        
        examData.interval = setInterval(() => {
            examData.timer--;
            const m = Math.floor(examData.timer / 60);
            const s = examData.timer % 60;
            document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            if(examData.timer <= 0) finishExam();
        }, 1000);
    }

    function loadQuestion(idx) {
        examData.currentIndex = idx;
        const q = examData.questions[idx];
        const area = document.getElementById('question-area');
        
        // Image logic
        let imgHtml = '';
        if (q.imgData) {
            imgHtml = `<div class="exam-image-container"><img src="${q.imgData}" class="exam-image"></div>`;
        }

        let opts = '';
        q.options.forEach((o, i) => {
            const checked = (examData.answers[idx] || []).includes(i) ? 'checked' : '';
            const type = q.type === 'multi' ? 'checkbox' : 'radio';
            opts += `
                <label class="option-row">
                    <input type="${type}" name="q_opt" value="${i}" ${checked} onchange="handleAnswer(${idx}, ${i}, '${q.type}')">
                    <span>${o}</span>
                </label>`;
        });

        area.innerHTML = `
            <div class="q-header">
                <div style="display:flex; justify-content:space-between; font-size:0.9em;">
                    <span>Vpra코anje ${idx+1}/${examData.questions.length}</span>
                    <span>To캜k: ${q.points}</span>
                </div>
                <div style="font-size:1.3em; font-weight:bold; margin-top:10px;">${q.text}</div>
                <label style="cursor:pointer; margin-top:5px; display:block;">
                    <input type="checkbox" ${examData.flags[idx]?'checked':''} onchange="toggleFlag(${idx})"> Ozna캜i (Flag)
                </label>
            </div>
            ${imgHtml}
            <div>${opts}</div>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <button onclick="navStep(-1)" ${idx===0?'disabled':''}>&laquo; Nazaj</button>
                <button onclick="navStep(1)" ${idx===examData.questions.length-1?'disabled':''}>Naprej &raquo;</button>
            </div>
        `;
        renderNavGrid();
    }

    function handleAnswer(qIdx, optIdx, type) {
        if (!examData.answers[qIdx]) examData.answers[qIdx] = [];
        if (type === 'single') {
            examData.answers[qIdx] = [optIdx];
        } else {
            const arr = examData.answers[qIdx];
            if (arr.includes(optIdx)) examData.answers[qIdx] = arr.filter(x => x !== optIdx);
            else arr.push(optIdx);
        }
        // Progress bar
        const pct = (Object.keys(examData.answers).filter(k=>examData.answers[k].length>0).length / examData.questions.length) * 100;
        document.getElementById('progress-bar').style.width = pct + '%';
        renderNavGrid();
    }

    function navStep(d) { loadQuestion(examData.currentIndex + d); }
    function toggleFlag(i) { examData.flags[i] = !examData.flags[i]; renderNavGrid(); }
    
    function renderNavGrid() {
        const g = document.getElementById('nav-grid'); g.innerHTML = '';
        examData.questions.forEach((q, i) => {
            const d = document.createElement('div');
            d.className = `nav-box ${i===examData.currentIndex?'current':''} ${(examData.answers[i]&&examData.answers[i].length)?'answered':''} ${examData.flags[i]?'flagged':''}`;
            d.onclick = () => loadQuestion(i);
            d.innerHTML = `<div class="nav-num">${i+1}</div><div class="nav-status"></div>`;
            g.appendChild(d);
        });
    }

    function confirmFinish() { if(confirm("Zaklju캜im re코evanje?")) finishExam(); }

    function finishExam() {
        clearInterval(examData.interval);
        let earned = 0, total = 0;
        
        examData.questions.forEach((q, i) => {
            total += parseFloat(q.points);
            const userAns = examData.answers[i] || [];
            let pts = 0;
            
            if (q.type === 'single') {
                if (userAns.length === 1 && userAns[0] === q.correct[0]) pts = q.points;
            } else {
                if (q.partialCredit) {
                    const hasWrong = userAns.some(a => !q.correct.includes(a));
                    if (!hasWrong && userAns.length > 0) {
                        pts = (userAns.length / q.correct.length) * q.points;
                    }
                } else {
                    const u = userAns.sort().join(',');
                    const c = q.correct.sort().join(',');
                    if (u === c) pts = q.points;
                }
            }
            earned += pts;
            q.resDetails = { userAns, earned };
        });

        const percent = (earned / total) * 100;
        const passed = percent >= 88;
        
        const res = {
            id: Date.now(),
            userId: currentUser.id, userName: currentUser.name, date: new Date().toLocaleString(),
            score: earned.toFixed(2), max: total.toFixed(2), percent: percent.toFixed(2), passed,
            qSnap: examData.questions
        };
        saveResult(res);

        // Render User Result
        const title = document.getElementById('res-title');
        title.innerText = passed ? "OPRAVIL" : "NI OPRAVIL";
        title.style.color = passed ? "green" : "red";
        document.getElementById('res-points').innerText = `${res.score} / ${res.max}`;
        document.getElementById('res-percent').innerText = `${res.percent}%`;
        
        const list = document.getElementById('review-list'); list.innerHTML = '';
        res.qSnap.forEach((q, i) => {
            list.innerHTML += `<div style="border-bottom:1px solid #ccc; padding:10px;"><b>${i+1}. ${q.text}</b> <span style="float:right;">${q.resDetails.earned} / ${q.points} t</span></div>`;
        });
        showView('result');
    }

    /* ================= MANAGER ================= */
    function switchManagerTab(t) {
        document.querySelectorAll('.manager-content').forEach(e => e.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.remove('hidden');
        document.querySelector(`button[onclick="switchManagerTab('${t}')"]`).classList.add('active');
        if(t==='results') renderResults();
        if(t==='questions') renderQuestions();
        if(t==='settings') {
            const s = getSettings();
            document.getElementById('set-q-count').value = s.qCount;
            document.getElementById('set-q-count').oninput = () => document.getElementById('calc-time').innerText = Math.ceil(document.getElementById('set-q-count').value * 1.5);
            document.getElementById('set-q-count').oninput();
        }
    }

    function renderResults() {
        const tb = document.getElementById('manager-table-body'); tb.innerHTML = '';
        getResults().reverse().forEach(r => {
            tb.innerHTML += `<tr>
                <td>${r.date}</td><td>${r.userName} (${r.userId})</td>
                <td>${r.score}/${r.max}</td><td>${r.percent}%</td>
                <td class="${r.passed?'pass':'fail'}">${r.passed?'DA':'NE'}</td>
                <td><button onclick="openReview(${r.id})">Pregled</button></td>
            </tr>`;
        });
    }

    function renderQuestions() {
        const tb = document.getElementById('questions-table-body'); tb.innerHTML = '';
        getQuestions().forEach(q => {
            tb.innerHTML += `<tr style="opacity:${q.active?1:0.5}">
                <td>${q.id}</td>
                <td>${q.imgData ? '游닝' : ''}</td>
                <td>${q.text.substring(0,30)}...</td>
                <td>${q.type}</td><td>${q.active?'Aktiven':'X'}</td>
                <td><button onclick="openEditor(${q.id})">Uredi</button> <button class="btn-red" onclick="delQ(${q.id})">Bri코i</button></td>
            </tr>`;
        });
    }

    function delQ(id) {
        if(confirm("Bri코em?")) { saveQuestions(getQuestions().filter(q=>q.id!==id)); renderQuestions(); }
    }

    function saveSettings() {
        saveSettingsDB({ qCount: parseInt(document.getElementById('set-q-count').value) });
        document.getElementById('settings-msg').style.display = 'inline';
    }

    /* ================= EDITOR & IMAGES ================= */
    let editId = null;

    function openEditor(id) {
        editId = id;
        document.getElementById('modal-editor').classList.remove('hidden');
        const list = document.getElementById('edit-options-list'); list.innerHTML = '';
        
        // Reset Inputs
        document.getElementById('edit-text').value = '';
        document.getElementById('edit-points').value = 1;
        document.getElementById('edit-type').value = 'single';
        document.getElementById('edit-active').value = 'true';
        document.getElementById('edit-partial').checked = false;
        
        // Image Reset
        document.getElementById('edit-img-file').value = '';
        document.getElementById('edit-img-data').value = '';
        document.getElementById('edit-img-preview').classList.add('hidden');
        document.getElementById('btn-remove-img').classList.add('hidden');

        if (id) {
            const q = getQuestions().find(x => x.id === id);
            document.getElementById('edit-text').value = q.text;
            document.getElementById('edit-points').value = q.points;
            document.getElementById('edit-type').value = q.type;
            document.getElementById('edit-active').value = q.active.toString();
            document.getElementById('edit-partial').checked = q.partialCredit || false;
            
            // Image Load
            if (q.imgData) {
                document.getElementById('edit-img-data').value = q.imgData;
                document.getElementById('edit-img-preview').src = q.imgData;
                document.getElementById('edit-img-preview').classList.remove('hidden');
                document.getElementById('btn-remove-img').classList.remove('hidden');
            }

            q.options.forEach((o, i) => addEditorOption(o, q.correct.includes(i)));
        } else {
            addEditorOption(); addEditorOption();
        }
        togglePartialOption();
    }

    // IMAGE HANDLERS
    function previewImage() {
        const file = document.getElementById('edit-img-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('edit-img-preview').src = e.target.result;
                document.getElementById('edit-img-preview').classList.remove('hidden');
                document.getElementById('btn-remove-img').classList.remove('hidden');
                document.getElementById('edit-img-data').value = e.target.result; // Temp store
            }
            reader.readAsDataURL(file);
        }
    }

    function removeImage() {
        document.getElementById('edit-img-file').value = '';
        document.getElementById('edit-img-data').value = '';
        document.getElementById('edit-img-preview').classList.add('hidden');
        document.getElementById('btn-remove-img').classList.add('hidden');
    }

    function addEditorOption(txt='', isC=false) {
        const div = document.createElement('div');
        div.className = 'opt-item';
        div.innerHTML = `<input type="checkbox" class="opt-correct" ${isC?'checked':''}> <input type="text" class="opt-text" value="${txt}"> <button class="btn-red" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('edit-options-list').appendChild(div);
    }

    function togglePartialOption() {
        const t = document.getElementById('edit-type').value;
        document.getElementById('div-partial').className = t === 'multi' ? '' : 'hidden';
    }

    function saveQuestion() {
        const txt = document.getElementById('edit-text').value;
        if(!txt) return alert("Vnesi vpra코anje");

        const opts = [], correct = [];
        document.querySelectorAll('#edit-options-list .opt-item').forEach((el, i) => {
            const val = el.querySelector('.opt-text').value;
            if(val) { opts.push(val); if(el.querySelector('.opt-correct').checked) correct.push(i); }
        });

        if(opts.length < 2) return alert("Vsaj 2 odgovora!");
        if(correct.length === 0) return alert("Vsaj 1 pravilen!");

        const newQ = {
            id: editId || Date.now(),
            text: txt,
            points: parseFloat(document.getElementById('edit-points').value),
            type: document.getElementById('edit-type').value,
            partialCredit: document.getElementById('edit-partial').checked,
            active: document.getElementById('edit-active').value === 'true',
            imgData: document.getElementById('edit-img-data').value, // Base64 string
            options: opts, correct: correct
        };

        const list = getQuestions();
        if(editId) { const idx = list.findIndex(x=>x.id===editId); list[idx] = newQ; } 
        else { list.push(newQ); }
        
        saveQuestions(list);
        closeModal('modal-editor');
        renderQuestions();
    }

    /* ================= REVIEW (SANITIZED) ================= */
    function sanitize(str) {
        if(!str) return "";
        return str.toString()
            .replace(/캜/g, 'c').replace(/캛/g, 'C')
            .replace(/코/g, 's').replace(//g, 'S')
            .replace(//g, 'z').replace(/콯/g, 'Z');
    }

    function openReview(id) {
        const r = getResults().find(x => x.id === id);
        if(!r) return;
        
        const c = document.getElementById('review-content');
        c.innerHTML = `
            <div style="border-bottom:2px solid #000; margin-bottom:10px;">
                <h3>KANDIDAT: ${sanitize(r.userName)} (${r.userId})</h3>
                <p>Tocke: ${r.score}/${r.max} (${r.percent}%)</p>
            </div>
        `;

        r.qSnap.forEach((q, i) => {
            const uPts = q.resDetails.earned;
            let oHtml = '';
            
            q.options.forEach((o, oid) => {
                const sOpt = sanitize(o);
                const isUser = q.resDetails.userAns.includes(oid);
                const isCorr = q.correct.includes(oid);
                let sty = ''; let mk = '[ ]';
                
                if(isUser) mk = '[X]';
                if(isCorr) sty = 'color:green; font-weight:bold;';
                if(isUser && !isCorr) sty = 'color:red; text-decoration:line-through;';
                
                oHtml += `<div style="${sty}">${mk} ${sOpt}</div>`;
            });

            c.innerHTML += `
                <div style="background:${uPts>0?'#eaffea':'#ffeaea'}; padding:10px; margin-bottom:10px; border:1px solid #ccc;">
                    <b>${i+1}. ${sanitize(q.text)}</b>
                    ${q.imgData ? `<br><img src="${q.imgData}" style="max-height:100px; margin:5px;">` : ''}
                    <div style="margin-left:15px; font-size:0.9em;">${oHtml}</div>
                    <div style="text-align:right;">${uPts}/${q.points} t</div>
                </div>`;
        });
        document.getElementById('modal-review').classList.remove('hidden');
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
</script>
</body>
</html>
