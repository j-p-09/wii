<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WII PREIZKUS ZNANJA - SISTEM V2</title>
    <style>
        :root {
            --bg-grey: #f0f0f0;
            --header-grey: #e0e0e0;
            --border-color: #ccc;
            --wii-blue: #0099ff;
            --wii-dark: #333;
            --highlight: #ffffcc;
            --nav-answered: #cceeff;
            --nav-current: #000;
            --danger: #ff4444;
            --success: #00C851;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background-color: #888;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            background: #fff;
            display: flex;
            flex-direction: column;
            border: 2px solid #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* --- SKUPNO --- */
        .hidden { display: none !important; }
        button { cursor: pointer; }
        input[type="text"], input[type="number"], input[type="password"] {
            padding: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;
        }
        
        /* --- LOGIN --- */
        .center-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; text-align: center; background: var(--bg-grey);
        }
        .login-box {
            background: white; padding: 40px; border: 1px solid #999;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1); width: 300px;
        }

        /* --- MANAGER HEADER & TABS --- */
        .manager-header {
            background: #333; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .manager-tabs {
            background: #eee; padding: 10px 20px; border-bottom: 1px solid #ccc;
            display: flex; gap: 10px;
        }
        .tab-btn {
            padding: 8px 15px; border: 1px solid #999; background: white; font-weight: bold;
        }
        .tab-btn.active { background: var(--wii-blue); color: white; border-color: var(--wii-dark); }
        .manager-content { padding: 20px; overflow-y: auto; flex: 1; }

        /* --- EXAM LAYOUT --- */
        #exam-header {
            height: 50px; background: var(--header-grey); border-bottom: 1px solid #999;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-weight: bold;
        }
        #progress-container { width: 100%; height: 8px; background-color: #eee; border-bottom: 1px solid #ccc; }
        #progress-bar { height: 100%; width: 0%; background-color: var(--wii-blue); transition: width 0.3s ease; }
        
        #exam-body { display: flex; flex: 1; overflow: hidden; }
        #question-area { flex: 3; padding: 30px; overflow-y: auto; border-right: 1px solid #ccc; background: #fff; }
        #navigation-area { flex: 1; padding: 20px; background: #f9f9f9; display: flex; flex-direction: column; max-width: 300px; }

        .q-header { background: #f0f4f8; padding: 15px; border-left: 5px solid var(--wii-blue); margin-bottom: 20px; }
        .img-placeholder {
            background: #ddd; border: 2px dashed #999; padding: 20px; text-align: center; margin: 15px 0; font-style: italic;
        }
        .option-row {
            padding: 10px; margin: 5px 0; border: 1px solid #eee; cursor: pointer; display: flex; align-items: center;
        }
        .option-row:hover { background: #f0f0f0; }

        /* --- NAV GRID --- */
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .nav-box {
            height: 40px; border: 1px solid #999; display: flex; flex-direction: column; 
            cursor: pointer; position: relative; background: white;
        }
        .nav-box.current { border: 2px solid #000; }
        .nav-box.answered .nav-status { background-color: var(--nav-answered); flex: 1; border-top: 1px solid #ccc; }
        .nav-box.flagged::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 0; height: 0; border-style: solid; border-width: 0 10px 10px 0; border-color: transparent red transparent transparent;
        }
        .nav-num { font-size: 10px; padding: 2px; }
        .nav-status { flex: 1; }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.9em; }
        th { background: #eee; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        
        /* --- MODALS --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: white; width: 90%; max-width: 800px; max-height: 90%;
            display: flex; flex-direction: column; border: 2px solid #333; box-shadow: 0 0 20px #000;
        }
        .modal-header {
            background: #eee; padding: 15px; border-bottom: 1px solid #ccc; font-weight: bold;
            display: flex; justify-content: space-between;
        }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid #ccc; text-align: right; background: #f9f9f9; }

        /* --- FORM ELEMENTS IN EDITOR --- */
        .form-group { margin-bottom: 15px; border: 1px solid #eee; padding: 10px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; }
        .opt-item { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .btn-small { padding: 5px 10px; font-size: 0.8em; }
        .btn-green { background: var(--success); color: white; border: none; }
        .btn-red { background: var(--danger); color: white; border: none; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="view-login" class="center-screen">
        <div class="login-box">
            <h2>WII EXAM SYSTEM</h2>
            <p>Vnesi osebno šifro</p>
            <input type="password" id="login-code" placeholder="npr. 000 (Manager)">
            <button onclick="handleLogin()" style="margin-top:10px; width:100%; padding:10px;">PRIJAVA</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">Napačna šifra!</p>
        </div>
    </div>

    <div id="view-preflight" class="center-screen hidden">
        <div class="login-box" style="width: 400px; text-align: left;">
            <h3>Pozdravljeni!</h3>
            <p><b>Ime in priimek:</b> <span id="pf-name"></span></p>
            <p><b>Šifra:</b> <span id="pf-id"></span></p>
            <p><b>Poskus št.:</b> <span id="pf-attempt"></span></p>
            <hr>
            <p>Izpit vsebuje <b id="pf-qcount">10</b> vprašanj. Časovna omejitev: <b id="pf-time">15</b> min.</p>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="startExam()" style="background: var(--wii-blue); color: white; padding: 10px 20px;">ZAČNI REŠEVANJE</button>
                <button onclick="logout()" style="padding: 10px 20px;">PREKLIČI</button>
            </div>
        </div>
    </div>

    <div id="view-exam" class="hidden" style="flex-direction: column; height: 100%;">
        <div id="exam-header">
            <span>WII PREIZKUS ZNANJA</span>
            <span id="timer-display" style="font-family: monospace; font-size: 1.2em;">00:00</span>
        </div>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div id="exam-body">
            <div id="question-area"></div>
            <div id="navigation-area">
                <h3>Navigacija</h3>
                <div id="nav-grid" class="nav-grid"></div>
                <div style="margin-top: auto;">
                    <button onclick="confirmFinish()" style="width:100%; background: #333; color: white; padding: 15px;">KONČAJ REŠEVANJE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-result" class="hidden" style="overflow-y: auto; padding: 20px;">
        <div class="result-summary" style="background:#f9f9f9; padding:20px; border:1px solid #ccc;">
            <h2 id="res-title">Rezultat</h2>
            <p id="res-message" style="font-size: 1.2em; font-weight: bold;"></p>
            <div style="margin-top: 10px;">
                Točke: <span id="res-points"></span> | Odstotek: <span id="res-percent"></span>
            </div>
        </div>
        <h3>Pregled odgovorov</h3>
        <div id="review-list"></div>
        <br>
        <button onclick="logout()" style="width:100%; padding: 15px; background:var(--header-grey);">ZAKLJUČI IN ODJAVA</button>
    </div>

    <div id="view-manager" class="hidden" style="flex-direction: column; height: 100%;">
        <div class="manager-header">
            <span>ADMINISTRACIJA (000)</span>
            <button onclick="logout()" style="font-size: 0.8em; padding: 5px 10px;">ODJAVA</button>
        </div>
        <div class="manager-tabs">
            <button class="tab-btn active" onclick="switchManagerTab('results')">Rezultati</button>
            <button class="tab-btn" onclick="switchManagerTab('questions')">Urejanje Vprašanj</button>
            <button class="tab-btn" onclick="switchManagerTab('settings')">Nastavitve</button>
        </div>
        
        <div id="tab-results" class="manager-content">
            <h3>Zgodovina testov</h3>
            <table id="manager-table">
                <thead>
                    <tr>
                        <th>Datum</th><th>Zaposleni</th><th>Točke</th><th>%</th><th>Status</th><th>Akcija</th>
                    </tr>
                </thead>
                <tbody id="manager-table-body"></tbody>
            </table>
        </div>

        <div id="tab-questions" class="manager-content hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>Baza vprašanj</h3>
                <button class="btn-green" onclick="openEditor(null)" style="padding:10px;">+ Dodaj novo vprašanje</button>
            </div>
            <table id="questions-table">
                <thead>
                    <tr>
                        <th>ID</th><th>Vprašanje (skrajšano)</th><th>Tip</th><th>Status</th><th>Akcije</th>
                    </tr>
                </thead>
                <tbody id="questions-table-body"></tbody>
            </table>
        </div>

        <div id="tab-settings" class="manager-content hidden">
            <h3>Nastavitve izpita</h3>
            <div class="form-group" style="max-width: 400px;">
                <label class="form-label">Število vprašanj na izpitni poli:</label>
                <input type="number" id="set-q-count" value="10" min="1">
                <small style="color:#666;">Če je v bazi manj aktivnih vprašanj, bodo uporabljena vsa.</small>
            </div>
            <div class="form-group" style="max-width: 400px;">
                <label class="form-label">Čas se preračuna avtomatsko:</label>
                <p>1.5 minute na vprašanje.</p>
                <p>Trenutno nastavljeno: <b><span id="calc-time">15</span> minut</b></p>
            </div>
            <button class="btn-green" onclick="saveSettings()" style="padding:10px 20px;">SHRANI NASTAVITVE</button>
            <span id="settings-msg" style="color:green; margin-left:10px; display:none;">Shranjeno!</span>
        </div>
    </div>

    <div id="modal-editor" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-header">
                <span id="editor-title">Urejanje vprašanja</span>
                <button onclick="closeModal('modal-editor')">X</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                
                <label class="form-label">Besedilo vprašanja:</label>
                <input type="text" id="edit-text" placeholder="Vpiši vprašanje...">

                <div style="display:flex; gap: 20px; margin-top:10px;">
                    <div style="flex:1">
                        <label class="form-label">Točke:</label>
                        <input type="number" id="edit-points" value="1" step="0.5">
                    </div>
                    <div style="flex:1">
                        <label class="form-label">Tip odgovora:</label>
                        <select id="edit-type" onchange="togglePartialOption()" style="padding:8px; width:100%;">
                            <option value="single">En pravilen odgovor (Radio)</option>
                            <option value="multi">Več pravilnih odgovorov (Checkbox)</option>
                        </select>
                    </div>
                </div>

                <div id="div-partial" class="form-group hidden" style="margin-top:10px; background:#eef;">
                    <label style="cursor:pointer; display:flex; align-items:center;">
                        <input type="checkbox" id="edit-partial">
                        <span style="margin-left:5px;"><b>Dovoli delne točke?</b> (Če manager odobri)</span>
                    </label>
                    <small>Če obkljukano: kandidat dobi % točk glede na pravilnost. Če napačno izbere - 0 točk.</small>
                </div>

                <label class="form-label" style="margin-top:10px;">Opis slike / URL (neobvezno):</label>
                <input type="text" id="edit-img" placeholder="Opis slike ali URL...">

                <div style="margin-top:15px; border-top:1px solid #ccc; padding-top:10px;">
                    <label class="form-label">Odgovori:</label>
                    <div id="edit-options-list"></div>
                    <button onclick="addEditorOption()" style="margin-top:5px; font-size:0.9em;">+ Dodaj odgovor</button>
                </div>

                <div style="margin-top:15px;">
                    <label class="form-label">Status:</label>
                    <select id="edit-active" style="padding:5px;">
                        <option value="true">Omogočeno (Aktivno)</option>
                        <option value="false">Onemogočeno (Neaktivno)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveQuestion()" class="btn-green" style="padding:10px 20px;">SHRANI</button>
                <button onclick="closeModal('modal-editor')" style="padding:10px 20px;">PREKLIČI</button>
            </div>
        </div>
    </div>

    <div id="modal-review" class="modal-overlay hidden">
        <div class="modal-box" style="height: 95%;">
            <div class="modal-header">
                <span>PREGLED IZPITA (Korektura - brez šumnikov)</span>
                <button onclick="closeModal('modal-review')">X</button>
            </div>
            <div class="modal-body" id="review-content">
                </div>
            <div class="modal-footer">
                <button onclick="closeModal('modal-review')">ZAPRI</button>
            </div>
        </div>
    </div>

</div>

<script>
    /* ================= BAZA & STATE ================= */
    const DB_KEY = 'wiiShopDBv2';
    const EXAM_RESULTS_KEY = 'wiiExamResults_v2';
    const QUESTIONS_KEY = 'wiiQuestions_v2';
    const SETTINGS_KEY = 'wiiSettings_v2';

    // Začetni nabor vprašanj (če je baza prazna)
    const initialPool = [
        { id: 1, text: "Ali je blagajna na sliki prijavljena?", points: 2.0, type: 'single', partialCredit: false, imgDesc: "Zaslon prikazuje '0.00 WII', 'SKUPAJ', spodaj gumb 'LOGIN' / 'PRIJAVA'.", options: ["DA", "NE"], correct: [1], active: true },
        { id: 2, text: "Kateri gumb na sliki moramo izbrati za prijavo blagajne?", points: 2.0, type: 'single', partialCredit: false, imgDesc: "Zaslon z gumbi: LOGIN, VMESNO, SKYM, DOLOČI OPRAVILA, DOD., LOGOUT.", options: ["LOGIN", "VMESNO", "SKYM", "DOLOČI OPRAVILA", "LOGOUT"], correct: [0], active: true },
        { id: 3, text: "Kaj vse moramo vpisati ob prijavi blagajne:", points: 4.0, type: 'multi', partialCredit: true, imgDesc: "Ni slike.", options: ["ID ZAPOSLENEGA", "KONČNI DEPOZIT", "STAROST", "ZAČETNI DEPOZIT", "IME IN PRIIMEK BLAGAJNIKA"], correct: [0, 3], active: true },
        { id: 4, text: "Kaj naredi gumb VMESNO?", points: 3.0, type: 'single', partialCredit: false, imgDesc: "Gumb 'VMESNO'.", options: ["Pokaže zadnjo stranko", "Pokaže začetno stanje", "Pokaže trenutno stanje v blagajni"], correct: [2], active: true },
        { id: 5, text: "Ali lahko z manager kartico odpremo dodaten meni?", points: 5.0, type: 'single', partialCredit: false, imgDesc: "Vprašanje o varnosti.", options: ["DA, vse funkcije", "NE, samo osnovne"], correct: [1], active: true },
        { id: 6, text: "Ali je zaslon za stranke na sliki prižgan?", points: 2.0, type: 'single', partialCredit: false, imgDesc: "Zaslon prikazuje sivo ozadje in napis 'WII DELIVERY LOGIN'.", options: ["DA", "NE"], correct: [0], active: true },
        { id: 7, text: "Kako prižgemo zaslon za stranke, če je že odprt na drugem zaslonu?", points: 2.0, type: 'single', partialCredit: false, imgDesc: "Kontekst prijave.", options: ["Prijavimo blagajno", "Ugasnemo vse skupaj"], correct: [0], active: true },
        { id: 8, text: "Kaj moramo vnesti v belo polje na sliki?", points: 3.0, type: 'single', partialCredit: false, imgDesc: "Ekran 'WII DELIVERY LOGIN' z belim vnosnim poljem.", options: ["WII DELIVERY LOGIN", "Vnest ID zaposlenega", "Skeniramo svojo kartico", "Napišemo svojo strost", "PRIJAVA"], correct: [1], active: true },
        { id: 9, text: "Ali je stranka na sliki že oddala naročilo?", points: 3.0, type: 'single', partialCredit: false, imgDesc: "Chat okno. Stranka: 'Dober dan'.", options: ["DA", "NE"], correct: [1], active: true },
        { id: 10, text: "Katere podatke vpišemo v ZAKLJUČEK NAROČILA?", points: 7.0, type: 'multi', partialCredit: true, imgDesc: "Okno 'ZAKLJUČEK NAROČILA'.", options: ["Številko računa", "Ime stranke", "Vsebino naročila", "Znesek računa", "Bančno kartico"], correct: [0, 3, 4], active: true }
    ];

    let currentUser = null;
    let examData = {
        questions: [], answers: {}, flags: {},
        startTime: null, endTime: null,
        timer: 0, interval: null, currentIndex: 0
    };

    // --- INIT DB ---
    function getQuestions() {
        const stored = localStorage.getItem(QUESTIONS_KEY);
        if(!stored) {
            localStorage.setItem(QUESTIONS_KEY, JSON.stringify(initialPool));
            return initialPool;
        }
        return JSON.parse(stored);
    }
    function saveQuestionsDB(data) { localStorage.setItem(QUESTIONS_KEY, JSON.stringify(data)); }

    function getResults() { return JSON.parse(localStorage.getItem(EXAM_RESULTS_KEY)) || []; }
    function saveResult(res) {
        const r = getResults(); r.push(res);
        localStorage.setItem(EXAM_RESULTS_KEY, JSON.stringify(r));
    }

    function getSettings() {
        const def = { qCount: 10 };
        return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || def;
    }
    function saveSettingsDB(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

    /* ================= LOGIN & FLOW ================= */
    function handleLogin() {
        const code = document.getElementById('login-code').value.trim();
        
        // MANAGER
        if(code === '000') {
            currentUser = { name: "MANAGER", role: "MANAGER", id: "000" };
            showView('manager');
            switchManagerTab('results');
            return;
        }

        // UPORABNIK (Demo)
        if(code.length > 0) {
            currentUser = { name: "ZAPOSLENI " + code, id: code, role: "USER" };
            showView('preflight');
            preparePreflight();
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    }

    function preparePreflight() {
        document.getElementById('pf-name').innerText = currentUser.name;
        document.getElementById('pf-id').innerText = currentUser.id;
        const h = getResults().filter(r => r.userId === currentUser.id);
        document.getElementById('pf-attempt').innerText = h.length + 1;
        
        const sets = getSettings();
        document.getElementById('pf-qcount').innerText = sets.qCount;
        document.getElementById('pf-time').innerText = Math.ceil(sets.qCount * 1.5);
    }

    function logout() {
        clearInterval(examData.interval);
        currentUser = null;
        document.getElementById('login-code').value = "";
        document.getElementById('login-error').style.display = 'none';
        showView('login');
    }

    function showView(name) {
        ['login', 'preflight', 'manager', 'exam', 'result'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
    }

    /* ================= EXAM LOGIC ================= */
    function startExam() {
        const sets = getSettings();
        const allQ = getQuestions().filter(q => q.active); // Samo aktivna
        
        // Shuffle and slice
        const shuffled = [...allQ].sort(() => Math.random() - 0.5);
        examData.questions = shuffled.slice(0, sets.qCount);
        
        examData.answers = {};
        examData.flags = {};
        examData.startTime = new Date();
        examData.currentIndex = 0;

        // Čas: 1.5 min na vprašanje
        examData.timer = Math.ceil(examData.questions.length * 1.5 * 60);

        showView('exam');
        updateProgressBar();
        renderNavGrid();
        loadQuestion(0);
        updateTimerDisplay();

        examData.interval = setInterval(() => {
            examData.timer--;
            updateTimerDisplay();
            if(examData.timer <= 0) finishExam(true);
        }, 1000);
    }

    function updateProgressBar() {
        const ans = Object.keys(examData.answers).filter(k => examData.answers[k].length > 0).length;
        const pct = (ans / examData.questions.length) * 100;
        document.getElementById('progress-bar').style.width = pct + "%";
    }

    function updateTimerDisplay() {
        const m = Math.floor(examData.timer / 60);
        const s = examData.timer % 60;
        const el = document.getElementById('timer-display');
        el.innerText = `${m}:${s.toString().padStart(2, '0')}`;
        el.style.color = examData.timer < 60 ? "red" : "black";
    }

    function loadQuestion(idx) {
        examData.currentIndex = idx;
        const q = examData.questions[idx];
        const area = document.getElementById('question-area');
        
        let opts = "";
        q.options.forEach((o, i) => {
            const chk = (examData.answers[idx] || []).includes(i) ? "checked" : "";
            const type = q.type === 'multi' ? 'checkbox' : 'radio';
            opts += `
                <label class="option-row">
                    <input type="${type}" name="q_opt" value="${i}" ${chk} onchange="handleAnswer(${idx}, ${i}, '${q.type}')">
                    <span>${o}</span>
                </label>`;
        });

        area.innerHTML = `
            <div class="q-header">
                <div class="q-meta"><span>Vpr. ${idx+1}/${examData.questions.length}</span><span>Točk: ${q.points}</span></div>
                <div style="font-size:1.2em; font-weight:bold;">${q.text}</div>
                <label style="cursor:pointer; margin-top:5px; display:block;"><input type="checkbox" ${examData.flags[idx]?'checked':''} onchange="toggleFlag(${idx})"> Označi za pregled</label>
            </div>
            ${q.imgDesc ? `<div class="img-placeholder">SLIKA: ${q.imgDesc}</div>` : ''}
            <div>${opts}</div>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <button onclick="navStep(-1)" ${idx===0?'disabled':''}>&laquo; Nazaj</button>
                <button onclick="navStep(1)" ${idx===examData.questions.length-1?'disabled':''}>Naprej &raquo;</button>
            </div>
        `;
        renderNavGrid();
    }

    function handleAnswer(qIdx, optIdx, type) {
        if(!examData.answers[qIdx]) examData.answers[qIdx] = [];
        if(type === 'single') {
            examData.answers[qIdx] = [optIdx];
        } else {
            const arr = examData.answers[qIdx];
            if(arr.includes(optIdx)) examData.answers[qIdx] = arr.filter(x => x!==optIdx);
            else arr.push(optIdx);
        }
        updateProgressBar();
        renderNavGrid();
    }

    function toggleFlag(i) { examData.flags[i] = !examData.flags[i]; renderNavGrid(); }
    function navStep(d) { loadQuestion(examData.currentIndex + d); }
    
    function renderNavGrid() {
        const g = document.getElementById('nav-grid'); g.innerHTML = "";
        examData.questions.forEach((q, i) => {
            const d = document.createElement('div');
            d.className = `nav-box ${i===examData.currentIndex?'current':''} ${(examData.answers[i]&&examData.answers[i].length)?'answered':''} ${examData.flags[i]?'flagged':''}`;
            d.onclick = () => loadQuestion(i);
            d.innerHTML = `<div class="nav-num">${i+1}</div><div class="nav-status"></div>`;
            g.appendChild(d);
        });
    }

    function confirmFinish() {
        if(confirm("Želite zaključiti reševanje?")) finishExam(false);
    }

    function finishExam(forced) {
        clearInterval(examData.interval);
        examData.endTime = new Date();
        let earned = 0, total = 0;

        // SCORING LOGIC
        examData.questions.forEach((q, idx) => {
            total += parseFloat(q.points);
            const userAns = examData.answers[idx] || [];
            
            let qEarned = 0;
            
            if(q.type === 'single') {
                // Exact match
                if(userAns.length === 1 && userAns[0] === q.correct[0]) qEarned = q.points;
            } else {
                // Multi
                if(q.partialCredit) {
                    // PARTIAL LOGIC
                    // 1. Check if any WRONG answer is selected. If yes -> 0 points (penalty logic to prevent selecting all)
                    const hasWrong = userAns.some(a => !q.correct.includes(a));
                    if(!hasWrong && userAns.length > 0) {
                        // Calculate percentage of correct answers found
                        const correctFound = userAns.length;
                        const totalCorrect = q.correct.length;
                        qEarned = (correctFound / totalCorrect) * q.points;
                    }
                } else {
                    // STRICT LOGIC (All or nothing)
                    const uStr = userAns.sort().join(',');
                    const cStr = q.correct.sort().join(',');
                    if(uStr === cStr) qEarned = q.points;
                }
            }
            
            earned += qEarned;
            // Save details for review
            q.resultDetails = {
                userAns: userAns,
                earned: qEarned
            };
        });

        const percent = (earned / total) * 100;
        const passed = percent >= 88; // Prag 88%

        const resObj = {
            id: Date.now(), // Unique ID
            userId: currentUser.id,
            userName: currentUser.name,
            date: new Date().toISOString(),
            score: earned.toFixed(2),
            max: total.toFixed(2),
            percent: percent.toFixed(2),
            passed: passed,
            questionsSnapshot: examData.questions // Shranimo celotna vprašanja, ker se lahko baza spremeni
        };

        saveResult(resObj);
        renderUserResult(resObj);
        showView('result');
    }

    function renderUserResult(res) {
        const title = document.getElementById('res-title');
        title.innerText = res.passed ? "USPEŠNO OPRAVLJEN" : "NEUSPEŠNO";
        title.style.color = res.passed ? "green" : "red";
        document.getElementById('res-points').innerText = `${res.score} / ${res.max}`;
        document.getElementById('res-percent').innerText = `${res.percent}%`;
        
        // Simple list for user
        const list = document.getElementById('review-list');
        list.innerHTML = "";
        res.questionsSnapshot.forEach((q, i) => {
            const d = document.createElement('div');
            d.style.borderBottom = "1px solid #eee";
            d.style.padding = "10px";
            d.innerHTML = `<b>${i+1}. ${q.text}</b> <span style="float:right">${q.resultDetails.earned}/${q.points} t</span>`;
            list.appendChild(d);
        });
    }

    /* ================= MANAGER LOGIC ================= */
    function switchManagerTab(tab) {
        document.querySelectorAll('.manager-content').forEach(e => e.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        document.querySelector(`button[onclick="switchManagerTab('${tab}')"]`).classList.add('active');

        if(tab === 'results') renderResultsTable();
        if(tab === 'questions') renderQuestionsTable();
        if(tab === 'settings') loadSettingsForm();
    }

    // 1. RESULTS TAB
    function renderResultsTable() {
        const data = getResults().reverse();
        const tb = document.getElementById('manager-table-body');
        tb.innerHTML = "";
        data.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date(r.date).toLocaleString()}</td>
                <td>${r.userName}</td>
                <td>${r.score}/${r.max}</td>
                <td>${r.percent}%</td>
                <td class="${r.passed?'pass':'fail'}">${r.passed?'OPRAVIL':'PADEL'}</td>
                <td><button onclick="openReview(${r.id})">PREGLED</button></td>
            `;
            tb.appendChild(tr);
        });
    }

    // 2. QUESTIONS TAB
    function renderQuestionsTable() {
        const qs = getQuestions();
        const tb = document.getElementById('questions-table-body');
        tb.innerHTML = "";
        qs.forEach(q => {
            const tr = document.createElement('tr');
            tr.style.opacity = q.active ? 1 : 0.5;
            tr.innerHTML = `
                <td>${q.id}</td>
                <td>${q.text.substring(0, 40)}...</td>
                <td>${q.type === 'multi' ? 'Več (Multi)' : 'En (Single)'}</td>
                <td>${q.active ? 'Aktivno' : 'Onemogočeno'}</td>
                <td>
                    <button class="btn-small" onclick="openEditor(${q.id})">Uredi</button>
                    <button class="btn-small btn-red" onclick="deleteQuestion(${q.id})">Briši</button>
                </td>
            `;
            tb.appendChild(tr);
        });
    }

    function deleteQuestion(id) {
        if(confirm("Res želite izbrisati to vprašanje?")) {
            let qs = getQuestions();
            qs = qs.filter(q => q.id !== id);
            saveQuestionsDB(qs);
            renderQuestionsTable();
        }
    }

    // 3. SETTINGS TAB
    function loadSettingsForm() {
        const s = getSettings();
        document.getElementById('set-q-count').value = s.qCount;
        document.getElementById('set-q-count').oninput = calcTimePreview;
        calcTimePreview();
    }
    function calcTimePreview() {
        const c = document.getElementById('set-q-count').value;
        document.getElementById('calc-time').innerText = Math.ceil(c * 1.5);
    }
    function saveSettings() {
        const c = parseInt(document.getElementById('set-q-count').value);
        saveSettingsDB({ qCount: c });
        document.getElementById('settings-msg').style.display = 'inline';
        setTimeout(()=>document.getElementById('settings-msg').style.display='none', 2000);
    }

    /* ================= EDITOR MODAL ================= */
    let editingId = null;

    function openEditor(id) {
        editingId = id;
        document.getElementById('modal-editor').classList.remove('hidden');
        const list = document.getElementById('edit-options-list');
        list.innerHTML = "";

        if(id === null) {
            // NEW
            document.getElementById('editor-title').innerText = "Novo vprašanje";
            document.getElementById('edit-text').value = "";
            document.getElementById('edit-points').value = 2;
            document.getElementById('edit-type').value = "single";
            document.getElementById('edit-partial').checked = false;
            document.getElementById('edit-img').value = "";
            document.getElementById('edit-active').value = "true";
            togglePartialOption();
            // Add 2 default options
            addEditorOption(); addEditorOption();
        } else {
            // EDIT
            document.getElementById('editor-title').innerText = "Urejanje vprašanja ID: " + id;
            const qs = getQuestions();
            const q = qs.find(x => x.id === id);
            
            document.getElementById('edit-text').value = q.text;
            document.getElementById('edit-points').value = q.points;
            document.getElementById('edit-type').value = q.type;
            document.getElementById('edit-partial').checked = q.partialCredit || false;
            document.getElementById('edit-img').value = q.imgDesc || "";
            document.getElementById('edit-active').value = q.active.toString();
            
            togglePartialOption();

            q.options.forEach((optText, idx) => {
                addEditorOption(optText, q.correct.includes(idx));
            });
        }
    }

    function togglePartialOption() {
        const t = document.getElementById('edit-type').value;
        const p = document.getElementById('div-partial');
        if(t === 'multi') p.classList.remove('hidden');
        else {
            p.classList.add('hidden');
            document.getElementById('edit-partial').checked = false;
        }
    }

    function addEditorOption(text = "", isCorrect = false) {
        const list = document.getElementById('edit-options-list');
        const div = document.createElement('div');
        div.className = "opt-item";
        div.innerHTML = `
            <input type="checkbox" class="opt-correct" ${isCorrect?'checked':''} title="Označi če je to pravilen odgovor">
            <input type="text" class="opt-text" value="${text}" placeholder="Odgovor...">
            <button class="btn-red btn-small" onclick="this.parentElement.remove()">X</button>
        `;
        list.appendChild(div);
    }

    function saveQuestion() {
        const txt = document.getElementById('edit-text').value;
        if(!txt) return alert("Vnesi besedilo vprašanja!");

        const opts = [];
        const correct = [];
        document.querySelectorAll('#edit-options-list .opt-item').forEach((div, i) => {
            const val = div.querySelector('.opt-text').value;
            const isC = div.querySelector('.opt-correct').checked;
            if(val) {
                opts.push(val);
                if(isC) correct.push(i);
            }
        });

        if(opts.length < 2) return alert("Vnesi vsaj 2 odgovora!");
        if(correct.length === 0) return alert("Vsaj en odgovor mora biti pravilen!");

        const qObj = {
            id: editingId ? editingId : Date.now(),
            text: txt,
            points: parseFloat(document.getElementById('edit-points').value),
            type: document.getElementById('edit-type').value,
            partialCredit: document.getElementById('edit-partial').checked,
            imgDesc: document.getElementById('edit-img').value,
            active: document.getElementById('edit-active').value === 'true',
            options: opts,
            correct: correct
        };

        const qs = getQuestions();
        if(editingId) {
            const idx = qs.findIndex(x => x.id === editingId);
            qs[idx] = qObj;
        } else {
            qs.push(qObj);
        }
        
        saveQuestionsDB(qs);
        closeModal('modal-editor');
        renderQuestionsTable();
    }

    /* ================= REVIEW MODAL (SHUMNIKI) ================= */
    function sanitizeSumniki(str) {
        if(!str) return "";
        return str.toString()
            .replace(/č/g, 'c').replace(/Č/g, 'C')
            .replace(/š/g, 's').replace(/Š/g, 'S')
            .replace(/ž/g, 'z').replace(/Ž/g, 'Z');
    }

    function openReview(resId) {
        const results = getResults();
        const r = results.find(x => x.id === resId);
        if(!r) return;

        const content = document.getElementById('review-content');
        content.innerHTML = "";

        // Header info
        content.innerHTML += `
            <div style="margin-bottom:20px; border-bottom:1px solid #000; padding-bottom:10px;">
                <h3>KANDIDAT: ${sanitizeSumniki(r.userName)} (${r.userId})</h3>
                <p>Datum: ${r.date} | Tocke: ${r.score}/${r.max} | ${r.percent}%</p>
            </div>
        `;

        r.questionsSnapshot.forEach((q, idx) => {
            // Sanitize text
            const qText = sanitizeSumniki(q.text);
            const userPts = q.resultDetails.earned;
            
            let optHtml = "";
            q.options.forEach((opt, oIdx) => {
                const sOpt = sanitizeSumniki(opt);
                const isUser = q.resultDetails.userAns.includes(oIdx);
                const isCorrect = q.correct.includes(oIdx);
                
                let style = "";
                let mark = "[ ]";
                
                if(isUser) mark = "[X]";
                if(isCorrect) style = "color:green; font-weight:bold;";
                if(isUser && !isCorrect) style = "color:red; text-decoration:line-through;";
                
                optHtml += `<div style="${style}">${mark} ${sOpt} ${isCorrect ? '(PRAVILNO)' : ''}</div>`;
            });

            const block = document.createElement('div');
            block.style.marginBottom = "20px";
            block.style.border = "1px solid #ccc";
            block.style.padding = "10px";
            block.style.background = (userPts > 0) ? "#eaffea" : "#ffeaea";

            block.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px;">${idx+1}. ${qText}</div>
                <div style="font-size:0.9em; margin-left:10px;">${optHtml}</div>
                <div style="text-align:right; font-size:0.8em; margin-top:5px;">Dosezeno: ${userPts} / ${q.points}</div>
            `;
            content.appendChild(block);
        });

        document.getElementById('modal-review').classList.remove('hidden');
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

</script>
</body>
</html>
