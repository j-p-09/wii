<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WII PREIZKUS ZNANJA - SISTEM</title>
    <style>
        :root {
            --bg-grey: #f0f0f0;
            --header-grey: #e0e0e0;
            --border-color: #ccc;
            --wii-blue: #0099ff;
            --wii-dark: #333;
            --highlight: #ffffcc;
            --nav-answered: #cceeff;
            --nav-current: #000;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background-color: #888;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            background: #fff;
            display: flex;
            flex-direction: column;
            border: 2px solid #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* --- LOGIN SCREEN --- */
        .center-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            background: var(--bg-grey);
            width: 100%;
        }

        .login-box {
            background: white;
            padding: 40px;
            border: 1px solid #999;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
            width: 300px;
        }

        input[type="text"], input[type="password"], input[type="number"] { 
            padding: 10px; font-size: 16px; margin: 10px 0; width: 100%; box-sizing: border-box; border: 1px solid #ccc;
        }
        button { 
            padding: 10px 20px; font-size: 16px; cursor: pointer; 
            background: var(--header-grey); border: 1px solid #999; font-weight: bold; margin: 5px;
        }
        button:hover { background: #d0d0d0; }
        button.primary { background: var(--wii-blue); color: white; border-color: #0077cc; }
        button.danger { background: #ffcccc; border-color: red; color: red; }
        button.success { background: #ccffcc; border-color: green; color: green; }

        /* --- EXAM LAYOUT --- */
        #exam-header {
            height: 50px;
            background: var(--header-grey);
            border-bottom: 1px solid #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-weight: bold;
        }

        #exam-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #question-area {
            flex: 3;
            padding: 30px;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            background: #fff;
        }

        #navigation-area {
            flex: 1;
            padding: 20px;
            background: #f9f9f9;
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            max-width: 300px;
        }

        /* --- QUESTION STYLING --- */
        .q-header {
            background: #f0f4f8;
            padding: 15px;
            border-left: 5px solid var(--wii-blue);
            margin-bottom: 20px;
        }
        .q-meta { font-size: 0.9em; color: #666; margin-bottom: 5px; display:flex; justify-content:space-between; }
        .q-text { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
        
        /* SLIKA / MEDIA */
        .img-placeholder {
            width: 100%;
            max-height: 400px;
            background: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px dashed #999;
            margin: 15px 0;
            color: #555;
            flex-direction: column;
            padding: 10px;
            text-align: center;
            overflow: hidden;
        }
        .real-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .option-row {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .option-row:hover { background: #f0f0f0; }
        .option-row input { width: auto; margin-right: 10px; }

        /* --- NAV GRID --- */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .nav-box {
            height: 40px;
            border: 1px solid #999;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            position: relative;
            background: white;
        }
        .nav-num { font-size: 10px; padding: 2px; }
        .nav-status { flex: 1; }
        
        .nav-box.current { border: 2px solid #000; }
        .nav-box.answered .nav-status { background-color: var(--nav-answered); border-top: 1px solid #ccc; }
        .nav-box.flagged::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 0; height: 0;
            border-style: solid; border-width: 0 10px 10px 0;
            border-color: transparent red transparent transparent;
        }

        /* --- MANAGER VIEW --- */
        #view-manager { display: flex; flex-direction: column; height: 100%; }
        .manager-nav { background: #333; padding: 10px; display: flex; gap: 10px; }
        .manager-nav button { background: #555; border: none; color: white; margin: 0; }
        .manager-nav button.active { background: var(--wii-blue); }
        .manager-content { padding: 20px; overflow-y: auto; flex: 1; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #eee; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        tr.clickable:hover { background-color: #eef; cursor: pointer; }

        /* --- EDITOR STYLES --- */
        .q-list-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff; display: flex; justify-content: space-between; align-items: center; }
        .q-list-item.disabled { opacity: 0.6; background: #eee; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: white; }
        .badge.multi { background: orange; }
        .badge.single { background: var(--wii-blue); }
        
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 20px; width: 80%; max-height: 90%; overflow-y: auto; border: 2px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .opt-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }

        /* --- RESULT SCREEN --- */
        .result-summary {
            background: #fdfdfd;
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
        }
        .result-row { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding: 5px 0; }
        .review-item { border: 1px solid #eee; margin-bottom: 10px; padding: 10px; }
        .review-item.correct { background: #eeffee; border-left: 5px solid green; }
        .review-item.wrong { background: #ffeeee; border-left: 5px solid red; }
        .review-item.partial { background: #fffde7; border-left: 5px solid orange; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="view-login" class="center-screen">
        <div class="login-box">
            <h2>WII EXAM SYSTEM</h2>
            <p>Vnesi osebno šifro</p>
            <input type="password" id="login-code" placeholder="npr. 000 (admin) ali 1111">
            <button onclick="handleLogin()">PRIJAVA</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">Napačna šifra!</p>
        </div>
    </div>

    <div id="view-preflight" class="center-screen hidden">
        <div class="login-box" style="width: 400px; text-align: left;">
            <h3>Pozdravljeni!</h3>
            <p><b>Ime in priimek:</b> <span id="pf-name"></span></p>
            <p><b>Šifra:</b> <span id="pf-id"></span></p>
            <p><b>Poskus št.:</b> <span id="pf-attempt"></span></p>
            <hr>
            <p>Izpit vsebuje <b id="pf-qcount">10</b> vprašanj.</p>
            <p>Časovna omejitev: <b id="pf-time">15 min</b>.</p>
            <div style="text-align: center; margin-top: 20px;">
                <button class="primary" onclick="startExam()">ZAČNI REŠEVANJE</button>
                <button onclick="logout()">PREKLIČI</button>
            </div>
        </div>
    </div>

    <div id="view-manager" class="hidden">
        <div class="manager-nav">
            <button onclick="setManagerTab('history')" id="tab-btn-history" class="active">ZGODOVINA</button>
            <button onclick="setManagerTab('questions')" id="tab-btn-questions">BAZA VPRAŠANJ</button>
            <button onclick="setManagerTab('settings')" id="tab-btn-settings">NASTAVITVE</button>
            <div style="flex:1"></div>
            <button onclick="logout()" style="background:#cc0000;">ODJAVA</button>
        </div>

        <div id="mgr-tab-history" class="manager-content">
            <h3>Zgodovina preizkusov</h3>
            <p style="color:#666; font-size:0.9em;">Klikni na vrstico za podroben ogled testa.</p>
            <table id="manager-table">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Zaposleni</th>
                        <th>Točke</th>
                        <th>%</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="manager-table-body"></tbody>
            </table>
        </div>

        <div id="mgr-tab-questions" class="manager-content hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Baza vprašanj</h3>
                <button class="success" onclick="openQuestionEditor()">+ DODAJ NOVO VPRAŠANJE</button>
            </div>
            <div id="questions-list"></div>
        </div>

        <div id="mgr-tab-settings" class="manager-content hidden">
            <h3>Konfiguracija izpita</h3>
            <div class="login-box" style="width: 100%; text-align: left;">
                <label>Število vprašanj na poli:</label>
                <input type="number" id="cfg-qcount" min="1" max="100">
                <p style="font-size:0.8em; color:#666;">Privzeto: 10. Če je omogočenih vprašanj manj, bodo uporabljena vsa.</p>
                <br>
                <p><b>Predviden čas:</b> <span id="cfg-calc-time">15 min</span> (1.5 min na vprašanje)</p>
                <button class="primary" onclick="saveSettings()">SHRANI NASTAVITVE</button>
            </div>
            <div style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">
                <h4>Ponastavitev baze</h4>
                <button class="danger" onclick="resetDatabase()">PONASTAVI VSA VPRAŠANJA NA PRIVZETO</button>
            </div>
        </div>
    </div>

    <div id="view-exam" class="hidden" style="flex-direction: column; height: 100%;">
        <div id="exam-header">
            <span>WII PREIZKUS ZNANJA</span>
            <span id="timer-display" style="font-family: monospace; font-size: 1.2em;">00:00</span>
        </div>
        <div id="exam-body">
            <div id="question-area"></div>
            <div id="navigation-area">
                <h3>Navigacija</h3>
                <div id="nav-grid" class="nav-grid"></div>
                <div style="margin-top: auto;">
                    <button onclick="confirmFinish()" style="width:100%; background: #333; color: white;">KONČAJ REŠEVANJE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-result" class="hidden" style="overflow-y: auto; padding: 20px;">
        <div class="result-summary">
            <h2 id="res-title">Rezultat</h2>
            <p id="res-message" style="font-size: 1.2em; font-weight: bold;"></p>
            
            <div style="background: #eee; padding: 15px; margin-top: 10px; border: 1px solid #999;">
                <div class="result-row"><span>Uporabnik:</span><span id="res-user"></span></div>
                <div class="result-row"><span>Datum:</span><span id="res-date"></span></div>
                <div class="result-row"><span>Točke:</span><span id="res-points"></span></div>
                <div class="result-row" style="border:none; font-weight: bold; font-size: 1.2em;"><span>Odstotek:</span><span id="res-percent"></span></div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Pregled odgovorov</h3>
            <button id="btn-print-preview" onclick="togglePrintPreview()" class="primary">PDF / PREDOGLED (CSZ)</button>
        </div>
        <div id="review-list"></div>
        <br>
        <button id="btn-result-close" onclick="closeResultView()" style="width:100%; padding: 15px;">ZAPRI / ODJAVA</button>
    </div>

    <div id="modal-editor" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="editor-title">Urejanje vprašanja</h3>
            
            <div class="form-group">
                <label>Besedilo vprašanja:</label>
                <input type="text" id="ed-text">
            </div>

            <div class="form-group" style="display:flex; gap:20px;">
                <div style="flex:1">
                    <label>Točke:</label>
                    <input type="number" id="ed-points" step="0.5" value="1">
                </div>
                <div style="flex:1">
                    <label>Tip:</label>
                    <select id="ed-type" onchange="updateEditorType()" style="width:100%; padding:10px;">
                        <option value="single">En pravilen odgovor</option>
                        <option value="multi">Več pravilnih odgovorov</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="div-partial" style="display:none; background:#ffffe0; padding:10px; border:1px solid #e0e000;">
                <label style="display:flex; align-items:center;">
                    <input type="checkbox" id="ed-partial"> Dovoli delno točkovanje
                </label>
                <small>Če je vklopljeno, kandidat dobi točke sorazmerno s pravilnimi odgovori. (Napačni odgovori odštevajo).</small>
            </div>

            <div class="form-group">
                <label>Slika (Opcijsko):</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="file" id="ed-img-input" accept="image/png, image/jpeg">
                    <button onclick="clearEditorImage()" style="font-size:0.8em; padding:5px;">Odstrani sliko</button>
                </div>
                <div id="ed-img-preview" class="img-placeholder" style="height:100px; margin-top:5px;">Ni slike</div>
            </div>

            <div class="form-group">
                <label>Odgovori (Označi pravilne):</label>
                <div id="ed-options-list"></div>
                <button onclick="addEditorOption()">+ Dodaj odgovor</button>
            </div>

            <div class="form-group">
                <label style="display:flex; align-items:center; font-size:1.1em;">
                    <input type="checkbox" id="ed-enabled" checked> Vprašanje je OMOGOČENO (Aktivno na testih)
                </label>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <button class="danger" onclick="closeEditor()">Prekliči</button>
                <button class="primary" onclick="saveQuestion()">SHRANI VPRAŠANJE</button>
            </div>
        </div>
    </div>

</div>

<script>
    /* ================= DATA MODEL ================= */
    const DB_KEY = 'wiiShopDBv6';
    const EXAM_KEY = 'wiiExamResults';
    const QUESTIONS_KEY = 'wiiQuestionPool';
    const CONFIG_KEY = 'wiiConfig';

    // Default Question Pool (seeding)
    const initialQuestions = [
        {
            id: 1, text: "Ali je blagajna na sliki prijavljena?", points: 2.00, type: 'single',
            imgDesc: "Zaslon prikazuje '0.00 WII', 'SKUPAJ', spodaj gumb 'LOGIN'.", imgData: null,
            options: ["DA", "NE"], correct: [1], enabled: true, partial: false
        },
        {
            id: 2, text: "Kateri gumb na sliki moramo izbrati za prijavo blagajne?", points: 2.00, type: 'single',
            imgDesc: "Zaslon z gumbi: LOGIN, VMESNO, SKYM, DOLOČI OPRAVILA, DOD., LOGOUT.", imgData: null,
            options: ["LOGIN", "VMESNO", "SKYM", "DOLOČI OPRAVILA", "LOGOUT"], correct: [0], enabled: true, partial: false
        },
        {
            id: 3, text: "Kaj vse moramo vpisati ob prijavi blagajne:", points: 4.00, type: 'multi',
            imgDesc: "Ni slike.", imgData: null,
            options: ["ID ZAPOSLENEGA", "KONČNI DEPOZIT", "STAROST", "ZAČETNI DEPOZIT", "IME IN PRIIMEK BLAGAJNIKA"], correct: [0, 3], enabled: true, partial: true
        },
        {
            id: 4, text: "Kaj naredi gumb VMESNO?", points: 3.00, type: 'single',
            imgDesc: "Gumb 'VMESNO'.", imgData: null,
            options: ["Pokaže koliko denarja je dala zadnja stranka", "Pokaže stanje ob začetku", "Pokaže koliko denarja mora biti v blagajni ta trenutek"], correct: [2], enabled: true, partial: false
        },
        {
            id: 5, text: "Če manager pusti manager kartico, ali lahko odprem meni z gumbom dodatno?", points: 5.00, type: 'single',
            imgDesc: "Varnostno vprašanje.", imgData: null,
            options: ["DA, s kartico lahko počnem vse", "NE, s kartico lahko uporabljam samo osnovne gumbe"], correct: [1], enabled: true, partial: false
        },
        {
            id: 6, text: "Ali je zaslon za stranke na sliki prižgan?", points: 2.00, type: 'single',
            imgDesc: "Sivo ozadje 'WII DELIVERY LOGIN'.", imgData: null,
            options: ["DA", "NE"], correct: [0], enabled: true, partial: false
        },
        {
            id: 7, text: "Kako prižgemo zaslon za stranke, če je že odprt na drugem zaslonu?", points: 2.00, type: 'single',
            imgDesc: "Kontekst prijave.", imgData: null,
            options: ["Prijavimo blagajno", "Ugasnemo vse skupaj"], correct: [0], enabled: true, partial: false
        },
        {
            id: 8, text: "Kaj moramo vnesti v belo polje na sliki?", points: 3.00, type: 'single',
            imgDesc: "Ekran 'WII DELIVERY LOGIN' z belim vnosnim poljem.", imgData: null,
            options: ["WII DELIVERY LOGIN", "Vnest ID zaposlenega", "Skeniramo kartico", "Napišemo svojo strost", "PRIJAVA"], correct: [1], enabled: true, partial: false
        },
        {
            id: 9, text: "Ali je stranka na sliki že oddala naročilo?", points: 3.00, type: 'single',
            imgDesc: "Chat okno. Stranka: 'Dober dan'.", imgData: null,
            options: ["DA", "NE"], correct: [1], enabled: true, partial: false
        },
        {
            id: 10, text: "Katere podatke vpišemo v ZAKLJUČEK NAROČILA?", points: 7.00, type: 'multi',
            imgDesc: "Polja: Št. Računa, Znesek, Način plačila.", imgData: null,
            options: ["Številko računa", "Ime stranke", "Vsebino naročila", "Znesek računa", "Bančno kartico"], correct: [0, 3, 4], enabled: true, partial: true
        }
    ];

    let currentUser = null;
    let viewingResult = null; // For manager reviewing a past test
    
    // Runtime Exam State
    let examState = {
        questions: [],
        answers: {}, // { qIndex: [optIndex, optIndex] }
        flags: {},
        startTime: null,
        endTime: null,
        timer: 0,
        interval: null,
        currentIndex: 0
    };

    // Editor State
    let currentEditId = null; // null = new
    let tempImgData = null;

    /* ================= STORAGE HELPERS ================= */
    function getQuestions() {
        const stored = localStorage.getItem(QUESTIONS_KEY);
        return stored ? JSON.parse(stored) : initialQuestions;
    }

    function saveQuestions(list) {
        localStorage.setItem(QUESTIONS_KEY, JSON.stringify(list));
    }

    function getConfig() {
        const stored = localStorage.getItem(CONFIG_KEY);
        return stored ? JSON.parse(stored) : { questionCount: 10 };
    }

    function saveConfig(cfg) {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
    }

    function getResults() {
        return JSON.parse(localStorage.getItem(EXAM_KEY)) || [];
    }

    function resetDatabase() {
        if(confirm("Ali ste prepričani? To bo izbrisalo vsa dodana vprašanja in povrnilo prvotnih 10.")) {
            saveQuestions(initialQuestions);
            loadQuestionsList();
            alert("Baza ponastavljena.");
        }
    }

    /* ================= LOGIN & NAVIGATION ================= */
    function handleLogin() {
        const code = document.getElementById('login-code').value.trim();
        
        if(code === '000') {
            currentUser = { name: "MANAGER", role: "MANAGER", id: "000" };
            showView('manager');
            setManagerTab('history');
            return;
        }

        // Simple User Check
        let users = JSON.parse(localStorage.getItem(DB_KEY)) || { employees: [] };
        let user = users.employees ? users.employees.find(e => e.code === code) : null;
        
        if(!user && code === '1111') user = { name: "JANEZ NOVAK", id: "1111", role: "ZAPOSLENI" };

        if(user) {
            currentUser = user;
            showView('preflight');
            preparePreflight();
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    }

    function logout() {
        clearInterval(examState.interval);
        currentUser = null;
        viewingResult = null;
        document.getElementById('login-code').value = "";
        document.getElementById('login-error').style.display = 'none';
        showView('login');
    }

    function showView(viewName) {
        ['login', 'preflight', 'manager', 'exam', 'result'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('hidden');
        });
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
    }

    /* ================= STUDENT: PREFLIGHT & EXAM ================= */
    function preparePreflight() {
        const cfg = getConfig();
        document.getElementById('pf-name').innerText = currentUser.name;
        document.getElementById('pf-id').innerText = currentUser.id;
        
        const history = getResults().filter(r => r.userId === currentUser.id);
        document.getElementById('pf-attempt').innerText = history.length + 1;
        
        // Calculate dynamic time
        const qCount = cfg.questionCount;
        const timeMin = Math.ceil(qCount * 1.5);
        
        document.getElementById('pf-qcount').innerText = qCount;
        document.getElementById('pf-time').innerText = `${timeMin} min`;
    }

    function startExam() {
        const cfg = getConfig();
        const allQuestions = getQuestions();
        const enabledQuestions = allQuestions.filter(q => q.enabled);

        // Shuffle and slice
        let selected = enabledQuestions.sort(() => Math.random() - 0.5);
        if (selected.length > cfg.questionCount) {
            selected = selected.slice(0, cfg.questionCount);
        }

        if (selected.length === 0) {
            alert("Napaka: Ni omogočenih vprašanj!");
            return;
        }

        // Setup State
        examState.questions = JSON.parse(JSON.stringify(selected)); // Deep copy
        examState.answers = {};
        examState.flags = {};
        examState.startTime = new Date();
        examState.currentIndex = 0;
        
        // Time: 1.5 min per question => 90 sec
        examState.timer = examState.questions.length * 90;

        showView('exam');
        renderNavGrid();
        loadExamQuestion(0);
        
        updateTimerDisplay();
        examState.interval = setInterval(() => {
            examState.timer--;
            updateTimerDisplay();
            if(examState.timer <= 0) finishExam(true);
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(examState.timer / 60);
        const s = examState.timer % 60;
        document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2, '0')}`;
        document.getElementById('timer-display').style.color = examState.timer < 60 ? "red" : "black";
    }

    function renderNavGrid() {
        const grid = document.getElementById('nav-grid');
        grid.innerHTML = "";
        examState.questions.forEach((q, idx) => {
            const box = document.createElement('div');
            box.className = `nav-box`;
            if(idx === examState.currentIndex) box.classList.add('current');
            if(examState.answers[idx] && examState.answers[idx].length > 0) box.classList.add('answered');
            if(examState.flags[idx]) box.classList.add('flagged');
            box.onclick = () => loadExamQuestion(idx);
            box.innerHTML = `<div class="nav-num">${idx + 1}</div><div class="nav-status"></div>`;
            grid.appendChild(box);
        });
    }

    function loadExamQuestion(index) {
        examState.currentIndex = index;
        const q = examState.questions[index];
        const area = document.getElementById('question-area');
        
        let optionsHtml = "";
        q.options.forEach((opt, optIdx) => {
            const isChecked = (examState.answers[index] || []).includes(optIdx) ? "checked" : "";
            const inputType = q.type === 'multi' ? 'checkbox' : 'radio';
            optionsHtml += `
                <label class="option-row">
                    <input type="${inputType}" name="q_opt_${index}" value="${optIdx}" ${isChecked} onchange="handleAnswer(${index}, ${optIdx}, '${q.type}')">
                    <span>${opt}</span>
                </label>`;
        });

        // Image Logic: DataURL > Description
        let imgContent = `<div class="img-placeholder"><div style="font-weight:bold;">SLIKA:</div>${q.imgDesc || 'Brez opisa'}</div>`;
        if (q.imgData) {
            imgContent = `<div class="img-placeholder" style="background:white; border:none;"><img src="${q.imgData}" class="real-image"></div>`;
        }

        area.innerHTML = `
            <div class="q-header">
                <div class="q-meta"><span>Vprašanje ${index + 1} / ${examState.questions.length}</span><span>Točk: ${q.points}</span></div>
                <div class="q-text">${q.text}</div>
                <label style="cursor:pointer; font-size:0.9em;"><input type="checkbox" ${examState.flags[index]?'checked':''} onchange="toggleFlag(${index})"> Označi (flag)</label>
            </div>
            ${imgContent}
            <div style="margin-top:20px;">
                <p style="font-weight:bold;">${q.type==='multi'?'Pravilnih je lahko več odgovorov:':'Izberi en odgovor:'}</p>
                ${optionsHtml}
            </div>
            <div style="margin-top:30px; display:flex; justify-content:space-between;">
                <button onclick="navStep(-1)" ${index===0?'disabled':''}>&laquo; Nazaj</button>
                <button onclick="navStep(1)" ${index===examState.questions.length-1?'disabled':''}>Naprej &raquo;</button>
            </div>
        `;
        renderNavGrid();
    }

    function handleAnswer(qIdx, optIdx, type) {
        if (!examState.answers[qIdx]) examState.answers[qIdx] = [];
        if (type === 'single') {
            examState.answers[qIdx] = [optIdx];
        } else {
            const arr = examState.answers[qIdx];
            if (arr.includes(optIdx)) examState.answers[qIdx] = arr.filter(i => i !== optIdx);
            else arr.push(optIdx);
        }
        renderNavGrid();
    }

    function toggleFlag(i) { examState.flags[i] = !examState.flags[i]; renderNavGrid(); }
    function navStep(d) { loadExamQuestion(examState.currentIndex + d); }
    
    function confirmFinish() {
        if(confirm("Želite zaključiti reševanje?")) finishExam(false);
    }

    /* ================= SCORING LOGIC ================= */
    function finishExam(forced) {
        clearInterval(examState.interval);
        examState.endTime = new Date();

        let totalPoints = 0;
        let earnedPoints = 0;
        
        // Prepare data for saving
        const questionsResult = examState.questions.map((q, idx) => {
            totalPoints += parseFloat(q.points);
            const userSelection = examState.answers[idx] || [];
            
            // Calc Score
            let qScore = 0;
            let isCorrect = false;
            let isPartial = false;

            // Sort logic for comparison
            const userSorted = [...userSelection].sort().join(',');
            const correctSorted = [...q.correct].sort().join(',');

            if (userSorted === correctSorted) {
                // Full match
                qScore = parseFloat(q.points);
                isCorrect = true;
            } else if (q.type === 'multi' && q.partial) {
                // PARTIAL LOGIC
                // Logic: (CorrectSelected - IncorrectSelected) / TotalCorrectOptions * Points
                let correctHits = 0;
                let wrongHits = 0;
                
                userSelection.forEach(sel => {
                    if(q.correct.includes(sel)) correctHits++;
                    else wrongHits++;
                });

                const totalCorrectOptions = q.correct.length;
                let netScore = (correctHits - wrongHits);
                if (netScore < 0) netScore = 0;

                qScore = (netScore / totalCorrectOptions) * parseFloat(q.points);
                if (qScore > 0) isPartial = true;
            }

            earnedPoints += qScore;

            return {
                id: q.id,
                text: q.text,
                pointsMax: parseFloat(q.points),
                pointsEarned: qScore,
                options: q.options,
                userSelection: userSelection,
                correctSelection: q.correct,
                isCorrect: isCorrect,
                isPartial: isPartial
            };
        });

        const percent = (earnedPoints / totalPoints) * 100;
        const passed = percent > 88;

        const resultRecord = {
            id: Date.now(),
            userId: currentUser.id,
            userName: currentUser.name,
            date: new Date().toISOString(),
            score: earnedPoints.toFixed(2),
            max: totalPoints.toFixed(2),
            percent: percent.toFixed(2),
            passed: passed,
            details: questionsResult
        };

        let history = getResults();
        history.push(resultRecord);
        localStorage.setItem(EXAM_KEY, JSON.stringify(history));

        // Show result
        viewingResult = resultRecord;
        showResultView();
    }

    /* ================= RESULT VIEW ================= */
    function showResultView() {
        showView('result');
        const r = viewingResult;
        
        // Populate header
        document.getElementById('res-user').innerText = r.userName;
        document.getElementById('res-date').innerText = new Date(r.date).toLocaleString();
        document.getElementById('res-points').innerText = `${r.score} / ${r.max}`;
        document.getElementById('res-percent').innerText = `${r.percent}%`;
        
        const title = document.getElementById('res-title');
        const msg = document.getElementById('res-message');
        const btnClose = document.getElementById('btn-result-close');

        if(currentUser.role === 'MANAGER') {
            btnClose.innerText = "NAZAJ NA LISTO";
            btnClose.onclick = () => showView('manager');
        } else {
            btnClose.innerText = "ZAKLJUČI IN ODJAVA";
            btnClose.onclick = logout;
        }

        if(r.passed) {
            title.innerText = "OPRAVIL"; title.style.color = "green";
            msg.innerText = "Čestitke! Test je uspešno opravljen.";
        } else {
            title.innerText = "NI OPRAVIL"; title.style.color = "red";
            msg.innerText = "Žal rezultat ni zadosten (min 88%).";
        }

        renderReviewList(false); // Default view
    }

    function renderReviewList(isPrintMode) {
        const list = document.getElementById('review-list');
        list.innerHTML = "";
        const r = viewingResult;

        r.details.forEach((q, idx) => {
            const div = document.createElement('div');
            
            // Class calculation
            let cssClass = 'wrong';
            if(q.isCorrect) cssClass = 'correct';
            else if(q.isPartial) cssClass = 'partial';
            
            div.className = `review-item ${cssClass}`;

            // Text processing for preview mode
            let qText = q.text;
            let optTexts = [...q.options];
            if(isPrintMode) {
                qText = sanitizeCSZ(qText);
                optTexts = optTexts.map(o => sanitizeCSZ(o));
            }

            let userTxt = q.userSelection.map(i => optTexts[i]).join(', ') || "/";
            let corrTxt = q.correctSelection.map(i => optTexts[i]).join(', ');

            div.innerHTML = `
                <div style="font-weight:bold;">${idx+1}. ${qText}</div>
                <div style="font-size:0.9em; margin-top:5px;">
                    Vaš odgovor: <b>${userTxt}</b> <br>
                    Pravilen odgovor: <b>${corrTxt}</b>
                </div>
                <div style="text-align:right; font-weight:bold;">
                    ${q.pointsEarned.toFixed(2)} / ${q.pointsMax.toFixed(2)} točk
                </div>
            `;
            list.appendChild(div);
        });
    }

    // Funkcija za zamenjavo šumnikov (Preview mode)
    function sanitizeCSZ(str) {
        return str
            .replace(/č/g, 'c').replace(/Č/g, 'C')
            .replace(/š/g, 's').replace(/Š/g, 'S')
            .replace(/ž/g, 'z').replace(/Ž/g, 'Z');
    }

    let isPrintPreview = false;
    function togglePrintPreview() {
        isPrintPreview = !isPrintPreview;
        const btn = document.getElementById('btn-print-preview');
        btn.innerText = isPrintPreview ? "NAZAJ NA NORMALNI POGLED" : "PDF / PREDOGLED (CSZ)";
        renderReviewList(isPrintPreview);
    }
    
    function closeResultView() {
        if(currentUser && currentUser.role === 'MANAGER') {
            showView('manager');
        } else {
            logout();
        }
    }

    /* ================= MANAGER LOGIC ================= */
    function setManagerTab(tab) {
        ['history', 'questions', 'settings'].forEach(t => {
            document.getElementById(`mgr-tab-${t}`).classList.add('hidden');
            document.getElementById(`tab-btn-${t}`).classList.remove('active');
        });
        document.getElementById(`mgr-tab-${tab}`).classList.remove('hidden');
        document.getElementById(`tab-btn-${tab}`).classList.add('active');

        if(tab === 'history') loadHistoryTable();
        if(tab === 'questions') loadQuestionsList();
        if(tab === 'settings') loadSettings();
    }

    // HISTORY
    function loadHistoryTable() {
        const data = getResults().reverse();
        const tbody = document.getElementById('manager-table-body');
        tbody.innerHTML = "";
        
        if(data.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' align='center'>Ni podatkov</td></tr>"; return;
        }

        data.forEach(r => {
            const tr = document.createElement('tr');
            tr.className = "clickable";
            tr.onclick = () => { viewingResult = r; showResultView(); }; // View details
            const d = new Date(r.date);
            tr.innerHTML = `
                <td>${d.toLocaleDateString()} ${d.toLocaleTimeString()}</td>
                <td>${r.userName} (${r.userId})</td>
                <td>${r.score}</td>
                <td>${r.percent}%</td>
                <td class="${r.passed?'pass':'fail'}">${r.passed?'OPRAVIL':'NI OPRAVIL'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // QUESTIONS CRUD
    function loadQuestionsList() {
        const list = document.getElementById('questions-list');
        list.innerHTML = "";
        const qs = getQuestions();

        qs.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = `q-list-item ${q.enabled ? '' : 'disabled'}`;
            div.innerHTML = `
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:1.1em;">
                        ${q.text.substring(0, 60)}${q.text.length>60?'...':''}
                    </div>
                    <div>
                        <span class="badge ${q.type}">${q.type==='single'?'EN':'VEČ'}</span>
                        <span class="badge" style="background:#777">${q.points} t</span>
                        ${q.imgData ? '<span class="badge" style="background:#333">SLIKA</span>' : ''}
                        ${q.partial ? '<span class="badge" style="background:purple">DELNO</span>' : ''}
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleQuestionStatus(${q.id})" style="font-size:0.8em;">${q.enabled?'ONEMOGOČI':'OMOGOČI'}</button>
                    <button class="primary" onclick="editQuestion(${q.id})" style="font-size:0.8em;">UREDI</button>
                    <button class="danger" onclick="deleteQuestion(${q.id})" style="font-size:0.8em;">X</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function toggleQuestionStatus(id) {
        let qs = getQuestions();
        const q = qs.find(x => x.id === id);
        if(q) { q.enabled = !q.enabled; saveQuestions(qs); loadQuestionsList(); }
    }

    function deleteQuestion(id) {
        if(confirm("Brišem vprašanje?")) {
            let qs = getQuestions().filter(x => x.id !== id);
            saveQuestions(qs);
            loadQuestionsList();
        }
    }

    // --- EDITOR ---
    function openQuestionEditor(qId = null) {
        currentEditId = qId;
        const modal = document.getElementById('modal-editor');
        modal.classList.remove('hidden');

        if(qId) {
            // Edit Mode
            document.getElementById('editor-title').innerText = "Urejanje vprašanja";
            const q = getQuestions().find(x => x.id === qId);
            document.getElementById('ed-text').value = q.text;
            document.getElementById('ed-points').value = q.points;
            document.getElementById('ed-type').value = q.type;
            document.getElementById('ed-partial').checked = !!q.partial;
            document.getElementById('ed-enabled').checked = q.enabled;
            tempImgData = q.imgData;
            
            updateImgPreview();
            renderEditorOptions(q.options, q.correct);
        } else {
            // New Mode
            document.getElementById('editor-title').innerText = "Novo vprašanje";
            document.getElementById('ed-text').value = "";
            document.getElementById('ed-points').value = 1;
            document.getElementById('ed-type').value = "single";
            document.getElementById('ed-partial').checked = false;
            document.getElementById('ed-enabled').checked = true;
            tempImgData = null;
            updateImgPreview();
            renderEditorOptions(["Odgovor A", "Odgovor B"], [0]); // Default 2 options
        }
        updateEditorType();
    }

    function renderEditorOptions(options, correctIndices) {
        const container = document.getElementById('ed-options-list');
        container.innerHTML = "";
        const type = document.getElementById('ed-type').value;

        options.forEach((optText, idx) => {
            const row = document.createElement('div');
            row.className = "opt-row";
            const isChecked = correctIndices.includes(idx) ? "checked" : "";
            const inputType = type === 'multi' ? 'checkbox' : 'radio';
            
            row.innerHTML = `
                <input type="${inputType}" name="ed_correct" value="${idx}" ${isChecked}>
                <input type="text" class="ed-opt-text" value="${optText}" style="flex:1;">
                <button class="danger" onclick="removeEditorOption(this)" style="padding:2px 8px;">X</button>
            `;
            container.appendChild(row);
        });
    }

    function addEditorOption() {
        const container = document.getElementById('ed-options-list');
        const row = document.createElement('div');
        const type = document.getElementById('ed-type').value;
        row.className = "opt-row";
        
        // Count existing to assign new value index (visual mostly)
        const idx = container.children.length;
        
        row.innerHTML = `
            <input type="${type==='multi'?'checkbox':'radio'}" name="ed_correct" value="${idx}">
            <input type="text" class="ed-opt-text" value="Nov odgovor" style="flex:1;">
            <button class="danger" onclick="removeEditorOption(this)" style="padding:2px 8px;">X</button>
        `;
        container.appendChild(row);
    }

    function removeEditorOption(btn) {
        btn.parentElement.remove();
        // Re-index inputs not strictly necessary for saving logic as we read by DOM order
    }

    function updateEditorType() {
        const type = document.getElementById('ed-type').value;
        const partialDiv = document.getElementById('div-partial');
        
        partialDiv.style.display = (type === 'multi') ? 'block' : 'none';
        
        // Update input types in list without losing text
        const container = document.getElementById('ed-options-list');
        const inputs = container.querySelectorAll('input[name="ed_correct"]');
        inputs.forEach(inp => {
            inp.type = (type === 'multi') ? 'checkbox' : 'radio';
        });
    }

    // Image Handling
    const fileInput = document.getElementById('ed-img-input');
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                tempImgData = e.target.result;
                updateImgPreview();
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    function clearEditorImage() {
        tempImgData = null;
        document.getElementById('ed-img-input').value = "";
        updateImgPreview();
    }

    function updateImgPreview() {
        const div = document.getElementById('ed-img-preview');
        if(tempImgData) {
            div.innerHTML = `<img src="${tempImgData}" class="real-image">`;
            div.style.background = "white";
            div.style.border = "none";
        } else {
            div.innerHTML = "Ni slike";
            div.style.background = "#ddd";
            div.style.border = "2px dashed #999";
        }
    }

    function closeEditor() {
        document.getElementById('modal-editor').classList.add('hidden');
    }

    function saveQuestion() {
        const text = document.getElementById('ed-text').value.trim();
        if(!text) return alert("Vnesi besedilo vprašanja!");

        const points = parseFloat(document.getElementById('ed-points').value);
        const type = document.getElementById('ed-type').value;
        const partial = document.getElementById('ed-partial').checked;
        const enabled = document.getElementById('ed-enabled').checked;

        // Gather Options
        const container = document.getElementById('ed-options-list');
        const rows = container.querySelectorAll('.opt-row');
        let options = [];
        let correct = [];

        rows.forEach((row, idx) => {
            const txt = row.querySelector('.ed-opt-text').value.trim();
            const checked = row.querySelector('input[name="ed_correct"]').checked;
            options.push(txt);
            if(checked) correct.push(idx);
        });

        if(options.length < 2) return alert("Vprašanje mora imeti vsaj 2 odgovora!");
        if(correct.length === 0) return alert("Označi vsaj en pravilen odgovor!");

        const qs = getQuestions();
        
        const newQ = {
            id: currentEditId ? currentEditId : Date.now(), // Unique ID
            text, points, type,
            imgData: tempImgData,
            imgDesc: tempImgData ? "Uporabniška slika" : "Ni slike",
            options, correct, enabled, partial
        };

        if(currentEditId) {
            const idx = qs.findIndex(q => q.id === currentEditId);
            qs[idx] = newQ;
        } else {
            qs.push(newQ);
        }

        saveQuestions(qs);
        closeEditor();
        loadQuestionsList();
    }

    // SETTINGS
    function loadSettings() {
        const cfg = getConfig();
        const inp = document.getElementById('cfg-qcount');
        inp.value = cfg.questionCount;
        
        // Update calc time immediately
        updateCalcTime(cfg.questionCount);
        inp.oninput = (e) => updateCalcTime(e.target.value);
    }

    function updateCalcTime(val) {
        document.getElementById('cfg-calc-time').innerText = `${Math.ceil(val * 1.5)} min`;
    }

    function saveSettings() {
        const val = parseInt(document.getElementById('cfg-qcount').value);
        if(val < 1) return alert("Najmanj 1 vprašanje.");
        saveConfig({ questionCount: val });
        alert("Nastavitve shranjene.");
    }

</script>
</body>
</html>
