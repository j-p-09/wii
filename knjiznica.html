<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKnjiga - Knjižnični sistem (Win95)</title>
    <style>
        /* --- WINDOWS 95 TEMA & CSS --- */
        :root {
            --win-gray: #c0c0c0;
            --win-dark: #808080;
            --win-black: #000000;
            --win-light: #ffffff;
            --win-blue: #000080;
            --pastel-red: #ffcccb;
            --pastel-green: #ccffcc;
            --pastel-yellow: #ffffcc;
            --bg-teal: #008080;
        }

        body {
            background-color: var(--bg-teal);
            font-family: 'MS Sans Serif', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 3D Borders Utility */
        .win-outset {
            background-color: var(--win-gray);
            border-top: 2px solid var(--win-light);
            border-left: 2px solid var(--win-light);
            border-right: 2px solid var(--win-dark);
            border-bottom: 2px solid var(--win-black);
        }

        .win-inset {
            background-color: #fff;
            border-top: 2px solid var(--win-dark);
            border-left: 2px solid var(--win-dark);
            border-right: 2px solid var(--win-light);
            border-bottom: 2px solid var(--win-light);
        }

        /* Gumbi */
        .win-btn {
            background-color: var(--win-gray);
            border-top: 2px solid var(--win-light);
            border-left: 2px solid var(--win-light);
            border-right: 2px solid var(--win-dark);
            border-bottom: 2px solid var(--win-black);
            padding: 4px 12px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            min-width: 70px;
            text-align: center;
        }
        .win-btn:active {
            border-top: 2px solid var(--win-black);
            border-left: 2px solid var(--win-black);
            border-right: 2px solid var(--win-light);
            border-bottom: 2px solid var(--win-light);
            transform: translate(1px, 1px);
        }

        /* Glavni kontejner */
        #app-container {
            width: 98vw;
            height: 95vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-sizing: border-box;
        }

        .title-bar {
            background: linear-gradient(90deg, var(--win-blue), #1084d0);
            color: white;
            padding: 4px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 24px;
        }

        .content-area {
            flex-grow: 1;
            padding: 10px;
            overflow: hidden;
            position: relative;
        }

        /* Inputi */
        input, select, textarea {
            background: white;
            border: 2px inset #fff;
            border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark);
            padding: 3px;
            font-family: inherit;
            outline: none;
        }

        /* Ekrani */
        .screen { display: none; height: 100%; width: 100%; }
        .screen.active { display: flex; flex-direction: column; }

        /* Login */
        #login-screen {
            align-items: center;
            justify-content: center;
        }
        .login-box {
            width: 320px;
            padding: 4px;
        }
        .login-inner { padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        /* Meni (Domača stran) */
        #home-screen {
            text-align: center;
        }
        .top-info-bar {
            display: flex;
            justify-content: space-between;
            font-size: 1.2em;
            margin-bottom: 40px;
            padding: 10px;
            border-bottom: 2px groove white;
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        .menu-big-btn {
            height: 60px;
            font-size: 1.1em;
        }

        /* Tabele */
        .table-container {
            height: 100%;
            overflow: auto;
            background: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid #c0c0c0;
            padding: 4px;
            text-align: left;
            cursor: default;
            vertical-align: top;
        }
        th {
            background: #e0e0e0;
            border-bottom: 2px solid #808080;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* --- IZPOSOJA SPECIFIKA --- */
        .izposoja-grid {
            display: grid;
            grid-template-rows: auto 1fr auto; /* Header, Table, Footer */
            height: 100%;
            gap: 8px;
        }
        
        .izp-header {
            background: #d4d0c8;
            padding: 8px;
            border: 2px groove white;
        }
        .izp-row { display: flex; align-items: center; gap: 15px; margin-bottom: 4px; }
        .edit-icon { cursor: pointer; border: 1px solid gray; padding: 0 4px; background: #eee; font-size: 10px; margin-left: 5px; }

        .izp-table-wrap {
            border: 2px inset white;
            background: white;
            overflow: auto;
        }

        /* Tabela Izbor */
        tr.selected-row {
            background-color: var(--pastel-yellow) !important;
        }
        /* Statusi (če niso izbrani) */
        tr.status-late { color: red; }
        tr.status-reserved { background-color: var(--pastel-green); }

        .izp-footer {
            border: 2px groove white;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .izp-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .book-preview-box {
            text-align: center;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #e0e0e0;
            border: 1px solid gray;
            margin-bottom: 5px;
        }

        /* --- GLOBALNI GUMBI --- */
        .global-overlay-btns {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 900;
            display: flex;
            gap: 10px;
        }

        /* --- MODAL (Pogovorno okno) --- */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-window {
            width: 400px;
            max-width: 90%;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            background: var(--win-gray);
        }
        .modal-body {
            padding: 15px;
            background: var(--win-gray);
            max-height: 400px;
            overflow: auto;
        }
        .modal-form-row {
            margin-bottom: 10px;
        }
        .modal-form-row label {
            display: block;
            margin-bottom: 2px;
            font-size: 0.9em;
        }
        .modal-form-row input, .modal-form-row select {
            width: 100%;
            box-sizing: border-box;
        }
        .modal-footer {
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: var(--win-gray);
        }

        /* Utility */
        .bold { font-weight: bold; }
        .text-red { color: red; }
        .text-green { color: green; }
        .clickable-link { 
            color: blue; 
            text-decoration: underline; 
            cursor: pointer; 
        }

    </style>
</head>
<body>

    <div class="global-overlay-btns">
        <button id="btn-logout" class="win-btn" style="display:none;" onclick="logout()">ODJAVA</button>
        <button id="btn-exit" class="win-btn" style="display:none;" onclick="goToHome()">IZHOD</button>
    </div>

    <div id="app-container" class="win-outset">
        <div class="title-bar">
            <span>MKnjiga - Sistem</span>
            <button class="win-btn" style="padding:0 4px; height:18px; line-height:14px;">X</button>
        </div>

        <div class="content-area">

            <div id="login-screen" class="screen active">
                <div class="win-outset login-box">
                    <div class="title-bar">Prijava</div>
                    <div class="login-inner">
                        <div>
                            <label>Uporabniško ime:</label>
                            <input type="text" id="login-user" style="width:100%">
                        </div>
                        <div>
                            <label>Geslo:</label>
                            <input type="password" id="login-pass" style="width:100%">
                        </div>
                        <div style="text-align:center; margin-top:10px;">
                            <button class="win-btn" onclick="attemptLogin()">POTRDI</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="home-screen" class="screen">
                <div class="top-info-bar">
                    <div id="display-user" class="bold"></div>
                    <div id="display-clock" class="bold">00:00:00</div>
                </div>
                
                <div style="flex-grow:1; display:flex; align-items:center; justify-content:center;">
                    <div class="menu-grid">
                        <button class="win-btn menu-big-btn" onclick="moduleIzposojaInit()">IZPOSOJA</button>
                        <button class="win-btn menu-big-btn" onclick="moduleSkladisce()">SKLADIŠČE</button>
                        <button class="win-btn menu-big-btn" onclick="modulePodatki()">PODATKI</button>
                        <button class="win-btn menu-big-btn" onclick="moduleProfil()">PROFIL</button>
                    </div>
                </div>
            </div>

            <div id="profil-screen" class="screen">
                <h2>Urejanje Profila</h2>
                <div class="win-outset" style="padding:20px; max-width:400px; margin:0 auto;">
                    <div class="modal-form-row">
                        <label>Ime in Priimek:</label>
                        <input type="text" id="p-name">
                    </div>
                    <div class="modal-form-row">
                        <label>Gmail:</label>
                        <input type="text" id="p-email">
                    </div>
                    <div class="modal-form-row">
                        <label>Uporabniško ime:</label>
                        <input type="text" id="p-user">
                    </div>
                    <div class="modal-form-row">
                        <label>Geslo:</label>
                        <input type="password" id="p-pass">
                    </div>
                    <div style="text-align:right; margin-top:20px;">
                        <button class="win-btn" onclick="saveProfile()">Shrani</button>
                    </div>
                </div>
            </div>

            <div id="skladisce-screen" class="screen">
                <h3>Pregled Skladišča</h3>
                <div style="padding:10px;">
                    Iskanje: <input type="text" id="stock-search" onkeyup="renderStockTable()" placeholder="Naslov, Avtor ali Šifra...">
                </div>
                <div class="win-inset table-container">
                    <table id="stock-table">
                        <thead><tr><th>Šifra</th><th>Naslov</th><th>Avtor</th><th>Zaloga</th><th>Lokacija</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="admin-screen" class="screen">
                <div style="padding:10px; display:flex; gap:10px; border-bottom:2px groove white;">
                    <button class="win-btn" onclick="renderAdminSection('users')">Uporabniki</button>
                    <button class="win-btn" onclick="renderAdminSection('settings')">Rok & Zamudnine</button>
                    <button class="win-btn" onclick="renderAdminSection('books')">Knjige</button>
                    <button class="win-btn" onclick="renderAdminSection('customers')">Stranke</button>
                    <button class="win-btn" onclick="renderAdminSection('warehouses')">Skladišča</button>
                </div>
                <div id="admin-content" style="padding:10px; flex-grow:1; overflow:auto;">
                    </div>
            </div>

            <div id="izposoja-screen" class="screen">
                <div class="izposoja-grid">
                    <div class="izp-header">
                        <div class="izp-row">
                            <span class="bold">Član:</span> 
                            <span id="izp-id"></span> 
                            <span id="izp-name" class="bold"></span>
                            <button class="edit-icon" onclick="editCustomerDetails()">✎</button>
                        </div>
                        <div class="izp-row">
                            <span>Terjatve EUR:</span> 
                            <span id="izp-debt">0,0000</span>
                            <button class="edit-icon" onclick="payDebt()">PLAČAJ</button>
                        </div>
                        <div class="izp-row">
                            <span class="text-red">Opomba:</span> 
                            <span id="izp-note" class="text-red"></span>
                            <button class="edit-icon" onclick="editCustomerNote()">✎</button>
                        </div>
                    </div>

                    <div class="izp-table-wrap">
                        <table class="izp-table">
                            <thead>
                                <tr>
                                    <th width="30">#</th>
                                    <th>Šifra</th>
                                    <th>Opis (Avtor, Naslov, Leto)</th>
                                    <th>Datum Izposoje</th>
                                    <th>Rok Vrnitve</th>
                                    <th>Terjatev</th>
                                </tr>
                            </thead>
                            <tbody id="izp-table-body">
                                </tbody>
                        </table>
                    </div>

                    <div class="izp-footer">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="bold">IN/CN=</span>
                            <input type="text" id="izp-input-code" style="width:200px;" placeholder="Skeniraj ali klikni vrstico..." onkeyup="checkBookInput()">
                        </div>
                        
                        <div id="izp-book-info" class="book-preview-box">
                            <span style="color:gray;">(Informacije o knjigi)</span>
                        </div>

                        <div class="izp-controls">
                            <button class="win-btn text-green bold" onclick="actionIzposodi()">Izposodi</button>
                            <button class="win-btn" onclick="actionVrni()">Vrni</button>
                            <button class="win-btn" onclick="actionPodaljsaj()">Podaljšaj</button>
                            <button class="win-btn" onclick="actionRezerviraj()">Rezerviraj</button>
                            <button class="win-btn" onclick="goToHome()">Zapri</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-overlay">
        <div class="win-outset modal-window">
            <div class="title-bar" id="modal-title">Obvestilo</div>
            <div class="modal-body" id="modal-content">
                </div>
            <div class="modal-footer" id="modal-footer">
                </div>
        </div>
    </div>

    <script>
        // --- PODATKOVNA STRUKTURA ---
        const defaultData = {
            users: [
                { id: "1", name: "Administrator", user: "ADMIN", pass: "ADMIN", role: "admin" }
            ],
            books: [
                { id: "0000002", author: "Shakespeare, William", title: "Hamlet", year: "1603", total: 5, stock: 5, location: "Skladišče A" },
                { id: "0000004", author: "Dickens, Charles", title: "Great Expectations", year: "1861", total: 3, stock: 2, location: "Skladišče B" }
            ],
            customers: [
                { id: "0100001", name: "John Smith", type: "zaposleni", note: "Brez posebnosti", debt: 0.00 },
                { id: "0100002", name: "Janez Novak", type: "študent", note: "Dolguje knjigo", debt: 1.50 },
                { id: "0100003", name: "Tine Tolar", type: "študent", note: "", debt: 0.00 },
                { id: "0100004", name: "Tinkara Kovač", type: "zaposleni", note: "", debt: 0.00 }
            ],
            loans: [], // { id, bookId, customerId, dateOut, dateDue, isReserved }
            warehouses: ["Skladišče A", "Skladišče B", "Arhiv"],
            settings: { 
                loanMinutes: 10, // Rok v minutah
                feePerMinute: 0.50 // Cena zamudnine na minuto
            }
        };

        // Globalne spremenljivke
        let db = {};
        let currentUser = null;
        let activeCustomer = null;
        let selectedBookId = null; // Za izposojo (skenirano ali kliknjeno)

        // --- INICIALIZACIJA ---
        function init() {
            const stored = localStorage.getItem('mknjiga_full_db_v2');
            if (stored) {
                db = JSON.parse(stored);
            } else {
                db = JSON.parse(JSON.stringify(defaultData));
                saveDB();
            }
            startClock();
        }

        function saveDB() {
            localStorage.setItem('mknjiga_full_db_v2', JSON.stringify(db));
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('display-clock').innerText = now.toLocaleTimeString('sl-SI');
            }, 1000);
        }

        // --- NAVIGACIJA ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id + '-screen').classList.add('active');

            // Gumbi Zgoraj
            const btnLogout = document.getElementById('btn-logout');
            const btnExit = document.getElementById('btn-exit');

            if (id === 'login') {
                btnLogout.style.display = 'none';
                btnExit.style.display = 'none';
            } else if (id === 'home') {
                btnLogout.style.display = 'block';
                btnExit.style.display = 'none';
                document.getElementById('display-user').innerText = currentUser.name;
            } else {
                // Moduli
                btnLogout.style.display = 'none';
                btnExit.style.display = 'block';
            }
        }

        function goToHome() {
            showScreen('home');
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-user').value = "";
            document.getElementById('login-pass').value = "";
            showScreen('login');
        }

        // --- LOGIKA PRIJAVE ---
        function attemptLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const user = db.users.find(x => x.user === u && x.pass === p);

            if (user) {
                currentUser = user;
                showScreen('home');
            } else {
                openAlert("Napaka", "Napačno uporabniško ime ali geslo!");
            }
        }

        // --- MODAL SYSTEM (Custom Windows) ---
        
        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function openAlert(title, text) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = `<p>${text}</p>`;
            document.getElementById('modal-footer').innerHTML = `<button class="win-btn" onclick="closeModal()">OK</button>`;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        // Univerzalni obrazec za vnos podatkov
        function openFormModal(title, fields, callback) {
            document.getElementById('modal-title').innerText = title;
            let html = "";
            fields.forEach(f => {
                html += `<div class="modal-form-row">
                            <label>${f.label}</label>
                            <input type="${f.type || 'text'}" id="modal-input-${f.id}" value="${f.value || ''}">
                         </div>`;
            });
            document.getElementById('modal-content').innerHTML = html;
            
            // Gumbi
            const footer = document.getElementById('modal-footer');
            footer.innerHTML = "";
            
            const btnConfirm = document.createElement("button");
            btnConfirm.className = "win-btn";
            btnConfirm.innerText = "Potrdi";
            btnConfirm.onclick = () => {
                const result = {};
                fields.forEach(f => {
                    result[f.id] = document.getElementById(`modal-input-${f.id}`).value;
                });
                closeModal();
                callback(result);
            };

            const btnCancel = document.createElement("button");
            btnCancel.className = "win-btn";
            btnCancel.innerText = "Prekliči";
            btnCancel.onclick = closeModal;

            footer.appendChild(btnConfirm);
            footer.appendChild(btnCancel);

            document.getElementById('modal-overlay').style.display = 'flex';
        }

        // --- ADMIN MODULE ---
        function modulePodatki() {
            // Check Admin pass
            openFormModal("Varnostno preverjanje", [{id:'pass', label:'Vpiši ADMIN geslo:', type:'password'}], (res) => {
                const admin = db.users.find(u => u.user === 'ADMIN');
                if (res.pass === admin.pass) {
                    showScreen('admin');
                    renderAdminSection('users');
                } else {
                    openAlert("Napaka", "Napačno geslo.");
                }
            });
        }

        function renderAdminSection(section) {
            const container = document.getElementById('admin-content');
            let html = "";
            
            if (section === 'users') {
                html = `<h3>Zaposleni</h3>
                        <button class="win-btn" onclick="adminAddUser()">Dodaj zaposlenega</button><br><br>
                        <table>
                            <tr><th>ID</th><th>Ime</th><th>User</th><th>Geslo</th><th>Akcija</th></tr>
                            ${db.users.map(u => `<tr><td>${u.id}</td><td>${u.name}</td><td>${u.user}</td><td>***</td><td><button onclick="adminDelUser('${u.id}')">Briši</button></td></tr>`).join('')}
                        </table>`;
            } else if (section === 'books') {
                html = `<h3>Knjige</h3>
                        <button class="win-btn" onclick="adminAddBook()">Dodaj knjigo</button><br><br>
                        <table>
                            <tr><th>Šifra</th><th>Naslov</th><th>Avtor</th><th>Zaloga</th><th>Akcija</th></tr>
                            ${db.books.map(b => `<tr><td>${b.id}</td><td>${b.title}</td><td>${b.author}</td><td>${b.stock}/${b.total}</td><td><button onclick="adminDelBook('${b.id}')">Briši</button></td></tr>`).join('')}
                        </table>`;
            } else if (section === 'customers') {
                html = `<h3>Stranke</h3>
                        <button class="win-btn" onclick="adminAddCustomer()">Dodaj stranko</button><br><br>
                        <table>
                            <tr><th>ID</th><th>Ime</th><th>Tip</th><th>Akcija</th></tr>
                            ${db.customers.map(c => `<tr><td>${c.id}</td><td>${c.name}</td><td>${c.type}</td><td><button onclick="adminDelCustomer('${c.id}')">Briši</button></td></tr>`).join('')}
                        </table>`;
            } else if (section === 'settings') {
                html = `<h3>Nastavitve Roka in Zamudnin</h3>
                        <div class="modal-form-row">
                            <label>Čas izposoje (v minutah):</label>
                            <input type="number" id="adm-time" value="${db.settings.loanMinutes || 10}">
                        </div>
                        <div class="modal-form-row">
                            <label>Cena zamudnine na minuto (€):</label>
                            <input type="number" id="adm-fee" value="${db.settings.feePerMinute || 0.50}" step="0.01">
                        </div>
                        <br>
                        <button class="win-btn" onclick="saveAdminSettings()">Shrani nastavitve</button>
                        `;
            } else {
                html = "<p>Izberite kategorijo zgoraj.</p>";
            }
            container.innerHTML = html;
        }

        // Admin Actions
        function saveAdminSettings() {
            const t = document.getElementById('adm-time').value;
            const f = document.getElementById('adm-fee').value;
            db.settings.loanMinutes = parseFloat(t);
            db.settings.feePerMinute = parseFloat(f);
            saveDB();
            openAlert("Info", "Nastavitve shranjene.");
        }

        function adminAddUser() {
            openFormModal("Dodaj zaposlenega", [
                {id:'id', label:'Šifra zaposlenega:'},
                {id:'name', label:'Ime in priimek:'},
                {id:'user', label:'Uporabniško ime:'},
                {id:'pass', label:'Geslo:'}
            ], (res) => {
                if(res.id && res.user) {
                    db.users.push({id: res.id, name: res.name, user: res.user, pass: res.pass, role: 'librarian'});
                    saveDB(); renderAdminSection('users');
                }
            });
        }
        function adminDelUser(id) {
            if(id === "1") return openAlert("Napaka", "Admina ne moreš brisati.");
            db.users = db.users.filter(u => u.id !== id);
            saveDB(); renderAdminSection('users');
        }

        function adminAddBook() {
            openFormModal("Dodaj knjigo (Vsi podatki)", [
                {id:'id', label:'Šifra knjige:'},
                {id:'title', label:'Naslov:'},
                {id:'author', label:'Avtor:'},
                {id:'year', label:'Leto izida:'},
                {id:'total', label:'Količina (skupaj):', type:'number'},
                {id:'loc', label:'Skladišče:'}
            ], (res) => {
                if(res.id && res.title) {
                    db.books.push({
                        id: res.id, title: res.title, author: res.author, year: res.year,
                        total: parseInt(res.total), stock: parseInt(res.total), location: res.loc
                    });
                    saveDB(); renderAdminSection('books');
                }
            });
        }
        function adminDelBook(id) {
            db.books = db.books.filter(b => b.id !== id);
            saveDB(); renderAdminSection('books');
        }

        function adminAddCustomer() {
            openFormModal("Dodaj stranko", [
                {id:'id', label:'Številka izkaznice:'},
                {id:'name', label:'Ime in priimek:'},
                {id:'type', label:'Tip (zaposleni/študent/...):'}
            ], (res) => {
                if(res.id && res.name) {
                    db.customers.push({id: res.id, name: res.name, type: res.type, note: "", debt: 0});
                    saveDB(); renderAdminSection('customers');
                }
            });
        }
        function adminDelCustomer(id) {
            db.customers = db.customers.filter(c => c.id !== id);
            saveDB(); renderAdminSection('customers');
        }

        // --- SKLADIŠČE ---
        function moduleSkladisce() {
            showScreen('skladisce');
            renderStockTable();
        }
        function renderStockTable() {
            const filter = document.getElementById('stock-search').value.toLowerCase();
            const tbody = document.querySelector("#stock-table tbody");
            tbody.innerHTML = db.books
                .filter(b => b.title.toLowerCase().includes(filter) || b.author.toLowerCase().includes(filter) || b.id.includes(filter))
                .map(b => `<tr>
                    <td>${b.id}</td>
                    <td class="bold">${b.title}</td>
                    <td>${b.author}</td>
                    <td>
                        <span class="clickable-link bold" onclick="showBorrowers('${b.id}')">${b.stock} / ${b.total}</span>
                    </td>
                    <td>${b.location}</td>
                </tr>`)
                .join('');
        }

        function showBorrowers(bookId) {
            // Poišči kdo ima to knjigo
            const borrowers = db.loans.filter(l => l.bookId === bookId && !l.isReserved);
            
            if (borrowers.length === 0) {
                return openAlert("Info", "Knjiga trenutno ni izposojena nikomur.");
            }

            let html = `<b>Knjigo ${bookId} imajo izposojeno:</b><br><br>`;
            borrowers.forEach(l => {
                const c = db.customers.find(cu => cu.id === l.customerId);
                if(c) {
                    html += `• ${c.id} - ${c.name} (Do: ${new Date(l.dateDue).toLocaleString('sl-SI')})<br>`;
                }
            });

            openAlert("Zaloga - Podrobnosti", html);
        }

        // --- PROFIL ---
        function moduleProfil() {
            document.getElementById('p-name').value = currentUser.name;
            document.getElementById('p-user').value = currentUser.user;
            document.getElementById('p-pass').value = currentUser.pass;
            showScreen('profil');
        }
        function saveProfile() {
            currentUser.name = document.getElementById('p-name').value;
            currentUser.user = document.getElementById('p-user').value;
            currentUser.pass = document.getElementById('p-pass').value;
            // Update Array
            const idx = db.users.findIndex(u => u.id === currentUser.id);
            if(idx !== -1) db.users[idx] = currentUser;
            saveDB();
            openAlert("Info", "Shranjeno.");
        }

        // --- IZPOSOJA (CORE) ---
        
        // 1. Korak: Vnos/Iskanje stranke
        function moduleIzposojaInit() {
            // Najprej zahtevaj vnos
            openFormModal("Izbira člana", [{id:'search', label:'Vpiši šifro ali priimek člana:'}], (res) => {
                const val = res.search.trim().toLowerCase();
                if (!val) return goToHome();

                // Išči ujemanja
                const matches = db.customers.filter(c => c.id.toLowerCase() === val || c.name.toLowerCase().startsWith(val));

                if (matches.length === 0) {
                    openAlert("Napaka", "Stranka ni najdena.");
                    goToHome();
                } else if (matches.length === 1) {
                    // Samo ena stranka - avtomatsko odpri
                    activeCustomer = matches[0];
                    loadIzposojaUI();
                } else {
                    // Več strank - ponudi izbiro
                    openCustomerSelectResult(matches);
                }
            });
        }

        function openCustomerSelectResult(matches) {
             document.getElementById('modal-title').innerText = "Izberi pravo stranko";
             let html = `<div style="height:200px; overflow:auto; background:white; border:2px inset white;">`;
             matches.forEach(c => {
                 html += `<div style="padding:4px; border-bottom:1px dotted #ccc; cursor:pointer;" onclick="selectCustomerResult('${c.id}')">
                            <b>${c.id}</b> - ${c.name}
                           </div>`;
             });
             html += `</div>`;
             
             document.getElementById('modal-content').innerHTML = html;
             document.getElementById('modal-footer').innerHTML = `<button class="win-btn" onclick="goToHome(); closeModal()">Prekliči</button>`;
             document.getElementById('modal-overlay').style.display = 'flex';
        }

        function selectCustomerResult(id) {
            closeModal();
            activeCustomer = db.customers.find(c => c.id === id);
            loadIzposojaUI();
        }

        // 2. Korak: UI Izposoje
        function loadIzposojaUI() {
            showScreen('izposoja');
            // Header
            document.getElementById('izp-id').innerText = activeCustomer.id;
            document.getElementById('izp-name').innerText = activeCustomer.name + ", " + activeCustomer.type;
            document.getElementById('izp-debt').innerText = parseFloat(activeCustomer.debt).toFixed(4);
            document.getElementById('izp-note').innerText = activeCustomer.note;
            
            // Reset selection
            document.getElementById('izp-input-code').value = "";
            selectedBookId = null;
            updateBookInfoDisplay(null);
            
            renderLoanTable();
        }

        // Render Datum/Ura Helper
        function formatDateTime(isoStr) {
            if(!isoStr) return "";
            const d = new Date(isoStr);
            return `${d.toLocaleDateString('sl-SI')}<br>${d.toLocaleTimeString('sl-SI')}`;
        }

        function renderLoanTable() {
            const tbody = document.getElementById('izp-table-body');
            const loans = db.loans.filter(l => l.customerId === activeCustomer.id);
            
            tbody.innerHTML = loans.map((l, idx) => {
                const book = db.books.find(b => b.id === l.bookId);
                if (!book) return ""; 
                
                const now = new Date();
                const due = l.dateDue ? new Date(l.dateDue) : null;
                const isLate = due && (now > due);
                
                const isSelected = (selectedBookId === l.bookId);
                let rowClass = isSelected ? "selected-row" : "";
                
                if (!isSelected) {
                    if (l.isReserved) rowClass = "status-reserved"; 
                    else if (isLate) rowClass = "status-late"; 
                }

                let dateOutStr = formatDateTime(l.dateOut);
                let dateDueStr = l.isReserved ? "REZERVIRANO" : formatDateTime(l.dateDue);
                
                // Terjatev stolpec
                let terjatevCell = "";
                if (l.isReserved) {
                    // Gumb za brisanje rezervacije
                    terjatevCell = `<button class="win-btn" style="padding:0 5px; font-size:0.8em;" onclick="event.stopPropagation(); deleteReservation('${l.bookId}')">Briši</button>`;
                } else if (isLate) {
                    // Izračun zamudnine: minute zamude * cena
                    const diffMs = now - due;
                    const diffMins = Math.ceil(diffMs / 60000);
                    const cost = (diffMins * db.settings.feePerMinute).toFixed(2);
                    terjatevCell = `${cost} €`;
                }

                return `<tr class="${rowClass}" onclick="selectRow('${book.id}')">
                    <td>${idx + 1}.</td>
                    <td class="bold">${book.id}</td>
                    <td>
                        <div class="bold">${book.title}</div>
                        <div style="font-size:0.8em">${book.author}, ${book.year}</div>
                    </td>
                    <td>${dateOutStr}</td>
                    <td>${dateDueStr}</td>
                    <td style="text-align:center;">${terjatevCell}</td>
                </tr>`;
            }).join('');
        }

        function deleteReservation(bookId) {
            const idx = db.loans.findIndex(l => l.customerId === activeCustomer.id && l.bookId === bookId && l.isReserved);
            if (idx !== -1) {
                db.loans.splice(idx, 1);
                saveDB();
                renderLoanTable();
            }
        }

        // LOGIKA IZBIRA VRSTICE
        function selectRow(bookId) {
            selectedBookId = bookId;
            document.getElementById('izp-input-code').value = bookId;
            const book = db.books.find(b => b.id === bookId);
            updateBookInfoDisplay(book);
            renderLoanTable();
        }

        // LOGIKA SKENIRANJA / VNOSA
        function checkBookInput() {
            const val = document.getElementById('izp-input-code').value;
            const book = db.books.find(b => b.id === val);
            if (book) {
                selectedBookId = book.id;
                updateBookInfoDisplay(book);
                renderLoanTable();
            } else {
                selectedBookId = null;
                updateBookInfoDisplay(null);
            }
        }

        function updateBookInfoDisplay(book) {
            const container = document.getElementById('izp-book-info');
            if (book) {
                container.innerHTML = `<div class="bold">${book.title}</div>
                                       <div style="font-size:0.8em">${book.author} (Na voljo: ${book.stock})</div>`;
            } else {
                container.innerHTML = `<span style="color:gray;">Knjiga ni najdena / ni izbrana</span>`;
            }
        }

        // AKCIJE GUMBOV
        function actionIzposodi() {
            const book = db.books.find(b => b.id === selectedBookId);
            if (!book) return openAlert("Napaka", "Izberi ali vpiši šifro knjige.");
            
            if (book.stock <= 0) return openAlert("Napaka", "Ni zaloge!");
            
            const existing = db.loans.find(l => l.customerId === activeCustomer.id && l.bookId === book.id && !l.isReserved);
            if (existing) return openAlert("Napaka", "Stranka že ima to knjigo.");

            // Create Loan (Minutes logic)
            const due = new Date();
            const minutesToAdd = db.settings.loanMinutes || 10;
            due.setMinutes(due.getMinutes() + minutesToAdd);
            
            db.loans.push({
                customerId: activeCustomer.id,
                bookId: book.id,
                dateOut: new Date().toISOString(),
                dateDue: due.toISOString(),
                isReserved: false
            });
            
            book.stock--;
            saveDB();
            loadIzposojaUI();
        }

        function actionVrni() {
            if (!selectedBookId) return openAlert("Info", "Izberi vrstico za vračilo.");
            
            const idx = db.loans.findIndex(l => l.customerId === activeCustomer.id && l.bookId === selectedBookId && !l.isReserved);
            if (idx === -1) return openAlert("Napaka", "Ta knjiga ni izposojena.");
            
            db.loans.splice(idx, 1);
            const book = db.books.find(b => b.id === selectedBookId);
            if(book) book.stock++;
            
            selectedBookId = null;
            document.getElementById('izp-input-code').value = "";
            
            saveDB();
            loadIzposojaUI();
        }

        function actionPodaljsaj() {
            if (!selectedBookId) return openAlert("Info", "Izberi vrstico.");
            const loan = db.loans.find(l => l.customerId === activeCustomer.id && l.bookId === selectedBookId && !l.isReserved);
            if (!loan) return openAlert("Napaka", "Ni aktivne izposoje za to knjigo.");
            
            const newDue = new Date(loan.dateDue);
            const minutesToAdd = db.settings.loanMinutes || 10;
            newDue.setMinutes(newDue.getMinutes() + minutesToAdd);
            loan.dateDue = newDue.toISOString();
            
            saveDB();
            loadIzposojaUI();
        }

        function actionRezerviraj() {
             const book = db.books.find(b => b.id === selectedBookId);
             if (!book) return openAlert("Napaka", "Izberi knjigo.");
             
             if (book.stock > 0) return openAlert("Info", "Knjiga je na voljo, raje izposodi.");
             
             db.loans.push({
                customerId: activeCustomer.id,
                bookId: book.id,
                dateOut: new Date().toISOString(),
                dateDue: null,
                isReserved: true
            });
            saveDB();
            loadIzposojaUI();
        }

        function editCustomerDetails() {
            openFormModal("Uredi stranko", [{id:'name', label:'Novo ime:', value:activeCustomer.name}], (res) => {
                activeCustomer.name = res.name;
                saveDB(); loadIzposojaUI();
            });
        }
        function payDebt() {
            openFormModal("Plačilo", [{id:'amount', label:'Znesek (€):', type:'number'}], (res) => {
                const val = parseFloat(res.amount);
                if(val) {
                    activeCustomer.debt = Math.max(0, activeCustomer.debt - val);
                    saveDB(); loadIzposojaUI();
                }
            });
        }
        function editCustomerNote() {
            openFormModal("Opomba", [{id:'note', label:'Vsebina opombe:', value:activeCustomer.note}], (res) => {
                activeCustomer.note = res.note;
                saveDB(); loadIzposojaUI();
            });
        }

        // START
        init();

    </script>
</body>
</html>
