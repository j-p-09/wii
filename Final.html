<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WII SHOP BLAGAJNA FINAL v9 (TASKS + MENUS + MGR UPDATE)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #e0e0e0;
            --main-border: 2px solid #000;
            --double-border: 4px double #000;
            --highlight-yellow: #fffacd; 
            --promo-red: #d00000;
            --task-red: #cc0000;
            --task-green: #008800;
            --pastel-yellow: #ffffcc;
            --font-main: Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: var(--font-main);
            background-color: #888;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            border: var(--main-border);
        }

        /* --- LEVA STRAN: RAƒåUN --- */
        #left-panel {
            width: 33.33%;
            border-right: var(--main-border);
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        #receipt-header {
            padding: 5px;
            text-align: center;
            border-bottom: var(--double-border);
            font-weight: bold;
            background: #ccc;
            font-size: 14px;
        }

        /* NOVO: STATUS KARTICE */
        #card-status-bar {
            height: 0;
            overflow: hidden;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: height 0.2s;
            border-bottom: 0px solid #000;
        }
        #card-status-bar.active { height: 30px; border-bottom: 2px solid #000; }
        .card-ok { background-color: var(--pastel-yellow); color: #000; }
        .card-wrong { background-color: #ffcccc; color: #d00000; }

        #receipt-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
        }

        .receipt-item {
            display: flex;
            flex-direction: column;
            padding: 4px 0;
            cursor: pointer;
            border-bottom: 1px dotted #ccc;
        }
        .receipt-row-main {
            display: flex;
            justify-content: space-between;
        }

        .receipt-item.selected { background-color: var(--highlight-yellow); }
        .receipt-item.promo .receipt-row-main { color: var(--promo-red); font-weight: bold; }
        .receipt-item.voided .receipt-row-main { text-decoration: line-through; color: #888; }

        /* NOVO: SUB ITEMS & TASKS IN RECEIPT */
        .sub-item-row {
            font-size: 0.85em;
            color: #555;
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
        }
        .task-row {
            font-size: 0.8em;
            padding-left: 10px;
            font-weight: bold;
        }
        .task-row.pending { color: var(--task-red); }
        .task-row.done { color: var(--task-green); }

        #receipt-footer {
            border-top: var(--double-border);
            padding: 10px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            background: #eee;
        }

        /* --- DESNA STRAN --- */
        #right-panel {
            width: 66.66%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
        }

        #status-bar-container {
            padding: 10px 20px;
            border-bottom: var(--main-border);
            min-height: 60px; /* fiksna vi≈°ina da ne skaƒçe */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* NOVO: TASK PANEL (zamenja status bar) */
        #task-panel {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: row;
            gap: 5px;
            overflow-x: auto;
        }
        .task-btn {
            background: #fff;
            border: 2px solid #000;
            font-weight: bold;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 2px 2px 0 #000;
        }
        .task-btn:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #000; }

        .status-label {
            font-size: 12px;
            margin-bottom: 2px;
            text-transform: uppercase;
            font-weight: bold;
            color: #444;
        }

        .status-table {
            width: 100%;
            border: 3px solid #000;
            display: flex;
            height: 35px;
            background: #fff;
        }

        .st-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border-right: 2px solid #000;
        }

        .st-id { width: 15%; }
        .st-name { width: 70%; text-transform: uppercase;}
        .st-timer { width: 15%; border-right: none; }

        .logged-out .st-id, .logged-out .st-name {
            background-color: #ddd;
            color: transparent;
        }

        /* GUMBI */
        #main-display {
            flex-grow: 1;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            grid-auto-rows: 1fr; /* Za search bar */
            gap: 8px;
            overflow-y: auto;
            position: relative; /* Za manager overlay */
        }

        .btn {
            background: #f0f0f0;
            border: 1px solid #999;
            box-shadow: 3px 3px 0px #000;
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2px;
            transition: all 0.1s;
        }

        .btn:active {
            box-shadow: 1px 1px 0px #000;
            transform: translate(2px, 2px);
        }

        .btn-grey { background: #ccc; color: #666; }
        .btn-red { background: #ffcccc; }
        .btn-green { background: #ccffcc; }
        .btn-search { background: #fffacd; border: 2px solid #555; font-size: 16px; } 
        .btn-nav { background: #333; color: white; border-color: #000; box-shadow: none; border-right: 1px solid #555; }

        /* NAVIGACIJA */
        #nav-bar {
            height: 60px;
            border-top: var(--main-border);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            background: #333;
        }

        /* --- MODALNA OKNA --- */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: #e0e0e0;
            border: var(--double-border);
            padding: 4px;
            width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 15px 15px 0 #000;
        }

        .modal-header {
            background: #000;
            color: #fff;
            padding: 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .modal-body {
            padding: 15px;
            text-align: center;
            overflow-y: auto;
        }

        /* DISPLAY ZA VNOS */
        .input-display {
            width: 100%;
            height: 40px;
            background: #fff;
            border: 2px inset #000;
            margin-bottom: 10px;
            font-size: 24px;
            text-align: right; 
            padding: 5px;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* ≈†TEVILƒåNICA */
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .keypad-btn {
            height: 50px;
            font-size: 20px;
            background: #fff;
            border: 1px solid #000;
            box-shadow: 2px 2px 0 #000;
            cursor: pointer;
        }
        .keypad-btn:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #000; }

        /* TIPKOVNICA ZA BESEDILO (QWERTY) */
        .keyboard-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
        }
        .kb-btn {
            width: 40px; height: 40px;
            font-size: 16px;
            font-weight: bold;
            background: #fff;
            border: 1px solid #000;
            box-shadow: 2px 2px 0 #000;
            cursor: pointer;
        }
        .kb-btn-wide { width: 85px; }

        /* LISTE V MODALU */
        .modal-list {
            text-align: left;
            border: 1px solid #000;
            background: #fff;
            max-height: 300px;
            overflow-y: auto;
        }
        .modal-list-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-list-item:hover { background: #ffffd0; }
        .list-btn-action { font-size: 10px; padding: 2px 5px; background: #eee; border: 1px solid #000; margin-left:5px; }
        
        /* CUSTOM ALERT TEXT */
        .msg-text { font-size: 18px; margin: 20px 0; line-height: 1.4; }

        /* --- NOVO: MGR EMBEDDED KEYPAD --- */
        #mgr-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        #mgr-top-buttons {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            padding-bottom: 10px;
        }
        #mgr-bottom-section {
            height: 220px;
            display: flex;
            flex-direction: column;
            border-top: 2px solid #000;
            padding-top: 5px;
            background: #ccc;
        }
        #mgr-input-line {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 5px;
            font-size: 14px;
            margin-bottom: 5px;
            height: 25px;
            display: flex; 
            align-items: center;
        }
        #mgr-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            flex-grow: 1;
        }
        .mgr-key {
            background: #333; /* Onemogoƒçeno */
            color: #555;
            border: 1px solid #000;
            font-weight: bold;
            font-size: 18px;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mgr-key.active {
            background: #e0e0e0;
            color: #000;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
        }
        .mgr-key.active:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #000; }

    </style>
</head>
<body>

<div id="app-container">
    <div id="left-panel">
        <div id="receipt-header">RAƒåUN #<span id="receipt-num">----</span></div>
        <div id="card-status-bar"><span id="card-status-text"></span></div>
        <div id="receipt-body"></div>
        <div id="receipt-footer">
            <span>SKUPAJ:</span>
            <span id="total-amount">0.00 WII</span>
        </div>
    </div>

    <div id="right-panel">
        <div id="status-bar-container">
            <div id="normal-status-view">
                <div class="status-label" id="status-label-text">ODJAVLJENA BLAGAJNA</div>
                <div class="status-table logged-out" id="status-table">
                    <div class="st-cell st-id" id="disp-id">000</div>
                    <div class="st-cell st-name" id="disp-name">ADMINISTRATOR</div>
                    <div class="st-cell st-timer" id="disp-timer">0:00</div>
                </div>
            </div>
            <div id="task-panel"></div>
        </div>

        <div id="main-display"></div>

        <div id="nav-bar">
            <button class="btn btn-nav" onclick="setMode('ARTICLES')">ARTIKLI</button>
            <button class="btn btn-nav" onclick="setMode('FUNCTIONS')">FUNKCIJE</button>
            <button class="btn btn-nav" onclick="setMode('FINISH')">ZAKLJUƒåEK</button>
            <button class="btn btn-nav" onclick="setMode('MANAGER')">MANAGER</button>
            <button class="btn btn-nav" onclick="togglePOF()">P.O.F</button>
        </div>
    </div>
</div>

<div id="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <span id="modal-title">VNOS</span>
            <span style="cursor:pointer" onclick="closeModal()">‚úï</span>
        </div>
        <div class="modal-body" id="modal-content"></div>
    </div>
</div>

<script>
    /* ================= BROADCAST SYSTEM ================= */
    const displayChannel = new BroadcastChannel('wii_shop_display');

    function broadcastUpdate(type, data) {
        displayChannel.postMessage({ type: type, payload: data });
    }

    /* ================= CUSTOM DIALOGS ================= */
    let _alertCallback = null;
    let _confirmYes = null;
    let _confirmNo = null;

    function customAlert(msg, callback) {
        _alertCallback = callback;
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "OBVESTILO";
        content.innerHTML = `
            <div class="msg-text">${msg}</div>
            <button class="btn" style="width:100%; height:50px; background:#f0f0f0;" onclick="closeCustomAlert()">V REDU</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeCustomAlert() {
        closeModal();
        if (_alertCallback) {
            const cb = _alertCallback;
            _alertCallback = null;
            cb();
        }
    }

    function customConfirm(msg, onYes, onNo) {
        _confirmYes = onYes;
        _confirmNo = onNo;
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "POTRDITEV";
        content.innerHTML = `
            <div class="msg-text">${msg}</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="height:50px; background:#8f8;" onclick="confirmAction(true)">DA</button>
                <button class="btn" style="height:50px; background:#faa;" onclick="confirmAction(false)">NE</button>
            </div>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function confirmAction(result) {
        closeModal();
        if (result && _confirmYes) _confirmYes();
        if (!result && _confirmNo) _confirmNo();
        _confirmYes = null; 
        _confirmNo = null;
    }

    /* ================= PODATKOVNA BAZA ================= */
    const defaultData = {
        employees: [
            { id: '000', name: 'ADMINISTRATOR', role: 'MANAGER', code: '000' }
        ],
        articles: [
            { name: 'KARTA', price: 10.00, enabled: true, code: "48392" },
            { name: 'KAZEN', price: 40.00, enabled: true, code: "75014" },
            { name: 'KLAVIR (min)', price: 0.90, enabled: true, code: "92637" },
            { name: 'WII POT', price: 1.70, enabled: true, code: "18465" },
            { name: 'POPRAVILO', price: 5.00, enabled: true, code: "63928" },
            { name: 'VREƒåKA', price: 2.10, enabled: true, code: "57290" },
            { name: 'NALEPKA', price: 0.75, enabled: true, code: "81046" },
            { name: 'KUVERTA', price: 4.20, enabled: true, code: "29571" },
            { name: 'PO≈†TNINA', price: 2.50, enabled: true, code: "46803" },
            { name: 'ZNAMKA', price: 1.00, enabled: true, code: "90752" },
            { name: 'PS (min)', price: 1.10, enabled: true, code: "13489" },
            { name: 'OSTALO', price: 0.01, enabled: true, code: "12" }
        ],
        bankAccounts: {}, 
        customerTasks: {}, /* NOVO: Shranjevanje opravil po ID stranke */
        receipts: [],
        receiptCounter: 1000,
        cashInDrawer: 0.00,
        shiftLog: [],
        mgrHistory: [], 
        settings: {
            poa: true, 
            rof: false 
        }
    };

    let db = JSON.parse(localStorage.getItem('wiiShopDBv5')) || defaultData;
    
    if(!db.customerTasks) db.customerTasks = {}; 
    
    // MIGRACIJA KOD & NOVIH POLJ (Menu, Condition)
    db.articles.forEach((art, idx) => {
        if (!art.code) art.code = (idx + 1).toString();
        if (art.isMenu === undefined) art.isMenu = false;
        if (art.condition === undefined) art.condition = false;
        if (!art.subItems) art.subItems = [];
    });
    saveDB();

    function saveDB() { localStorage.setItem('wiiShopDBv5', JSON.stringify(db)); }

    /* ================= STATE & PERSISTENCE ================= */
    let currentUser = null; 
    let currentReceipt = []; 
    let selectedItemIndex = -1;
    let timerInterval = null;
    let timerSeconds = 0;
    let timerRunning = false;
    let isPOF = false; 
    let currentMode = 'ARTICLES';
    let activeManagerMenu = null; 
    let managerSubMode = 'MAIN'; // MAIN ali EXTRA
    
    // NOVO: Kartica
    let activeCustomerId = null; 
    let cardStatusTimeout = null;

    // NOVO: MGR Keypad State
    let embeddedKeypad = {
        active: false,
        buffer: "",
        mode: "", // LOGIN_ID, LOGIN_CASH, SKYM
        tempId: null
    };

    function saveSession() {
        const session = {
            user: currentUser,
            receipt: currentReceipt,
            timer: timerSeconds,
            mode: currentMode,
            activeCustomerId: activeCustomerId
        };
        localStorage.setItem('wiiShopSession', JSON.stringify(session));
    }

    function loadSession() {
        const saved = JSON.parse(localStorage.getItem('wiiShopSession'));
        if (saved && saved.user) {
            currentUser = saved.user;
            currentReceipt = saved.receipt || [];
            timerSeconds = saved.timer || 0;
            currentMode = 'ARTICLES'; 
            activeCustomerId = saved.activeCustomerId || null;
            updateStatusBar();
            renderReceipt();
            if (activeCustomerId) showCardStatus(true);
            if (currentReceipt.length > 0) startTimer();
            renderButtons();
        }
    }

    /* ================= UTILS ================= */
    function formatMoney(amount) {
        return parseFloat(amount).toFixed(2) + " WII";
    }
    
    function cleanStr(str) {
        if(!str) return "";
        return str.toString()
            .replace(/ƒç/g, 'c').replace(/ƒå/g, 'C')
            .replace(/≈°/g, 's').replace(/≈†/g, 'S')
            .replace(/≈æ/g, 'z').replace(/≈Ω/g, 'Z');
    }

    function logMgrAction(user, action) {
        db.mgrHistory.unshift({
            time: new Date(),
            user: user.name,
            role: user.role,
            action: action
        });
        if(db.mgrHistory.length > 100) db.mgrHistory.pop();
        saveDB();
    }

    /* ================= TIMER ================= */
    function startTimer() {
        if (timerRunning) return;
        timerRunning = true;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timerSeconds++;
            updateTimerDisplay();
            saveSession();
        }, 1000);
    }
    function stopTimer() {
        clearInterval(timerInterval);
        timerRunning = false;
        timerSeconds = 0;
        updateTimerDisplay();
        saveSession();
    }
    function updateTimerDisplay() {
        const min = Math.floor(timerSeconds / 60);
        const sec = timerSeconds % 60;
        document.getElementById('disp-timer').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
    }

    /* ================= UI RENDERING ================= */
    function updateStatusBar() {
        const table = document.getElementById('status-table');
        const label = document.getElementById('status-label-text');
        const idCell = document.getElementById('disp-id');
        const nameCell = document.getElementById('disp-name');

        if (currentUser) {
            table.classList.remove('logged-out');
            label.textContent = "PRIJAVLJENA BLAGAJNA";
            idCell.textContent = currentUser.id;
            nameCell.textContent = currentUser.name;
        } else {
            table.classList.add('logged-out');
            label.textContent = "ODJAVLJENA BLAGAJNA";
            idCell.textContent = "000";
            nameCell.textContent = "";
        }
        
        broadcastUpdate('STATUS', { isOpen: !!currentUser });
        
        // Check for Condition Panel
        checkConditionPanel();
    }

    // NOVO: Preverjanje ali prika≈æemo pas z opravili
    function checkConditionPanel() {
        const normalView = document.getElementById('normal-status-view');
        const taskPanel = document.getElementById('task-panel');
        
        // ƒåe imamo izbran artikel IN ima naloge
        const item = getSelectedItem(true); // true = silent (no alert)
        
        if (item && item.tasks && item.tasks.length > 0) {
            normalView.style.display = 'none';
            taskPanel.style.display = 'flex';
            renderTaskPanel(item);
        } else {
            normalView.style.display = 'block';
            taskPanel.style.display = 'none';
        }
    }

    function renderTaskPanel(item) {
        const panel = document.getElementById('task-panel');
        panel.innerHTML = '';
        item.tasks.forEach((task, idx) => {
            const btn = document.createElement('button');
            btn.className = 'task-btn';
            btn.textContent = task.name;
            btn.onclick = () => {
                // Toggle task status
                task.done = !task.done;
                renderReceipt();
                // Ohranimo fokus
            };
            // Vizualno oznaƒçimo gumb? Zaenkrat pustimo belega, text v raƒçunu se barva
            if(task.done) {
                 btn.style.background = "#ccffcc"; 
            }
            panel.appendChild(btn);
        });
    }

    function showCardStatus(isValid) {
        const bar = document.getElementById('card-status-bar');
        const text = document.getElementById('card-status-text');
        
        if (cardStatusTimeout) clearTimeout(cardStatusTimeout);
        
        bar.className = isValid ? 'active card-ok' : 'active card-wrong';
        text.textContent = isValid ? "CARD OK" : "CARD WRONG";

        if (!isValid) {
            cardStatusTimeout = setTimeout(() => {
                bar.className = '';
                text.textContent = '';
                activeCustomerId = null;
                saveSession();
            }, 3000);
        } else {
            // Ostane
        }
    }

    function renderReceipt() {
        const container = document.getElementById('receipt-body');
        container.innerHTML = '';
        let total = 0;

        document.getElementById('receipt-num').textContent = currentUser ? (currentReceipt.length > 0 ? "WIP" : "----") : "----";

        currentReceipt.forEach((item, index) => {
            if (!item.isVoid) total += (item.price * item.qty);
            
            // Sub items cost
            if (!item.isVoid && item.subItems) {
                item.subItems.forEach(sub => total += (sub.price * item.qty));
            }

            const div = document.createElement('div');
            div.className = `receipt-item ${index === selectedItemIndex ? 'selected' : ''} ${item.isPromo ? 'promo' : ''} ${item.isVoid ? 'voided' : ''}`;
            div.onclick = () => {
                if(currentUser && !item.isFinal) {
                    selectedItemIndex = index;
                    renderReceipt();
                    checkConditionPanel();
                }
            };

            let prefix = item.isPromo ? "P " : "";
            let nameDisplay = item.name;
            if (item.qty > 1) nameDisplay += ` (${item.qty}x)`;

            if (!item.isPromo && !item.isVoid && item.price < item.originalPrice) {
                const discountPercent = Math.round((1 - (item.price / item.originalPrice)) * 100);
                nameDisplay += ` [-${discountPercent}%]`;
            }

            // MAIN ROW
            const mainRow = document.createElement('div');
            mainRow.className = 'receipt-row-main';
            mainRow.innerHTML = `<span>${prefix}${nameDisplay}</span><span>${formatMoney(item.price * item.qty)}</span>`;
            div.appendChild(mainRow);

            // SUB ITEMS (MENU)
            if (item.subItems && item.subItems.length > 0) {
                item.subItems.forEach(sub => {
                    const subRow = document.createElement('div');
                    subRow.className = 'sub-item-row';
                    subRow.innerHTML = `<span>- ${sub.name}</span><span>${sub.price > 0 ? formatMoney(sub.price*item.qty) : ''}</span>`;
                    div.appendChild(subRow);
                });
            }

            // TASKS (CONDITION)
            if (item.tasks && item.tasks.length > 0) {
                item.tasks.forEach(task => {
                    const tRow = document.createElement('div');
                    tRow.className = `task-row ${task.done ? 'done' : 'pending'}`;
                    tRow.innerText = `- ${task.name}`;
                    div.appendChild(tRow);
                });
            }

            container.appendChild(div);
        });

        const lastItem = currentReceipt[currentReceipt.length-1];
        if (lastItem && lastItem.isFinal) {
             const line = document.createElement('div');
             line.innerHTML = "---------------------------------";
             line.style.textAlign = 'center';
             container.appendChild(line);
             const finalDiv = document.createElement('div');
             finalDiv.style.textAlign = 'center';
             finalDiv.innerHTML = `RAƒåUN #${lastItem.receiptId}`;
             container.appendChild(finalDiv);
        }

        const totalStr = formatMoney(total);
        document.getElementById('total-amount').textContent = totalStr;
        saveSession(); 
        
        if (currentUser) {
            broadcastUpdate('CART', {
                items: currentReceipt,
                total: total,
                totalStr: totalStr
            });
        }
    }

    function setMode(mode) {
        if (mode === 'MANAGER') {
            requestAuthCode("Vnesi KODO za dostop:", (user) => {
                logMgrAction(user, "ACCESSED MGR MENU");
                currentMode = 'MANAGER';
                managerSubMode = 'MAIN';
                // Reset keypad logic
                embeddedKeypad.active = false;
                embeddedKeypad.mode = "";
                
                if (user.role === 'HOST') activeManagerMenu = 'HOST';
                else if (user.role === 'MANAGER') activeManagerMenu = 'MANAGER';
                else { customAlert("Ta koda nima dostopa do funkcij!"); return; }
                
                renderButtons();
            });
            return;
        }

        if (!currentUser) { customAlert("Najprej se mora prijaviti manager/blagajnik!"); return; }
        currentMode = mode;
        renderButtons();
    }

    function renderButtons() {
        const container = document.getElementById('main-display');
        container.innerHTML = '';
        checkConditionPanel(); // Re-check condition panel status when mode changes

        if (currentMode === 'ARTICLES') {
            const searchRow = document.createElement('div');
            searchRow.style.gridColumn = "span 4";
            searchRow.className = "btn btn-search";
            searchRow.style.padding = "0";
            searchRow.innerHTML = '<img src="scan.png" style="width:100%; height:100%; object-fit:contain;" alt="SCAN">';
            searchRow.onclick = () => {
                showKeypad("Vnesi ≈°ifro artikla:", false, (val) => processArticleCode(val));
            };
            container.appendChild(searchRow);

            if (db.settings.poa) {
                db.articles.forEach(art => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    if (!art.enabled) {
                        btn.classList.add('btn-grey');
                        btn.disabled = true;
                    }
                    // Menu indikator ali navaden
                    let displayPrice = formatMoney(art.price);
                    if(art.isMenu) displayPrice += "+";
                    
                    btn.innerHTML = `<span>${art.name}</span>` + (isPOF ? `<br><span style="font-size:0.9em">${displayPrice}</span>` : '');
                    
                    if (art.enabled) {
                        btn.onclick = () => addItem(art);
                    }
                    container.appendChild(btn);
                });
            }
        } 
        else if (currentMode === 'FUNCTIONS') {
            const functions = [
                { name: 'KOLIƒåINA', action: fnQuantity },
                { name: 'PROMO', action: fnPromo },
                { name: 'VOID', action: fnVoid },
                { name: '% POPUST', action: fnDiscount },
                { name: 'SKENIRAJ KARTICO', action: fnScanCard } 
            ];
            functions.forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = f.name;
                btn.onclick = f.action;
                container.appendChild(btn);
            });
        }
        else if (currentMode === 'FINISH') {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.gridColumn = "span 4";
            btn.style.gridRow = "span 2";
            btn.style.fontSize = "20px";
            btn.textContent = "KONƒåAJ RAƒåUN";
            btn.onclick = finishReceiptSequence;
            container.appendChild(btn);
        }
        else if (currentMode === 'MANAGER') {
            if (managerSubMode === 'MAIN') {
                // GLAVNI MANAGER POGLED (S ≈°tevilƒçnico)
                container.style.display = 'block'; // Zahtevano zaradi custom layouta
                
                // HTML Layout za Manager Main
                container.innerHTML = `
                <div id="mgr-layout">
                    <div id="mgr-top-buttons">
                        </div>
                    <div id="mgr-bottom-section">
                        <div id="mgr-input-line"></div>
                        <div id="mgr-keypad">
                            <button class="mgr-key" data-k="7">7</button><button class="mgr-key" data-k="8">8</button><button class="mgr-key" data-k="9">9</button>
                            <button class="mgr-key" data-k="4">4</button><button class="mgr-key" data-k="5">5</button><button class="mgr-key" data-k="6">6</button>
                            <button class="mgr-key" data-k="1">1</button><button class="mgr-key" data-k="2">2</button><button class="mgr-key" data-k="3">3</button>
                            <button class="mgr-key" data-k="C">C</button><button class="mgr-key" data-k="0">0</button><button class="mgr-key" data-k="OK">OK</button>
                        </div>
                    </div>
                </div>`;

                const btnContainer = document.getElementById('mgr-top-buttons');
                const mainBtns = [
                    { name: 'LOGIN', img: 'login.png', action: () => activateMgrKeypad('LOGIN') },
                    { name: 'VMESNO', img: 'vmesno.png', action: mgrInterim },
                    { name: 'SKYM', img: 'skym.png', action: () => activateMgrKeypad('SKYM') },
                    { name: 'DOLOƒåI OPRAVILA', img: 'opravila.png', action: mgrTasks },
                    { name: 'DODATNO', img: 'dodatno.png', action: () => { managerSubMode = 'EXTRA'; renderButtons(); } },
                    { name: 'LOGOUT', img: 'logout.png', action: mgrLogout }
                ];

                mainBtns.forEach(b => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    if (b.img) {
                        btn.style.padding = "0";
                        btn.innerHTML = `<img src="${b.img}" style="width:100%; height:100%; object-fit:contain;" alt="${b.name}">`;
                    } else { btn.innerText = b.name; }
                    btn.onclick = b.action;
                    btnContainer.appendChild(btn);
                });

                // Inicializacija keypad listeners
                document.querySelectorAll('.mgr-key').forEach(k => {
                    k.onclick = () => handleMgrKeyInput(k.dataset.k);
                });
                updateMgrKeypadVisuals();

            } else {
                // DODATNO MENU (Original items + Sales)
                container.style.display = 'grid'; // Nazaj na grid
                const extraBtns = [
                    { name: 'NAZAJ', action: () => { managerSubMode = 'MAIN'; renderButtons(); } },
                    { name: 'ARTIKLI', img: 'artikli.png', action: mgrArticles },
                    { name: 'ZAPOSLENI', img: 'zaposleni.png', action: mgrEmployees },
                    { name: 'STORNO', img: 'storno.png', action: mgrStorno },
                    { name: 'BANKA', img: 'banka.png', action: mgrBank },
                    { name: 'PRODAJA', img: 'prodaja.png', action: mgrSales }, // NOVO
                    { name: `P.O.A. ${db.settings.poa ? 'ON' : 'OFF'}`, action: togglePOA, customClass: db.settings.poa ? 'btn-green' : 'btn-red' },
                    { name: `R.O.F. ${db.settings.rof ? 'ON' : 'OFF'}`, action: toggleROF, customClass: db.settings.rof ? 'btn-green' : 'btn-red' },
                    { name: 'MGR ZGOD.', img: 'mgrzgod.png', action: mgrShowHistory }
                ];

                extraBtns.forEach(b => {
                     const btn = document.createElement('button');
                     btn.className = `btn ${b.customClass || ''}`;
                     if (b.img) {
                         btn.style.padding = "0";
                         btn.innerHTML = `<img src="${b.img}" style="width:100%; height:100%; object-fit:contain;" alt="${b.name}">`;
                     } else { btn.innerText = b.name; }
                     btn.onclick = b.action;
                     container.appendChild(btn);
                 });
            }
        }
    }

    /* ================= MANAGER KEYPAD LOGIC ================= */
    function activateMgrKeypad(mode) {
        embeddedKeypad.active = true;
        embeddedKeypad.mode = mode;
        embeddedKeypad.buffer = "";
        embeddedKeypad.tempId = null;
        embeddedKeypad.step = 1; // 1 = ID, 2 = CASH/AMOUNT
        updateMgrKeypadVisuals();
    }

    function updateMgrKeypadVisuals() {
        const line = document.getElementById('mgr-input-line');
        const keys = document.querySelectorAll('.mgr-key');
        
        if (!embeddedKeypad.active) {
            if(line) line.innerText = "";
            keys.forEach(k => k.classList.remove('active'));
        } else {
            keys.forEach(k => k.classList.add('active'));
            // Prompt text
            let prompt = "";
            if (embeddedKeypad.mode === 'LOGIN') {
                prompt = embeddedKeypad.step === 1 ? "ID ZAPOSLENEGA: " : `ZAPOSLENI: ${embeddedKeypad.tempName} | DEPOZIT: `;
            } else if (embeddedKeypad.mode === 'SKYM') {
                prompt = "ZNESEK DVIGA (SKYM): ";
            }
            if(line) line.innerText = prompt + embeddedKeypad.buffer;
        }
    }

    function handleMgrKeyInput(key) {
        if (!embeddedKeypad.active) return;

        if (key === 'C') {
            embeddedKeypad.buffer = "";
        } else if (key === 'OK') {
            processMgrKeypadEnter();
        } else {
            embeddedKeypad.buffer += key;
        }
        updateMgrKeypadVisuals();
    }

    function processMgrKeypadEnter() {
        const val = embeddedKeypad.buffer;
        
        if (embeddedKeypad.mode === 'LOGIN') {
            if (embeddedKeypad.step === 1) {
                // Check ID
                const worker = db.employees.find(e => e.id === val);
                if (!worker) {
                    customAlert("Neznan delavec!");
                    embeddedKeypad.buffer = "";
                } else {
                    embeddedKeypad.tempId = worker.id;
                    embeddedKeypad.tempName = worker.name;
                    embeddedKeypad.tempWorker = worker;
                    embeddedKeypad.step = 2;
                    embeddedKeypad.buffer = "";
                }
            } else if (embeddedKeypad.step === 2) {
                // Finalize Login
                const cash = parseFloat(val);
                if (isNaN(cash)) { customAlert("Napaka!"); return; }
                
                currentUser = {
                    ...embeddedKeypad.tempWorker,
                    loginTime: new Date(),
                    startCash: cash,
                    sessionVoids: 0
                };
                db.cashInDrawer = cash;
                db.shiftLog.push({ type: 'LOGIN', user: currentUser.name, amount: cash, time: new Date() });
                logMgrAction(currentUser, "LOGGED IN TO REGISTER");
                saveDB(); saveSession(); updateStatusBar();
                
                // Reset UI
                embeddedKeypad.active = false;
                setMode('ARTICLES');
            }
        } else if (embeddedKeypad.mode === 'SKYM') {
            const amount = parseFloat(val);
            if (amount > db.cashInDrawer) { customAlert("Ni dovolj denarja!"); embeddedKeypad.buffer=""; }
            else {
                db.cashInDrawer -= amount;
                db.shiftLog.push({ type: 'SKYM', user: currentUser.name, amount: amount, time: new Date() });
                saveDB();
                customAlert("Odvzem zabele≈æen.");
                embeddedKeypad.active = false;
                managerSubMode = 'MAIN';
                renderButtons();
            }
        }
        updateMgrKeypadVisuals();
    }


    /* ================= LOGIKA BLAGAJNE ================= */
    
    function togglePOF() {
        isPOF = !isPOF;
        if (currentMode === 'ARTICLES') renderButtons();
    }
    
    function togglePOA() {
        db.settings.poa = !db.settings.poa;
        saveDB();
        renderButtons(); 
    }

    function toggleROF() {
        db.settings.rof = !db.settings.rof;
        saveDB();
        renderButtons(); 
    }

    function processArticleCode(code) {
        const art = db.articles.find(a => a.code === code);
        closeModal();
        if (art) {
            if (art.enabled) {
                addItem(art);
            } else {
                customAlert("Artikel s to ≈°ifro je onemogoƒçen!");
            }
        } else {
            customAlert("≈†ifra ne obstaja!");
        }
    }

    function addItem(article) {
        if (!timerRunning) startTimer();

        let newItem = {
            code: article.code, 
            name: article.name,
            price: article.price,
            originalPrice: article.price,
            qty: 1,
            isPromo: false,
            isVoid: false,
            isFinal: false,
            isMenu: article.isMenu,
            subItems: [],
            tasks: []
        };

        // MENU LOGIKA
        if (article.isMenu && article.subItems && article.subItems.length > 0) {
            newItem.subItems = JSON.parse(JSON.stringify(article.subItems)); // Deep copy
        }

        // POGOJ & TASK LOGIKA
        if (article.condition && activeCustomerId) {
            const tasks = db.customerTasks[activeCustomerId];
            if (tasks && tasks.length > 0) {
                newItem.tasks = tasks.map(t => ({ name: t, done: false }));
            }
        }

        currentReceipt.push(newItem);
        selectedItemIndex = currentReceipt.length - 1;
        renderReceipt();
        checkConditionPanel();
    }

    function getSelectedItem(silent = false) {
        if (selectedItemIndex < 0 || selectedItemIndex >= currentReceipt.length) {
            if(!silent) customAlert("Izberi artikel!");
            return null;
        }
        if (currentReceipt[selectedItemIndex].isVoid) {
            if(!silent) customAlert("Artikel je storniran!");
            return null;
        }
        return currentReceipt[selectedItemIndex];
    }

    /* --- FUNCTIONS BUTTONS --- */
    function fnQuantity() {
        const item = getSelectedItem();
        if (!item) return;
        showKeypad("Vnesi koliƒçino:", false, (val) => {
            const qty = parseInt(val);
            if (qty > 0) { item.qty = qty; renderReceipt(); }
            closeModal();
        });
    }

    function fnPromo() {
        const item = getSelectedItem();
        if (!item) return;
        requestAuthCode("Vnesi MGR/HOST kodo:", (user) => {
            item.isPromo = true;
            item.price = 0.00;
            // Promo also sets subitems to 0? Usually yes.
            if(item.subItems) item.subItems.forEach(s => s.price = 0);
            renderReceipt();
            closeModal();
        });
    }

    function fnVoid() {
        const item = getSelectedItem();
        if (!item) return;
        if (currentUser.sessionVoids >= 2) {
             requestAuthCode("Limit! Vnesi MGR/HOST kodo:", (user) => {
                 performVoid(item);
                 closeModal();
             });
        } else {
            performVoid(item);
            currentUser.sessionVoids++;
            saveSession();
        }
    }

    function performVoid(item) {
        item.isVoid = true;
        item.price = 0;
        if(item.subItems) item.subItems.forEach(s => s.price = 0);
        renderReceipt();
    }

    function fnDiscount() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "POPUST";
        content.innerHTML = `
            <h3>Izberi popust</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn" onclick="applyDiscount('USER')">üë§ ZAPOSLENI (-40%)</button>
                <button class="btn" onclick="applyDiscount('COIN')">ü™ô WII CEKIN (-70%)</button>
                <button class="btn" onclick="applyDiscount('CUSTOM')">‚úèÔ∏è ROƒåNI VNOS</button>
            </div>
            <br>
            <label><input type="checkbox" id="disc-all"> Na celoten raƒçun?</label>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    // NOVO: SCAN CARD
    function fnScanCard() {
        showKeypad("Skeniraj kartico stranke:", false, (id) => {
            // Preverimo ƒçe obstaja v Banki ali CustomerTasks
            const exists = (db.bankAccounts[id] !== undefined) || (db.customerTasks[id] !== undefined);
            
            if (exists) {
                activeCustomerId = id;
                showCardStatus(true);
            } else {
                activeCustomerId = null;
                showCardStatus(false);
            }
            saveSession();
            closeModal();
        });
    }

    window.applyDiscount = function(type) {
        const applyToAll = document.getElementById('disc-all').checked;
        if (type === 'USER') doDiscount(40, applyToAll);
        else if (type === 'COIN') doDiscount(70, applyToAll);
        else {
             showKeypad("Vnesi odstotek popusta:", false, (val) => {
                 doDiscount(parseInt(val), applyToAll);
                 closeModal();
             });
        }
    }

    function doDiscount(percent, applyToAll) {
        if (percent <= 0 || percent > 100) return;
        const factor = (100 - percent) / 100;
        if (applyToAll) {
            currentReceipt.forEach(i => { 
                if (!i.isVoid && !i.isPromo) {
                    i.price = i.originalPrice * factor; 
                    if(i.subItems) i.subItems.forEach(s => s.price = s.price * factor);
                }
            });
        } else {
            const item = getSelectedItem();
            if (item && !item.isPromo) {
                item.price = item.originalPrice * factor;
                if(item.subItems) item.subItems.forEach(s => s.price = s.price * factor);
            }
        }
        renderReceipt();
        closeModal();
    }

    function finishReceiptSequence() {
        if (currentReceipt.length === 0) return;
        
        const rId = db.receiptCounter++;
        saveDB(); 
        currentReceipt.forEach(i => i.isFinal = true);
        currentReceipt[currentReceipt.length-1].receiptId = rId;
        renderReceipt();
        stopTimer();

        let total = currentReceipt.reduce((acc, i) => acc + (i.price * i.qty), 0);
        // Add subitems totals
        currentReceipt.forEach(i => {
            if(i.subItems) i.subItems.forEach(s => total += (s.price * i.qty));
        });

        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "PLAƒåILO";
        content.innerHTML = `
            <h3>ZNESEK: ${formatMoney(total)}</h3>
            <button class="btn" style="height:60px" onclick="paymentCash(${total})">GOTOVINA</button>
            <br><br>
            <button class="btn" style="height:60px" onclick="paymentCard(${total})">KARTICA</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.paymentCash = function(total) {
        showKeypad("Vnesi prejeto gotovino:", false, (val) => {
            const received = parseFloat(val);
            const change = received - total;
            if (change < 0) { customAlert("Premalo denarja!"); return; }
            
            broadcastUpdate('CHANGE', { 
                change: change, 
                changeStr: formatMoney(change) 
            });

            customAlert(`VRAƒåILO: ${formatMoney(change)}`, () => {
                finalizeTransaction(total, 'CASH');
            });
        });
    }

    window.paymentCard = function(total) {
        // ƒåe je stranka ≈æe skenirana, uporabi ta ID
        if(activeCustomerId && db.bankAccounts[activeCustomerId] !== undefined) {
             processBankPaymentHelper(activeCustomerId, total);
        } else {
            showKeypad("Vnesi ID banke stranke:", false, (clientId) => {
                if (db.bankAccounts[clientId] === undefined) { customAlert("Stranka ne obstaja!"); return; }
                processBankPaymentHelper(clientId, total);
            });
        }
    }

    function processBankPaymentHelper(clientId, total) {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "BANKA";
        content.innerHTML = `
            <h3>Stranka: ${clientId}</h3>
            <p>Stanje: ${formatMoney(db.bankAccounts[clientId])}</p>
            <p>Za plaƒçilo: ${formatMoney(total)}</p>
            <button class="btn" style="height:50px; background:#8f8;" onclick="processBankPayment('${clientId}', ${total})">POTRDI PLAƒåILO</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.processBankPayment = function(id, amount) {
        if (db.bankAccounts[id] < amount) { customAlert("Ni kritja!"); return; }
        db.bankAccounts[id] -= amount;
        finalizeTransaction(amount, 'CARD');
    }

    function finalizeTransaction(amount, type) {
        closeModal();
        if (type === 'CASH') db.cashInDrawer += amount;
        
        const rId = currentReceipt[currentReceipt.length-1].receiptId;
        const receiptData = {
            id: rId,
            items: [...currentReceipt],
            total: amount,
            type: type,
            cashier: currentUser.name,
            time: new Date().toISOString()
        };

        db.receipts.push(receiptData);
        saveDB();
        
        broadcastUpdate('SUCCESS', { total: amount });

        if (db.settings.rof) {
            generateSingleReceiptPDF(receiptData);
        }

        currentReceipt = [];
        selectedItemIndex = -1;
        activeCustomerId = null; // Reset card logic
        document.getElementById('card-status-bar').className = '';
        document.getElementById('card-status-text').textContent = '';
        
        saveSession();
        renderReceipt();
        checkConditionPanel();
    }

    /* ================= MANAGER LOGIC ================= */
    
    // LOGIN & SKYM are handled by embedded keypad now in MAIN mode

    function mgrLogout() {
        if (!currentUser) return;
        const expected = db.cashInDrawer;
        const sessionReceipts = db.receipts.filter(r => new Date(r.time) >= new Date(currentUser.loginTime));
        const soldCount = sessionReceipts.length;

        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "ZAKLJUƒåEK";
        content.innerHTML = `
            <div style="text-align:left; font-size:14px;">
                Blagajnik: ${currentUser.name}<br>
                Priƒçakovano: ${formatMoney(expected)}<br>
                Raƒçunov: ${soldCount}
            </div>
            <br>
            <button class="btn" onclick="finalizeLogout(${expected})">VNESI DEJAN. STANJE</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.finalizeLogout = function(expected) {
        showKeypad("Dejansko stanje:", false, (val) => {
            const actual = parseFloat(val);
            db.shiftLog.push({ type: 'LOGOUT', user: currentUser.name, expected: expected, actual: actual, diff: actual-expected, time: new Date() });
            
            generateShiftPDF(currentUser, expected, actual);

            saveDB();
            currentUser = null;
            currentReceipt = [];
            stopTimer();
            localStorage.removeItem('wiiShopSession'); 
            updateStatusBar();
            closeModal();
            document.getElementById('main-display').innerHTML = '';
            
            // Reset Layout to grid if it was flex
            document.getElementById('main-display').style.display = 'grid';
        });
    }

    /* ================= PDF GENERATOR (SHIFT) ================= */
    function generateShiftPDF(user, expected, actual) {
        if (!window.jspdf) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [57, 2000] });

        doc.setFont("courier", "bold");
        doc.setFontSize(9);
        let y = 10;
        const margin = 2;
        const lineH = 4;

        function addLine(text) { doc.text(cleanStr(text), margin, y); y += lineH; }
        function addSeparator() { addLine("****************************"); }

        const now = new Date();
        const dateStr = now.toLocaleDateString('sl-SI') + " " + now.toLocaleTimeString('sl-SI');
        
        const sessionReceipts = db.receipts.filter(r => new Date(r.time) >= new Date(user.loginTime));
        const countTotal = sessionReceipts.length;
        const countCash = sessionReceipts.filter(r => r.type === 'CASH').length;
        const countCard = sessionReceipts.filter(r => r.type === 'CARD').length;

        doc.setFontSize(11);
        addLine("IZPIS BLAGAJNE:");
        doc.setFontSize(9);
        addSeparator();
        
        addLine(`Id blagajnika: ${user.id}`);
        addLine(`Blagajnik: ${user.name}`);
        addLine(`Datum: ${dateStr}`);
        addSeparator();
        addLine(`Zacetni depozit: ${formatMoney(user.startCash)}`);
        addLine(`Gotovina konec: ${formatMoney(expected)}`);
        addSeparator();
        addLine(`Stevilo racunov: ${countTotal}`);
        addLine(`Gotovinski: ${countCash}`);
        addLine(`Karticni: ${countCard}`);
        addSeparator();
        
        doc.setFontSize(11);
        addLine("IZPIS RACUNOV:");
        doc.setFontSize(8);

        if (sessionReceipts.length === 0) {
            addLine("(Ni racunov v tej izmeni)");
        } else {
            sessionReceipts.forEach(rec => {
                y += 2;
                addLine(`RACUN #${rec.id} (${rec.time.split('T')[1].slice(0,5)})`);
                addLine(`Nacin: ${rec.type}`);
                rec.items.forEach(item => {
                    let name = item.name;
                    if(item.isVoid) name = "[X] " + name;
                    else if(item.isPromo) name = "[P] " + name;
                    
                    if(item.qty > 1) {
                         addLine(` ${item.qty}x ${name}`);
                         addLine(`   = ${formatMoney(item.price*item.qty)}`);
                    } else {
                         addLine(` ${name} ${formatMoney(item.price)}`);
                    }
                });
                addLine(`SKUPAJ: ${formatMoney(rec.total)}`);
                addLine("----------------------------");
            });
        }
        doc.save(`zakljucek_${user.id}_${now.getTime()}.pdf`);
    }

    /* ================= PDF GENERATOR (SINGLE RECEIPT - ROF) ================= */
    function generateSingleReceiptPDF(rec) {
        if (!window.jspdf) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [57, 200] });

        doc.setFont("courier", "bold");
        doc.setFontSize(9);
        let y = 10;
        const margin = 2;
        const lineH = 4;

        function addLine(text) { doc.text(cleanStr(text), margin, y); y += lineH; }
        
        const dateObj = new Date(rec.time);
        const dateStr = dateObj.toLocaleDateString('sl-SI') + " " + dateObj.toLocaleTimeString('sl-SI');

        doc.setFontSize(12);
        addLine("WII SHOP CHANNEL");
        doc.setFontSize(9);
        addLine("----------------------------");
        addLine(`RACUN #${rec.id}`);
        addLine(`Datum: ${dateStr}`);
        addLine(`Blagajnik: ${cleanStr(rec.cashier)}`);
        addLine("----------------------------");

        rec.items.forEach(item => {
            let name = item.name;
            if(item.isVoid) name = "[X] " + name;
            else if(item.isPromo) name = "[P] " + name;
            
            if(item.qty > 1) {
                 addLine(`${item.qty}x ${name}`);
                 addLine(`   ${formatMoney(item.price*item.qty)}`);
            } else {
                 addLine(`${name}`);
                 addLine(`   ${formatMoney(item.price)}`);
            }
            if(item.subItems) {
                item.subItems.forEach(s => addLine(` - ${cleanStr(s.name)}`));
            }
        });

        addLine("----------------------------");
        doc.setFontSize(11);
        addLine(`ZA PLACILO: ${formatMoney(rec.total)}`);
        doc.setFontSize(9);
        addLine(`Nacin placila: ${rec.type}`);
        addLine("----------------------------");
        addLine("Hvala za nakup!");
        addLine("Se vidimo!");

        doc.save(`racun_${rec.id}.pdf`);
    }


    function mgrInterim() { customAlert(`TRENUTNO STANJE: ${formatMoney(db.cashInDrawer)}`); }
    
    function mgrStorno() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "STORNO";
        let html = '<div class="modal-list">';
        db.receipts.slice(-10).reverse().forEach((r, idx) => {
             html += `<div class="modal-list-item" onclick="processStorno(${r.id})"><span>#${r.id} (${formatMoney(r.total)})</span> <button class="list-btn-action">STORNO</button></div>`;
        });
        html += '</div>';
        content.innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    window.processStorno = function(id) {
        customConfirm(`Storniraj raƒçun #${id}?`, () => {
            const rIndex = db.receipts.findIndex(r => r.id === id);
            if (rIndex > -1) {
                const r = db.receipts[rIndex];
                if (r.type === 'CASH') db.cashInDrawer -= r.total;
                db.receipts.splice(rIndex, 1);
                saveDB();
                customAlert("Stornirano!");
                closeModal();
            }
        });
    }

    /* --- MANAGER DOLOƒåI OPRAVILA (NOVO) --- */
    function mgrTasks() {
        showKeypad("Vnesi ID stranke:", false, (id) => {
             openTaskEditor(id);
        });
    }

    function openTaskEditor(id) {
        const existing = db.customerTasks[id] || [];
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "OPRAVILA";
        
        let taskText = existing.join('\n');
        
        content.innerHTML = `
            <h3>Stranka: ${id}</h3>
            <p>Vnesi opravila (vsako v svojo vrstico):</p>
            <textarea id="task-area" style="width:100%; height:150px; font-size:16px;">${taskText}</textarea>
            <button class="btn" style="width:100%; margin-top:10px" onclick="saveTasks('${id}')">SHRANI</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.saveTasks = function(id) {
        const text = document.getElementById('task-area').value;
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        db.customerTasks[id] = lines;
        saveDB();
        closeModal();
        customAlert("Opravila shranjena.");
    }

    /* --- MANAGER PRODAJA (NOVO) --- */
    function mgrSales() {
        if (!currentUser) return;
        const sessionReceipts = db.receipts.filter(r => new Date(r.time) >= new Date(currentUser.loginTime) && r.cashier === currentUser.name);
        const total = sessionReceipts.reduce((acc, r) => acc + r.total, 0);

        customAlert(`
            BLAGAJNIK: ${currentUser.name}
            ----------------
            SKUPAJ PRODAJA: ${formatMoney(total)}
            ≈†T. RAƒåUNOV: ${sessionReceipts.length}
        `);
    }


    /* --- MANAGER ZAPOSLENI (FULL) --- */
    function mgrEmployees() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "ZAPOSLENI";
        content.innerHTML = `
            <h3>UREJANJE ZAPOSLENIH</h3>
            <button class="btn" style="width:100%; margin-bottom:10px" onclick="addNewEmployeeStep1()">+ DODAJ NOVEGA</button>
            <div class="modal-list" id="emp-list"></div>
        `;
        
        const list = document.getElementById('emp-list');
        db.employees.forEach((emp, idx) => {
            const div = document.createElement('div');
            div.className = 'modal-list-item';
            div.innerHTML = `<span>${emp.id} - ${emp.name} (${emp.role})</span> <span style="font-size:10px">UREDI</span>`;
            div.onclick = () => editEmployee(idx);
            list.appendChild(div);
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.addNewEmployeeStep1 = function() {
        showKeypad("Vnesi ID (≈°tevilka):", false, (id) => {
            if (db.employees.find(e => e.id === id)) { customAlert("ID ≈æe obstaja!"); return; }
            showKeyboard("Vnesi IME in PRIIMEK:", (name) => {
                const content = document.getElementById('modal-content');
                document.getElementById('modal-title').innerText = "VLOGA";
                content.innerHTML = `
                    <h3>Izberi vlogo za ${name}:</h3>
                    <button class="btn" style="width:100%; margin:5px 0" onclick="addNewEmployeeStep2('${id}', '${name}', 'ZAPOSLENI')">ZAPOSLENI</button>
                    <button class="btn" style="width:100%; margin:5px 0" onclick="addNewEmployeeStep2('${id}', '${name}', 'MANAGER')">MANAGER</button>
                    <button class="btn" style="width:100%; margin:5px 0; background:#fcc" onclick="addNewEmployeeStep2('${id}', '${name}', 'HOST')">HOST</button>
                `;
            });
        });
    }

    window.addNewEmployeeStep2 = function(id, name, role) {
        showKeypad("Doloƒçi osebno kodo:", true, (code) => {
            db.employees.push({ id, name, role, code });
            saveDB();
            customAlert(`Zaposleni dodan z vlogo: ${role}`, () => {
                mgrEmployees();
            });
        });
    }

    window.editEmployee = function(idx) {
        const emp = db.employees[idx];
        customConfirm(`≈Ωeli≈° izbrisati zaposlenega ${emp.name}?`, () => {
            if(emp.id === '000') { customAlert("Administratorja ne more≈° izbrisati!"); return; }
            db.employees.splice(idx, 1);
            saveDB();
            mgrEmployees();
        });
    }

    /* --- MANAGER ARTIKLI (UPDATED FOR MENU & CONDITION) --- */
    function mgrArticles() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "ARTIKLI";
        
        let html = '<h3>UREJANJE ARTIKLOV</h3>';
        html += '<button class="btn" style="width:100%; margin-bottom:10px" onclick="addNewArticle()">+ DODAJ ARTIKEL</button>';
        
        html += '<div class="modal-list">';
        db.articles.forEach((art, idx) => {
            const style = art.enabled ? '' : 'text-decoration:line-through; color:red;';
            const menuTag = art.isMenu ? ' [MENU]' : '';
            html += `<div class="modal-list-item" style="${style}" onclick="editArticle(${idx})">
                        <span>[${art.code}] ${art.name}${menuTag}</span>
                        <span>${formatMoney(art.price)}</span>
                     </div>`;
        });
        html += '</div>';
        content.innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.addNewArticle = function() {
        showKeypad("Vnesi ≈†IFRO artikla (npr. 50):", false, (code) => {
             if (db.articles.find(a => a.code === code)) { customAlert("≈†ifra ≈æe obstaja!"); return; }
             
             showKeyboard("Ime artikla:", (name) => {
                showKeypad("Cena artikla (npr. 1.50):", false, (priceVal) => {
                    const price = parseFloat(priceVal);
                    // Ask for Type
                    const content = document.getElementById('modal-content');
                    content.innerHTML = `
                        <h3>Tip artikla: ${name}</h3>
                        <button class="btn" style="width:100%; margin:5px 0" onclick="finishAddArticle('${code}','${name}',${price}, false)">NAVADEN</button>
                        <button class="btn" style="width:100%; margin:5px 0" onclick="finishAddArticle('${code}','${name}',${price}, true)">MENU</button>
                    `;
                });
            });
        });
    }

    window.finishAddArticle = function(code, name, price, isMenu) {
        const newArt = { 
            name: name.toUpperCase(), 
            price: price, 
            enabled: true, 
            code: code,
            isMenu: isMenu,
            subItems: [],
            condition: false
        };
        db.articles.push(newArt);
        saveDB();
        if(isMenu) {
            editArticle(db.articles.length - 1); // Go straight to edit to add subitems
        } else {
            mgrArticles();
        }
    }

    window.editArticle = function(idx) {
        const art = db.articles[idx];
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "UREDI";
        content.innerHTML = `
            <h3>${art.name} ${art.isMenu ? '(MENU)' : ''}</h3>
            <p>≈†ifra: ${art.code} | Cena: ${formatMoney(art.price)}</p>
            <button class="btn" style="width:100%; margin:5px 0" onclick="changeArtCode(${idx})">SPREMENI ≈†IFRO</button>
            <button class="btn" style="width:100%; margin:5px 0" onclick="changeArtPrice(${idx})">SPREMENI CENO</button>
            <button class="btn" style="width:100%; margin:5px 0" onclick="toggleArtStatus(${idx})">${art.enabled ? 'ONEMOGOƒåI' : 'OMOGOƒåI'}</button>
            <button class="btn" style="width:100%; margin:5px 0; ${art.condition?'background:#8f8':''}" onclick="toggleArtCondition(${idx})">POGOJI: ${art.condition ? 'DA' : 'NE'}</button>
            ${art.isMenu ? `<button class="btn" style="width:100%; margin:5px 0; background:#fffacd" onclick="editSubItems(${idx})">UREDI PODARTIKLE</button>` : ''}
            <button class="btn" style="width:100%; margin:5px 0; background:#ffcccc" onclick="deleteArt(${idx})">IZBRI≈†I</button>
            <button class="btn" style="width:100%; margin:20px 0" onclick="mgrArticles()">NAZAJ</button>
        `;
    }

    window.editSubItems = function(idx) {
        const art = db.articles[idx];
        const content = document.getElementById('modal-content');
        let html = `<h3>Podartikli: ${art.name}</h3><div class="modal-list">`;
        art.subItems.forEach((sub, sIdx) => {
            html += `<div class="modal-list-item"><span>${sub.name} (+${formatMoney(sub.price)})</span> <button class="list-btn-action" onclick="delSubItem(${idx}, ${sIdx})">X</button></div>`;
        });
        html += `</div>`;
        if (art.subItems.length < 5) {
            html += `<button class="btn" style="width:100%; margin-top:10px" onclick="addSubItem(${idx})">+ DODAJ PODARTIKEL</button>`;
        } else {
            html += `<p>Max 5 podartiklov!</p>`;
        }
        html += `<button class="btn" style="width:100%; margin-top:10px" onclick="editArticle(${idx})">NAZAJ</button>`;
        content.innerHTML = html;
    }

    window.addSubItem = function(idx) {
        showKeyboard("Ime podartikla:", (name) => {
             showKeypad("Doplaƒçilo (0 ƒçe ni):", false, (val) => {
                 db.articles[idx].subItems.push({ name: name.toUpperCase(), price: parseFloat(val) });
                 saveDB();
                 editSubItems(idx);
             });
        });
    }

    window.delSubItem = function(idx, sIdx) {
        db.articles[idx].subItems.splice(sIdx, 1);
        saveDB();
        editSubItems(idx);
    }

    window.toggleArtCondition = function(idx) {
        db.articles[idx].condition = !db.articles[idx].condition;
        saveDB();
        editArticle(idx);
    }

    window.changeArtCode = function(idx) {
        showKeypad("Nova ≈°ifra:", false, (val) => {
            if (db.articles.find(a => a.code === val)) { customAlert("≈†ifra ≈æe obstaja!"); return; }
            db.articles[idx].code = val;
            saveDB();
            editArticle(idx);
        });
    }

    window.changeArtPrice = function(idx) {
        showKeypad("Nova cena:", false, (val) => {
            db.articles[idx].price = parseFloat(val);
            saveDB();
            editArticle(idx);
        });
    }
    window.toggleArtStatus = function(idx) {
        db.articles[idx].enabled = !db.articles[idx].enabled;
        saveDB();
        editArticle(idx);
    }
    window.deleteArt = function(idx) {
        customConfirm("Res izbri≈°em ta artikel?", () => {
            db.articles.splice(idx, 1);
            saveDB();
            mgrArticles();
        });
    }

    /* --- MANAGER ZGODOVINA (MGR) --- */
    function mgrShowHistory() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "MGR ZGODOVINA";
        
        let html = '<div class="modal-list">';
        // Prikaz zadnjih vnosov
        if(db.mgrHistory.length === 0) {
            html += '<div style="padding:10px; text-align:center;">Prazna zgodovina</div>';
        } else {
            db.mgrHistory.forEach(entry => {
                const date = new Date(entry.time);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                html += `
                    <div class="modal-list-item" style="display:block">
                        <div style="font-weight:bold; font-size:12px">${dateStr}</div>
                        <div>${entry.user} (${entry.role})</div>
                        <div style="font-size:11px; color:#555">${entry.action}</div>
                    </div>
                `;
            });
        }
        html += '</div>';
        content.innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }


    /* --- BANKA --- */
    function mgrBank() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "BANKA";
        content.innerHTML = `
            <h3>BANKA</h3>
            <button class="btn" onclick="bankNewClient()">NOVA STRANKA</button>
            <br><br>
            <button class="btn" onclick="bankEditClient()">TRANSAKCIJA</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    window.bankNewClient = function() {
        showKeypad("ID nove stranke:", false, (id) => {
            if (db.bankAccounts[id] !== undefined) { customAlert("Obstaja!"); return; }
            showKeypad("Polog:", false, (val) => {
                db.bankAccounts[id] = parseFloat(val);
                saveDB();
                customAlert("Odprto!");
                closeModal();
            });
        });
    }
    window.bankEditClient = function() {
        showKeypad("ID stranke:", false, (id) => {
            if (db.bankAccounts[id] === undefined) { customAlert("Ni stranke!"); return; }
            showKeypad(`Stanje: ${formatMoney(db.bankAccounts[id])}\nZnesek (+/-):`, false, (val) => {
                db.bankAccounts[id] += parseFloat(val);
                saveDB();
                customAlert("Novo stanje: " + formatMoney(db.bankAccounts[id]));
                closeModal();
            });
        });
    }

    /* ================= KEYPAD & KEYBOARD SYSTEM ================= */
    let inputCallback = null;

    // NUMERIƒåNA
    function showKeypad(title, isSecret, callback) {
        inputCallback = callback;
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-overlay').style.display = 'flex';
        
        content.innerHTML = `
            <div id="kp-display" class="input-display"></div>
            <div class="keypad-grid">
                <button class="keypad-btn" onclick="kpIn('7')">7</button>
                <button class="keypad-btn" onclick="kpIn('8')">8</button>
                <button class="keypad-btn" onclick="kpIn('9')">9</button>
                <button class="keypad-btn" onclick="kpIn('4')">4</button>
                <button class="keypad-btn" onclick="kpIn('5')">5</button>
                <button class="keypad-btn" onclick="kpIn('6')">6</button>
                <button class="keypad-btn" onclick="kpIn('1')">1</button>
                <button class="keypad-btn" onclick="kpIn('2')">2</button>
                <button class="keypad-btn" onclick="kpIn('3')">3</button>
                <button class="keypad-btn" onclick="kpIn('.')">.</button> 
                <button class="keypad-btn" onclick="kpIn('0')">0</button>
                <button class="keypad-btn" style="background:#faa" onclick="kpIn('C')">C</button>
            </div>
            <button class="btn" style="width:100%; margin-top:10px; height:40px; background:#8f8" onclick="submitInput()">POTRDI</button>
        `;
        content.dataset.secret = isSecret; 
        content.dataset.value = "";
    }

    // ALFANUMERIƒåNA (QWERTY poenostavljena)
    function showKeyboard(title, callback) {
        inputCallback = callback;
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-overlay').style.display = 'flex';

        const keys = "QWERTYUIOPASDFGHJKLZXCVBNM".split('');
        let keysHtml = '';
        keys.forEach(k => { keysHtml += `<button class="kb-btn" onclick="kpIn('${k}')">${k}</button>`; });
        
        content.innerHTML = `
            <div id="kp-display" class="input-display" style="justify-content:flex-start; font-size:18px"></div>
            <div class="keyboard-grid">
                ${keysHtml}
                <button class="kb-btn kb-btn-wide" onclick="kpIn('SPACE')">_</button>
                <button class="kb-btn kb-btn-wide" style="background:#faa" onclick="kpIn('BACK')">DEL</button>
            </div>
            <button class="btn" style="width:100%; margin-top:10px; height:40px; background:#8f8" onclick="submitInput()">POTRDI</button>
        `;
        content.dataset.secret = false;
        content.dataset.value = "";
    }

    window.kpIn = function(val) {
        const content = document.getElementById('modal-content');
        if (document.getElementById('modal-overlay').style.display === 'none') return;
        
        let current = content.dataset.value || "";
        
        if (val === 'C') current = "";
        else if (val === 'BACK') current = current.slice(0, -1);
        else if (val === 'SPACE') current += " ";
        else current += val;

        content.dataset.value = current;
        
        const display = document.getElementById('kp-display');
        if(display) {
            if (content.dataset.secret === 'true') display.textContent = "*".repeat(current.length);
            else display.textContent = current;
        }
    }

    window.submitInput = function() {
        const val = document.getElementById('modal-content').dataset.value;
        if (inputCallback) inputCallback(val);
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    
    function requestAuthCode(title, cb) {
        showKeypad(title, true, (code) => {
            const u = db.employees.find(e => e.code === code);
            if(u && (u.role==='MANAGER'||u.role==='HOST')) { 
                closeModal(); 
                cb(u); 
            } else { 
                customAlert("Napaƒçna koda!"); 
            }
        });
    }

    /* ================= SCANNER & KEYBOARD HANDLER ================= */
    let barcodeBuffer = "";
    let barcodeTimer = null;

    document.addEventListener('keydown', (e) => {
        // Ignoriraj posebne kombinacije
        if (e.ctrlKey || e.altKey || e.metaKey) return;

        const isModalOpen = document.getElementById('modal-overlay').style.display === 'flex';

        // 1. ZAZNAVANJE "ENTER"
        if (e.key === 'Enter') {
            if (barcodeBuffer.length > 0) {
                e.preventDefault();
                handleBarcodeScan(barcodeBuffer);
                barcodeBuffer = "";
                return;
            } else if (isModalOpen) {
                submitInput();
                return;
            }
        }

        // 2. ZBIRANJE ZNAKOV
        if (e.key.length === 1) {
            barcodeBuffer += e.key;
            clearTimeout(barcodeTimer);
            barcodeTimer = setTimeout(() => {
                barcodeBuffer = "";
            }, 200);
        }

        // 3. ROƒåNI VNOS
        if (isModalOpen) {
            if (e.key >= '0' && e.key <= '9') kpIn(e.key);
            if (e.key === 'Backspace') kpIn('BACK');
        } 
        // 4. ROƒåNI BLI≈ΩNJICA ZA ARTIKLE
        else if (currentMode === 'ARTICLES' && barcodeBuffer.length <= 1) {
             if (e.key >= '0' && e.key <= '9') {
                 showKeypad("Vnesi ≈°ifro artikla:", false, (val) => processArticleCode(val));
                 kpIn(e.key);
             }
        }
        // 5. MANAGER KEYPAD
        else if (currentMode === 'MANAGER' && managerSubMode === 'MAIN' && embeddedKeypad.active) {
            if (e.key >= '0' && e.key <= '9') handleMgrKeyInput(e.key);
            if (e.key === 'c' || e.key === 'C') handleMgrKeyInput('C');
            if (e.key === 'Enter') handleMgrKeyInput('OK');
        }
    });

    function handleBarcodeScan(code) {
        const isModalOpen = document.getElementById('modal-overlay').style.display === 'flex';
        
        if (isModalOpen) {
            const content = document.getElementById('modal-content');
            content.dataset.value = code;
            
            const display = document.getElementById('kp-display');
            if(display) {
                if (content.dataset.secret === 'true') display.textContent = "*".repeat(code.length);
                else display.textContent = code;
            }
            setTimeout(submitInput, 50);
        } else {
            if (currentMode === 'ARTICLES') {
                processArticleCode(code);
            } else if (currentMode === 'FUNCTIONS') {
                // ƒåe smo v funkcijah in skeniramo kartico
                const exists = (db.bankAccounts[code] !== undefined) || (db.customerTasks[code] !== undefined);
                if (exists) {
                    activeCustomerId = code;
                    showCardStatus(true);
                } else {
                    activeCustomerId = null;
                    showCardStatus(false);
                }
                saveSession();
            } else {
                console.log("Skenirano v napaƒçnem naƒçinu: " + code);
            }
        }
    }

    loadSession();
    updateStatusBar();
</script>
</body>
</html>
