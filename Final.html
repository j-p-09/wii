<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WII SHOP BLAGAJNA v9 (FINAL + TASKS + MANAGER REWORK)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #e0e0e0;
            --main-border: 2px solid #000;
            --double-border: 4px double #000;
            --highlight-yellow: #fffacd; 
            --promo-red: #d00000;
            --task-red: #d00000;
            --task-green: #008000;
            --font-main: Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: var(--font-main);
            background-color: #888;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            border: var(--main-border);
        }

        /* --- LEVA STRAN: RAƒåUN --- */
        #left-panel {
            width: 33.33%;
            border-right: var(--main-border);
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        #receipt-header {
            padding: 5px;
            text-align: center;
            border-bottom: 1px solid #000;
            font-weight: bold;
            background: #ccc;
            font-size: 14px;
        }

        #card-status-bar {
            height: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: var(--double-border);
            display: none; /* Skrito, dokler ni kartice */
        }
        .card-ok { background-color: var(--highlight-yellow); color: #000; }
        .card-wrong { background-color: #ffcccc; color: red; }

        #receipt-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
        }

        .receipt-item {
            display: flex;
            flex-direction: column;
            padding: 4px 0;
            cursor: pointer;
            border-bottom: 1px dotted #ccc;
        }
        
        .ri-main { display: flex; justify-content: space-between; }
        .ri-sub { font-size: 11px; padding-left: 10px; color: #555; }
        .ri-task { font-size: 11px; padding-left: 10px; font-weight: bold; }

        .receipt-item.selected { background-color: var(--highlight-yellow); }
        .receipt-item.promo .ri-main { color: var(--promo-red); font-weight: bold; }
        .receipt-item.voided { text-decoration: line-through; color: #888; }
        
        .task-pending { color: var(--task-red); }
        .task-done { color: var(--task-green); }

        #receipt-footer {
            border-top: var(--double-border);
            padding: 10px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            background: #eee;
        }

        /* --- DESNA STRAN --- */
        #right-panel {
            width: 66.66%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
        }

        #status-bar-container {
            padding: 10px 20px;
            border-bottom: var(--main-border);
            height: 60px;
        }

        .status-label {
            font-size: 12px;
            margin-bottom: 2px;
            text-transform: uppercase;
            font-weight: bold;
            color: #444;
        }

        /* Tabela statusa (ID, Ime, Timer) */
        .status-table {
            width: 100%;
            border: 3px solid #000;
            display: flex;
            height: 35px;
            background: #fff;
        }
        .st-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border-right: 2px solid #000;
        }
        .st-id { width: 15%; }
        .st-name { width: 70%; text-transform: uppercase;}
        .st-timer { width: 15%; border-right: none; }
        .logged-out .st-id, .logged-out .st-name { background-color: #ddd; color: transparent; }

        /* Vrstica z opravili (zamenja status tabelo) */
        #task-bar {
            width: 100%;
            height: 40px;
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }
        .task-btn {
            flex: 1;
            background: #ffcccc;
            border: 2px solid #000;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            padding: 0 10px;
        }
        .task-btn.done { background: #ccffcc; }

        /* GUMBI */
        #main-display {
            flex-grow: 1;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            grid-auto-rows: 1fr;
            gap: 8px;
            overflow-y: auto;
            position: relative;
        }

        /* MANAGER DISPLAY LAYOUT */
        .mgr-layout {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Gumbi levo, Keypad desno/spodaj */
            gap: 10px;
            height: 100%;
            width: 100%;
        }
        .mgr-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 80px;
            gap: 8px;
            align-content: start;
        }
        .mgr-keypad-container {
            display: flex;
            flex-direction: column;
            border-left: 2px solid #999;
            padding-left: 10px;
            justify-content: flex-end;
        }

        /* EMBEDDED KEYPAD (MANAGER) */
        #mgr-kp-screen {
            background: #000;
            color: #0f0;
            font-family: monospace;
            height: 30px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            padding: 5px;
            font-size: 16px;
        }
        #mgr-kp-label {
            font-size: 10px; color: #fff; background: #333; padding: 2px; margin-bottom: 2px;
        }
        .mgr-kp-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        .mkp-btn {
            height: 40px;
            background: #222; /* Disabled look by default */
            color: #555;
            font-weight: bold;
            border: 2px solid #000;
            font-size: 18px;
        }
        .mkp-btn.active {
            background: #fff;
            color: #000;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
        }
        .mkp-btn.active:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #000; }


        .btn {
            background: #f0f0f0;
            border: 1px solid #999;
            box-shadow: 3px 3px 0px #000;
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2px;
            transition: all 0.1s;
        }

        .btn:active {
            box-shadow: 1px 1px 0px #000;
            transform: translate(2px, 2px);
        }

        .btn-grey { background: #ccc; color: #666; }
        .btn-red { background: #ffcccc; }
        .btn-green { background: #ccffcc; }
        .btn-search { background: #fffacd; border: 2px solid #555; font-size: 16px; } 
        .btn-nav { background: #333; color: white; border-color: #000; box-shadow: none; border-right: 1px solid #555; }

        /* NAVIGACIJA */
        #nav-bar {
            height: 60px;
            border-top: var(--main-border);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            background: #333;
        }

        /* --- MODALNA OKNA --- */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: #e0e0e0;
            border: var(--double-border);
            padding: 4px;
            width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 15px 15px 0 #000;
        }

        .modal-header {
            background: #000;
            color: #fff;
            padding: 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .modal-body {
            padding: 15px;
            text-align: center;
            overflow-y: auto;
        }

        /* DISPLAY ZA VNOS (Modal) */
        .input-display {
            width: 100%;
            height: 40px;
            background: #fff;
            border: 2px inset #000;
            margin-bottom: 10px;
            font-size: 24px;
            text-align: right; 
            padding: 5px;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* ≈†TEVILƒåNICA (Modal) */
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .keypad-btn {
            height: 50px;
            font-size: 20px;
            background: #fff;
            border: 1px solid #000;
            box-shadow: 2px 2px 0 #000;
            cursor: pointer;
        }
        .keypad-btn:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #000; }

        /* TIPKOVNICA ZA BESEDILO (QWERTY) */
        .keyboard-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
        }
        .kb-btn {
            width: 40px; height: 40px;
            font-size: 16px;
            font-weight: bold;
            background: #fff;
            border: 1px solid #000;
            box-shadow: 2px 2px 0 #000;
            cursor: pointer;
        }
        .kb-btn-wide { width: 85px; }

        /* LISTE V MODALU */
        .modal-list {
            text-align: left;
            border: 1px solid #000;
            background: #fff;
            max-height: 300px;
            overflow-y: auto;
        }
        .modal-list-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-list-item:hover { background: #ffffd0; }
        .list-btn-action { font-size: 10px; padding: 2px 5px; background: #eee; border: 1px solid #000; margin-left:5px; }
        
        /* CUSTOM ALERT TEXT */
        .msg-text { font-size: 18px; margin: 20px 0; line-height: 1.4; }

    </style>
</head>
<body>

<div id="app-container">
    <div id="left-panel">
        <div id="receipt-header">RAƒåUN #<span id="receipt-num">----</span></div>
        <div id="card-status-bar"></div> <div id="receipt-body"></div>
        <div id="receipt-footer">
            <span>SKUPAJ:</span>
            <span id="total-amount">0.00 WII</span>
        </div>
    </div>

    <div id="right-panel">
        <div id="status-bar-container">
            <div id="default-status-bar">
                <div class="status-label" id="status-label-text">ODJAVLJENA BLAGAJNA</div>
                <div class="status-table logged-out" id="status-table">
                    <div class="st-cell st-id" id="disp-id">000</div>
                    <div class="st-cell st-name" id="disp-name">ADMINISTRATOR</div>
                    <div class="st-cell st-timer" id="disp-timer">0:00</div>
                </div>
            </div>
            <div id="task-bar" style="display:none;"></div>
        </div>

        <div id="main-display"></div>

        <div id="nav-bar">
            <button class="btn btn-nav" onclick="setMode('ARTICLES')">ARTIKLI</button>
            <button class="btn btn-nav" onclick="setMode('FUNCTIONS')">FUNKCIJE</button>
            <button class="btn btn-nav" onclick="setMode('FINISH')">ZAKLJUƒåEK</button>
            <button class="btn btn-nav" onclick="setMode('MANAGER')">MANAGER</button>
            <button class="btn btn-nav" onclick="togglePOF()">P.O.F</button>
        </div>
    </div>
</div>

<div id="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <span id="modal-title">VNOS</span>
            <span style="cursor:pointer" onclick="closeModal()">‚úï</span>
        </div>
        <div class="modal-body" id="modal-content"></div>
    </div>
</div>

<script>
    /* ================= BROADCAST SYSTEM ================= */
    const displayChannel = new BroadcastChannel('wii_shop_display');
    function broadcastUpdate(type, data) {
        displayChannel.postMessage({ type: type, payload: data });
    }

    /* ================= DATA STRUCTURE ================= */
    // Version v9
    const defaultData = {
        employees: [
            { id: '000', name: 'ADMINISTRATOR', role: 'MANAGER', code: '000' }
        ],
        articles: [
            // type: 'NORMAL' ali 'MENU'
            // subItems: [{name, price}]
            // hasCondition: bool (za pogoj/opravila)
            { name: 'KARTA', price: 10.00, enabled: true, code: "48392", type: 'NORMAL', subItems: [], hasCondition: false },
            { name: 'OSTALO', price: 0.01, enabled: true, code: "12", type: 'NORMAL', subItems: [], hasCondition: false }
        ],
        bankAccounts: {}, // ID: Amount
        customerTasks: {}, // ID: [ "Opravilo 1", "Opravilo 2" ]
        receipts: [],
        receiptCounter: 1000,
        cashInDrawer: 0.00,
        shiftLog: [],
        mgrHistory: [], 
        settings: { poa: true, rof: false }
    };

    let db = JSON.parse(localStorage.getItem('wiiShopDBv9')) || defaultData;
    
    // Migracija podatkov (ƒçe manjkajo nova polja)
    if(!db.customerTasks) db.customerTasks = {};
    db.articles.forEach(a => {
        if(!a.type) a.type = 'NORMAL';
        if(!a.subItems) a.subItems = [];
        if(a.hasCondition === undefined) a.hasCondition = false;
    });

    function saveDB() { localStorage.setItem('wiiShopDBv9', JSON.stringify(db)); }

    /* ================= STATE ================= */
    let currentUser = null; 
    let currentReceipt = []; 
    let selectedItemIndex = -1;
    let timerInterval = null;
    let timerSeconds = 0;
    let timerRunning = false;
    let isPOF = false; 
    let currentMode = 'ARTICLES';
    let activeManagerMenu = null; 
    
    let currentCardId = null; // Skenirana kartica
    let cardMessageTimer = null;

    /* --- Manager Keypad State --- */
    let mgrKpActive = false;
    let mgrKpBuffer = "";
    let mgrKpMode = null; // 'LOGIN', 'SKYM', 'STORNO'
    let mgrKpStep = 0; 
    let mgrKpTempData = {};

    function saveSession() {
        const session = {
            user: currentUser,
            receipt: currentReceipt,
            timer: timerSeconds,
            mode: currentMode,
            cardId: currentCardId
        };
        localStorage.setItem('wiiShopSession', JSON.stringify(session));
    }

    function loadSession() {
        const saved = JSON.parse(localStorage.getItem('wiiShopSession'));
        if (saved && saved.user) {
            currentUser = saved.user;
            currentReceipt = saved.receipt || [];
            timerSeconds = saved.timer || 0;
            currentCardId = saved.cardId || null;
            currentMode = 'ARTICLES'; 
            updateStatusBar();
            if(currentCardId) showCardStatus(currentCardId, true);
            renderReceipt();
            if (currentReceipt.length > 0) startTimer();
            renderButtons();
        }
    }

    /* ================= UTILS ================= */
    function formatMoney(amount) {
        return parseFloat(amount).toFixed(2) + " WII";
    }
    
    function cleanStr(str) {
        if(!str) return "";
        return str.toString()
            .replace(/ƒç/g, 'c').replace(/ƒå/g, 'C')
            .replace(/≈°/g, 's').replace(/≈†/g, 'S')
            .replace(/≈æ/g, 'z').replace(/≈Ω/g, 'Z');
    }

    function logMgrAction(user, action) {
        if(!db.mgrHistory) db.mgrHistory = [];
        db.mgrHistory.unshift({
            time: new Date(),
            user: user ? user.name : 'Unknown',
            role: user ? user.role : '?',
            action: action
        });
        if(db.mgrHistory.length > 100) db.mgrHistory.pop();
        saveDB();
    }

    /* ================= TIMER ================= */
    function startTimer() {
        if (timerRunning) return;
        timerRunning = true;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timerSeconds++;
            updateTimerDisplay();
            saveSession();
        }, 1000);
    }
    function stopTimer() {
        clearInterval(timerInterval);
        timerRunning = false;
        timerSeconds = 0;
        updateTimerDisplay();
        saveSession();
    }
    function updateTimerDisplay() {
        const min = Math.floor(timerSeconds / 60);
        const sec = timerSeconds % 60;
        document.getElementById('disp-timer').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
    }

    /* ================= UI RENDERING ================= */
    function updateStatusBar() {
        // Logika: ƒçe je izbran artikel s pogoji (in imamo kartico), poka≈æi task bar, sicer default bar
        const taskBar = document.getElementById('task-bar');
        const defBar = document.getElementById('default-status-bar');
        
        let showingTasks = false;
        if (currentUser && selectedItemIndex > -1 && selectedItemIndex < currentReceipt.length) {
            const item = currentReceipt[selectedItemIndex];
            if (item.tasks && item.tasks.length > 0) {
                showingTasks = true;
                renderTaskBar(item);
            }
        }

        if (showingTasks) {
            taskBar.style.display = 'flex';
            defBar.style.display = 'none';
        } else {
            taskBar.style.display = 'none';
            defBar.style.display = 'block';
            
            const table = document.getElementById('status-table');
            const label = document.getElementById('status-label-text');
            const idCell = document.getElementById('disp-id');
            const nameCell = document.getElementById('disp-name');

            if (currentUser) {
                table.classList.remove('logged-out');
                label.textContent = "PRIJAVLJENA BLAGAJNA";
                idCell.textContent = currentUser.id;
                nameCell.textContent = currentUser.name;
            } else {
                table.classList.add('logged-out');
                label.textContent = "ODJAVLJENA BLAGAJNA";
                idCell.textContent = "000";
                nameCell.textContent = "";
            }
        }
        
        broadcastUpdate('STATUS', { isOpen: !!currentUser });
    }

    function renderTaskBar(item) {
        const bar = document.getElementById('task-bar');
        bar.innerHTML = '';
        item.tasks.forEach((task, tIdx) => {
            const btn = document.createElement('button');
            btn.className = `task-btn ${task.done ? 'done' : ''}`;
            btn.textContent = task.text;
            btn.onclick = () => toggleTaskStatus(tIdx);
            bar.appendChild(btn);
        });
    }

    function toggleTaskStatus(taskIdx) {
        if (selectedItemIndex < 0) return;
        const item = currentReceipt[selectedItemIndex];
        if (item.tasks && item.tasks[taskIdx]) {
            item.tasks[taskIdx].done = !item.tasks[taskIdx].done;
            renderReceipt(); // Posodobi barve v raƒçunu
            updateStatusBar(); // Posodobi barve v task baru
        }
    }

    function renderReceipt() {
        const container = document.getElementById('receipt-body');
        container.innerHTML = '';
        let total = 0;

        document.getElementById('receipt-num').textContent = currentUser ? (currentReceipt.length > 0 ? "WIP" : "----") : "----";

        currentReceipt.forEach((item, index) => {
            if (!item.isVoid) total += (item.price * item.qty);

            const div = document.createElement('div');
            div.className = `receipt-item ${index === selectedItemIndex ? 'selected' : ''} ${item.isPromo ? 'promo' : ''} ${item.isVoid ? 'voided' : ''}`;
            div.onclick = () => {
                if(currentUser && !item.isFinal) {
                    selectedItemIndex = index;
                    renderReceipt();
                    updateStatusBar();
                }
            };

            // Main Line
            let prefix = item.isPromo ? "P " : "";
            let nameDisplay = item.name;
            if (item.qty > 1) nameDisplay += ` (${item.qty}x)`;

            if (!item.isPromo && !item.isVoid && item.price < item.originalPrice) {
                const discountPercent = Math.round((1 - (item.price / item.originalPrice)) * 100);
                nameDisplay += ` [-${discountPercent}%]`;
            }

            const mainRow = document.createElement('div');
            mainRow.className = 'ri-main';
            mainRow.innerHTML = `<span>${prefix}${nameDisplay}</span><span>${formatMoney(item.price * item.qty)}</span>`;
            div.appendChild(mainRow);

            // Sub Items (Meni)
            if (item.subItems && item.subItems.length > 0) {
                item.subItems.forEach(sub => {
                    const sDiv = document.createElement('div');
                    sDiv.className = 'ri-sub';
                    sDiv.innerText = `- ${sub.name}`;
                    div.appendChild(sDiv);
                });
            }

            // Tasks (Pogoji)
            if (item.tasks && item.tasks.length > 0) {
                item.tasks.forEach(task => {
                    const tDiv = document.createElement('div');
                    tDiv.className = `ri-task ${task.done ? 'task-done' : 'task-pending'}`;
                    tDiv.innerText = `> ${task.text}`;
                    div.appendChild(tDiv);
                });
            }

            container.appendChild(div);
        });

        const lastItem = currentReceipt[currentReceipt.length-1];
        if (lastItem && lastItem.isFinal) {
             const line = document.createElement('div');
             line.innerHTML = "---------------------------------";
             line.style.textAlign = 'center';
             container.appendChild(line);
             const finalDiv = document.createElement('div');
             finalDiv.style.textAlign = 'center';
             finalDiv.innerHTML = `RAƒåUN #${lastItem.receiptId}`;
             container.appendChild(finalDiv);
        }

        const totalStr = formatMoney(total);
        document.getElementById('total-amount').textContent = totalStr;
        saveSession(); 
        
        if (currentUser) {
            broadcastUpdate('CART', {
                items: currentReceipt,
                total: total,
                totalStr: totalStr
            });
        }
    }

    function setMode(mode) {
        if (mode === 'MANAGER') {
            requestAuthCode("Vnesi KODO za dostop:", (user) => {
                logMgrAction(user, "ACCESSED MGR MENU");
                if (user.role === 'HOST' || user.role === 'MANAGER') {
                    currentMode = 'MANAGER';
                    activeManagerMenu = 'MAIN'; // Start at Main
                    initMgrKeypad(); // Reset keypad
                    renderButtons();
                } else {
                    customAlert("Ta koda nima dostopa do funkcij!");
                }
            });
            return;
        }

        if (!currentUser) { customAlert("Najprej se mora prijaviti manager/blagajnik!"); return; }
        currentMode = mode;
        // Ob izhodu iz managerja, ugasni keypad
        mgrKpActive = false;
        renderButtons();
    }

    function renderButtons() {
        const container = document.getElementById('main-display');
        container.innerHTML = '';
        container.className = ''; // Reset layout

        if (currentMode === 'ARTICLES') {
            const searchRow = document.createElement('div');
            searchRow.style.gridColumn = "span 4";
            searchRow.className = "btn btn-search";
            searchRow.style.padding = "0";
            searchRow.innerHTML = '<img src="scan.png" style="width:100%; height:100%; object-fit:contain;" alt="SCAN">';
            searchRow.onclick = () => {
                showKeypad("Vnesi ≈°ifro artikla:", false, (val) => processArticleCode(val));
            };
            container.appendChild(searchRow);

            if (db.settings.poa) {
                db.articles.forEach(art => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    if (!art.enabled) {
                        btn.classList.add('btn-grey');
                        btn.disabled = true;
                    }
                    btn.innerHTML = `<span>${art.name}</span>` + (isPOF ? `<br><span style="font-size:0.9em">${formatMoney(art.price)}</span>` : '');
                    
                    if (art.enabled) {
                        btn.onclick = () => addItem(art);
                    }
                    container.appendChild(btn);
                });
            }
        } 
        else if (currentMode === 'FUNCTIONS') {
            const functions = [
                { name: 'KOLIƒåINA', action: fnQuantity },
                { name: 'PROMO', action: fnPromo },
                { name: 'VOID', action: fnVoid },
                { name: '% POPUST', action: fnDiscount }
            ];
            functions.forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = f.name;
                btn.onclick = f.action;
                container.appendChild(btn);
            });
        }
        else if (currentMode === 'FINISH') {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.gridColumn = "span 4";
            btn.style.gridRow = "span 2";
            btn.style.fontSize = "20px";
            btn.textContent = "KONƒåAJ RAƒåUN";
            btn.onclick = finishReceiptSequence;
            container.appendChild(btn);
        }
        else if (currentMode === 'MANAGER') {
            // --- MANAGER VIEW ---
            container.innerHTML = '';
            
            // Layout Wrapper
            const layout = document.createElement('div');
            layout.className = 'mgr-layout';

            // Left: Buttons
            const btnGrid = document.createElement('div');
            btnGrid.className = 'mgr-buttons';

            if (activeManagerMenu === 'MAIN') {
                const mainBtns = [
                    { name: 'LOGIN', img: 'login.png', action: () => activateMgrKeypad('LOGIN') },
                    { name: 'VMESNO', img: 'vmesno.png', action: mgrInterim },
                    { name: 'SKYM', img: 'skym.png', action: () => activateMgrKeypad('SKYM') },
                    { name: 'OPRAVILA', img: 'opravila.png', action: mgrDefineTasks },
                    { name: 'DODATNO', img: 'dodatno.png', action: () => { activeManagerMenu = 'EXTRA'; renderButtons(); } },
                    { name: 'LOGOUT', img: 'logout.png', action: mgrLogout }, // Added logout to main as well
                ];
                mainBtns.forEach(b => btnGrid.appendChild(createMgrBtn(b)));
            } 
            else if (activeManagerMenu === 'EXTRA') {
                const extraBtns = [
                    { name: 'ARTIKLI', img: 'artikli.png', action: mgrArticles },
                    { name: 'ZAPOSLENI', img: 'zaposleni.png', action: mgrEmployees },
                    { name: 'STORNO', img: 'storno.png', action: () => activateMgrKeypad('STORNO') },
                    { name: 'BANKA', img: 'banka.png', action: mgrBank },
                    { name: 'PRODAJA', img: 'prodaja.png', action: mgrSalesAnalysis },
                    { name: `P.O.A. ${db.settings.poa ? 'ON' : 'OFF'}`, action: togglePOA, customClass: db.settings.poa ? 'btn-green' : 'btn-red' },
                    { name: `R.O.F. ${db.settings.rof ? 'ON' : 'OFF'}`, action: toggleROF, customClass: db.settings.rof ? 'btn-green' : 'btn-red' },
                    { name: 'MGR ZGOD.', img: 'mgrzgod.png', action: mgrShowHistory },
                    { name: 'NAZAJ', action: () => { activeManagerMenu = 'MAIN'; initMgrKeypad(); renderButtons(); }, customClass: 'btn-grey' }
                ];
                extraBtns.forEach(b => btnGrid.appendChild(createMgrBtn(b)));
            }

            // Right: Embedded Keypad
            const kpContainer = document.createElement('div');
            kpContainer.className = 'mgr-keypad-container';
            kpContainer.innerHTML = renderMgrKeypadHTML();
            
            layout.appendChild(btnGrid);
            layout.appendChild(kpContainer);
            container.appendChild(layout);
        }
    }

    function createMgrBtn(b) {
        const btn = document.createElement('button');
        btn.className = `btn ${b.customClass || ''}`;
        if (b.img) {
            btn.style.padding = "0";
            btn.innerHTML = `<img src="${b.img}" style="width:100%; height:100%; object-fit:contain;" alt="${b.name}">`;
        } else {
            btn.innerHTML = (b.icon ? b.icon + " " : "") + b.name;
        }
        btn.onclick = b.action;
        return btn;
    }

    /* --- MANAGER KEYPAD LOGIC --- */
    function renderMgrKeypadHTML() {
        return `
            <div id="mgr-kp-label">INACTIVE</div>
            <div id="mgr-kp-screen"></div>
            <div class="mgr-kp-grid">
                ${[7,8,9,4,5,6,1,2,3,0,'.','OK'].map(k => 
                    `<button class="mkp-btn" id="mkp-${k}" onclick="handleMgrKp('${k}')">${k}</button>`
                ).join('')}
            </div>
        `;
    }

    function initMgrKeypad() {
        mgrKpActive = false;
        mgrKpBuffer = "";
        mgrKpMode = null;
        updateMgrKpUI();
    }

    function activateMgrKeypad(mode) {
        mgrKpActive = true;
        mgrKpMode = mode;
        mgrKpStep = 1;
        mgrKpBuffer = "";
        mgrKpTempData = {};
        
        let label = "";
        if(mode === 'LOGIN') label = "VNESI ID:";
        if(mode === 'SKYM') label = "ZNESEK DVIGA:";
        if(mode === 'STORNO') label = "ZNESEK VRACILA:";
        
        updateMgrKpUI(label, "");
    }

    function updateMgrKpUI(label, text) {
        const screen = document.getElementById('mgr-kp-screen');
        const lbl = document.getElementById('mgr-kp-label');
        const btns = document.querySelectorAll('.mkp-btn');
        
        if (screen) {
            if (!mgrKpActive) {
                screen.innerText = "";
                lbl.innerText = "INACTIVE";
                btns.forEach(b => b.classList.remove('active'));
            } else {
                screen.innerText = text !== undefined ? text : mgrKpBuffer;
                if(label) lbl.innerText = label;
                btns.forEach(b => b.classList.add('active'));
            }
        }
    }

    window.handleMgrKp = function(key) {
        if (!mgrKpActive) return;

        if (key === 'OK') {
            processMgrKpStep();
        } else {
            if(mgrKpBuffer.length < 10) mgrKpBuffer += key;
            updateMgrKpUI(undefined, mgrKpBuffer);
        }
    }

    function processMgrKpStep() {
        if (mgrKpMode === 'LOGIN') {
            if (mgrKpStep === 1) { // ID vnos
                const emp = db.employees.find(e => e.id === mgrKpBuffer);
                if (emp) {
                    mgrKpTempData.emp = emp;
                    mgrKpStep = 2;
                    mgrKpBuffer = "";
                    updateMgrKpUI(`${emp.name} DEPOZIT:`, "");
                } else {
                    alert("Ni delavca!"); // Simpl alert za embedded
                    mgrKpBuffer = "";
                    updateMgrKpUI(undefined, "");
                }
            } else if (mgrKpStep === 2) { // Depozit
                const cash = parseFloat(mgrKpBuffer);
                const worker = mgrKpTempData.emp;
                
                currentUser = {
                    ...worker,
                    loginTime: new Date(),
                    startCash: cash,
                    sessionVoids: 0
                };
                db.cashInDrawer = cash;
                db.shiftLog.push({ type: 'LOGIN', user: worker.name, amount: cash, time: new Date() });
                logMgrAction(worker, "LOGGED IN TO REGISTER");
                saveDB();
                saveSession();
                
                // Reset
                initMgrKeypad();
                updateStatusBar();
                setMode('ARTICLES');
            }
        } 
        else if (mgrKpMode === 'SKYM') {
            const amount = parseFloat(mgrKpBuffer);
            if (amount > db.cashInDrawer) {
                alert("Ni dovolj denarja!");
                mgrKpBuffer = "";
                updateMgrKpUI(undefined, "");
                return;
            }
            db.cashInDrawer -= amount;
            db.shiftLog.push({ type: 'SKYM', user: currentUser ? currentUser.name : 'MGR', amount: amount, time: new Date() });
            saveDB();
            alert("Odvzem zabele≈æen.");
            initMgrKeypad();
        }
        else if (mgrKpMode === 'STORNO') {
            const amount = parseFloat(mgrKpBuffer);
            db.cashInDrawer -= amount;
            // Zabele≈æimo kot roƒçni storno gotovine (brez vezave na raƒçun)
             db.shiftLog.push({ type: 'MANUAL_VOID', user: currentUser ? currentUser.name : 'MGR', amount: amount, time: new Date() });
            saveDB();
            alert(`Storno ${formatMoney(amount)} izveden.`);
            initMgrKeypad();
            // Vrni se v Main menu
            activeManagerMenu = 'MAIN';
            renderButtons();
        }
    }


    /* ================= OPRAVILA (MGR) ================= */
    function mgrDefineTasks() {
        showKeypad("Vnesi ID stranke:", false, (cid) => {
            const currentTasks = db.customerTasks[cid] || [];
            
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = `OPRAVILA (${cid})`;
            
            let html = `<div style="margin-bottom:10px;">Trenutna opravila:</div>`;
            html += `<div class="modal-list" id="task-list-edit">`;
            currentTasks.forEach((t, i) => {
                html += `<div class="modal-list-item"><span>${t}</span> <button class="list-btn-action" onclick="removeTask('${cid}', ${i})">X</button></div>`;
            });
            html += `</div>`;
            html += `<button class="btn" style="width:100%; margin-top:10px;" onclick="addTaskStep('${cid}')">+ DODAJ OPRAVILO</button>`;
            
            content.innerHTML = html;
            document.getElementById('modal-overlay').style.display = 'flex';
        });
    }

    window.addTaskStep = function(cid) {
        showKeyboard("Vnesi besedilo opravila:", (text) => {
            if(!db.customerTasks[cid]) db.customerTasks[cid] = [];
            db.customerTasks[cid].push(text);
            saveDB();
            // Refresh modal
            const currentTasks = db.customerTasks[cid];
            let html = ``;
             currentTasks.forEach((t, i) => {
                html += `<div class="modal-list-item"><span>${t}</span> <button class="list-btn-action" onclick="removeTask('${cid}', ${i})">X</button></div>`;
            });
            document.getElementById('task-list-edit').innerHTML = html;
            
            // Re-open main modal structure logic is hard here due to modal nesting not being supported well.
            // Let's just close keyboard and reopen tasks
            setTimeout(() => {
                const content = document.getElementById('modal-content');
                document.getElementById('modal-title').innerText = `OPRAVILA (${cid})`;
                // Reattach add button logic
                // Simplified: close and restart for MVP
                closeModal();
                setTimeout(() => {
                    // Hacky re-entry
                    const t = db.customerTasks[cid];
                    // Manual rebuild of that view...
                    const content = document.getElementById('modal-content');
                    content.innerHTML = `
                         <div style="margin-bottom:10px;">Trenutna opravila:</div>
                         <div class="modal-list" id="task-list-edit">
                            ${t.map((txt,i) => `<div class="modal-list-item"><span>${txt}</span> <button class="list-btn-action" onclick="removeTask('${cid}', ${i})">X</button></div>`).join('')}
                         </div>
                         <button class="btn" style="width:100%; margin-top:10px;" onclick="addTaskStep('${cid}')">+ DODAJ OPRAVILO</button>
                    `;
                    document.getElementById('modal-overlay').style.display = 'flex';
                }, 100);
            }, 100);
        });
    }

    window.removeTask = function(cid, idx) {
        db.customerTasks[cid].splice(idx, 1);
        saveDB();
        // Refresh UI manually
        const el = document.getElementById('task-list-edit');
        el.innerHTML = db.customerTasks[cid].map((txt,i) => 
            `<div class="modal-list-item"><span>${txt}</span> <button class="list-btn-action" onclick="removeTask('${cid}', ${i})">X</button></div>`
        ).join('');
    }

    /* ================= PRODAJA ANALIZA (MGR) ================= */
    function mgrSalesAnalysis() {
        if(!currentUser) { customAlert("Ni prijavljenega blagajnika."); return; }
        
        const loginTime = new Date(currentUser.loginTime);
        const shiftReceipts = db.receipts.filter(r => new Date(r.time) >= loginTime);
        const total = shiftReceipts.reduce((acc, r) => acc + r.total, 0);

        customAlert(`
            ANALIZA PRODAJE\n
            Blagajnik: ${currentUser.name}\n
            Zaƒçetek: ${loginTime.toLocaleTimeString()}\n
            ≈†t. raƒçunov: ${shiftReceipts.length}\n
            ----------------\n
            PROMET: ${formatMoney(total)}
        `);
    }

    /* ================= MENI ARTICLES LOGIC ================= */
    function processArticleCode(code) {
        // 1. Check if it's an article
        const art = db.articles.find(a => a.code === code);
        closeModal();
        if (art) {
            if (art.enabled) {
                addItem(art);
            } else {
                customAlert("Artikel onemogoƒçen!");
            }
        } else {
            // 2. Check if it is a CARD (if not article)
            // Just assume anything else is a card scan if we are in article mode?
            // Actually, handleBarcodeScan does this separation. 
            // If manual entry fails article check, we say "≈†ifra ne obstaja".
            customAlert("≈†ifra ne obstaja!");
        }
    }

    function addItem(article) {
        if (!timerRunning) startTimer();
        
        let itemPrice = article.price;
        let subItemsCopy = [];
        let itemTasks = [];

        // MENU Logic
        if (article.type === 'MENU' && article.subItems) {
            subItemsCopy = [...article.subItems];
            // Price includes subitems
            subItemsCopy.forEach(s => itemPrice += (s.price || 0));
        }

        // POGOJ Logic
        if (article.hasCondition && currentCardId) {
            const definedTasks = db.customerTasks[currentCardId];
            if (definedTasks) {
                itemTasks = definedTasks.map(t => ({ text: t, done: false }));
            }
        }

        currentReceipt.push({
            code: article.code, 
            name: article.name,
            price: itemPrice,
            originalPrice: itemPrice,
            qty: 1,
            isPromo: false,
            isVoid: false,
            isFinal: false,
            subItems: subItemsCopy,
            tasks: itemTasks
        });
        selectedItemIndex = currentReceipt.length - 1;
        renderReceipt();
        updateStatusBar(); // Check if we need to show task bar
    }

    /* ================= CARD LOGIC ================= */
    function handleCardScan(code) {
        // Simple logic: if not article, it is card. Or specific prefix? 
        // Let's assume ANY code that isn't an article is a card for now, 
        // OR better: Check if exists in Bank or Tasks?
        // Prompt implies "skenira kartico... ƒçe kartica ni v sistemu napi≈°e WRONG".
        // "V sistemu" means in db.bankAccounts OR db.customerTasks? Let's check Bank keys.
        
        const exists = db.bankAccounts[code] !== undefined || db.customerTasks[code] !== undefined;
        
        if (exists) {
            currentCardId = code;
            showCardStatus(code, true);
        } else {
            showCardStatus(code, false);
        }
        saveSession();
    }

    function showCardStatus(id, isOk) {
        const bar = document.getElementById('card-status-bar');
        bar.style.display = 'flex';
        
        if (cardMessageTimer) clearTimeout(cardMessageTimer);

        if (isOk) {
            bar.className = 'card-ok';
            bar.textContent = `CARD OK: ${id}`;
            // Persistent until finish
        } else {
            bar.className = 'card-wrong';
            bar.textContent = `CARD WRONG: ${id}`;
            cardMessageTimer = setTimeout(() => {
                bar.style.display = 'none';
            }, 3000);
        }
    }

    /* ================= MANAGER ARTICLES (UPDATED) ================= */
    window.addNewArticle = function() {
        showKeypad("Vnesi ≈†IFRO artikla:", false, (code) => {
             if (db.articles.find(a => a.code === code)) { customAlert("≈†ifra ≈æe obstaja!"); return; }
             
             showKeyboard("Ime artikla:", (name) => {
                showKeypad("Cena (osnovna):", false, (priceVal) => {
                    const price = parseFloat(priceVal);
                    // Ask type
                    const content = document.getElementById('modal-content');
                    content.innerHTML = `
                        <h3>Tip artikla?</h3>
                        <button class="btn" style="height:50px" onclick="finalizeNewArt('${code}','${name}',${price}, 'NORMAL')">NAVADEN</button>
                        <br>
                        <button class="btn" style="height:50px" onclick="finalizeNewArt('${code}','${name}',${price}, 'MENU')">MENI (Podartikli)</button>
                    `;
                    document.getElementById('modal-overlay').style.display = 'flex';
                });
            });
        });
    }

    window.finalizeNewArt = function(code, name, price, type) {
        const newArt = { 
            name: name.toUpperCase(), 
            price: price, 
            enabled: true, 
            code: code, 
            type: type, 
            subItems: [],
            hasCondition: false
        };
        db.articles.push(newArt);
        saveDB();
        
        if(type === 'MENU') {
            editArticleSubItems(db.articles.length - 1);
        } else {
            mgrArticles();
        }
    }

    window.editArticle = function(idx) {
        const art = db.articles[idx];
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "UREDI";
        content.innerHTML = `
            <h3>${art.name}</h3>
            <button class="btn" style="width:100%; margin:2px 0" onclick="changeArtPrice(${idx})">CENA (${formatMoney(art.price)})</button>
            <button class="btn" style="width:100%; margin:2px 0" onclick="toggleArtStatus(${idx})">${art.enabled ? 'ONEMOGOƒåI' : 'OMOGOƒåI'}</button>
            <button class="btn" style="width:100%; margin:2px 0" onclick="toggleArtCondition(${idx})">POGOJI: ${art.hasCondition ? 'DA' : 'NE'}</button>
            ${art.type === 'MENU' ? `<button class="btn" style="width:100%; margin:2px 0" onclick="editArticleSubItems(${idx})">UREDI PODARTIKLE</button>` : ''}
            <button class="btn" style="width:100%; margin:2px 0; background:#ffcccc" onclick="deleteArt(${idx})">IZBRI≈†I</button>
            <button class="btn" style="width:100%; margin:10px 0" onclick="mgrArticles()">NAZAJ</button>
        `;
    }
    
    window.toggleArtCondition = function(idx) {
        db.articles[idx].hasCondition = !db.articles[idx].hasCondition;
        saveDB();
        editArticle(idx);
    }

    window.editArticleSubItems = function(idx) {
        const art = db.articles[idx];
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "PODARTIKLI";
        
        let html = `<div class="modal-list">`;
        art.subItems.forEach((s, sIdx) => {
             html += `<div class="modal-list-item"><span>${s.name} (+${s.price})</span> <button class="list-btn-action" onclick="remSubItem(${idx}, ${sIdx})">X</button></div>`;
        });
        html += `</div>`;
        
        if (art.subItems.length < 5) {
            html += `<button class="btn" style="width:100%; margin-top:5px" onclick="addSubItemStep(${idx})">+ DODAJ</button>`;
        }
        html += `<button class="btn" style="width:100%; margin-top:10px" onclick="mgrArticles()">KONƒåAJ</button>`;
        
        content.innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.addSubItemStep = function(artIdx) {
        showKeyboard("Ime podartikla:", (name) => {
            showKeypad("Dodatek k ceni (lahko 0):", false, (p) => {
                db.articles[artIdx].subItems.push({ name: name, price: parseFloat(p) });
                saveDB();
                editArticleSubItems(artIdx);
            });
        });
    }

    window.remSubItem = function(artIdx, subIdx) {
        db.articles[artIdx].subItems.splice(subIdx, 1);
        saveDB();
        editArticleSubItems(artIdx);
    }

    /* ================= STANDARD FUNCTIONS (re-included) ================= */
    
    function togglePOF() {
        isPOF = !isPOF;
        if (currentMode === 'ARTICLES') renderButtons();
    }
    function togglePOA() { db.settings.poa = !db.settings.poa; saveDB(); renderButtons(); }
    function toggleROF() { db.settings.rof = !db.settings.rof; saveDB(); renderButtons(); }

    function getSelectedItem() {
        if (selectedItemIndex < 0 || selectedItemIndex >= currentReceipt.length) return null;
        return currentReceipt[selectedItemIndex];
    }
    
    function fnQuantity() {
        const item = getSelectedItem();
        if (!item) { customAlert("Izberi artikel!"); return; }
        showKeypad("Vnesi koliƒçino:", false, (val) => {
            const qty = parseInt(val);
            if (qty > 0) { item.qty = qty; renderReceipt(); }
            closeModal();
        });
    }

    function fnPromo() {
        const item = getSelectedItem();
        if (!item) return;
        requestAuthCode("Vnesi MGR/HOST kodo:", (user) => {
            item.isPromo = true;
            item.price = 0.00;
            renderReceipt();
            closeModal();
        });
    }

    function fnVoid() {
        const item = getSelectedItem();
        if (!item) return;
        if (currentUser.sessionVoids >= 2) {
             requestAuthCode("Limit! Vnesi MGR/HOST kodo:", (user) => {
                 performVoid(item);
                 closeModal();
             });
        } else {
            performVoid(item);
            currentUser.sessionVoids++;
            saveSession();
        }
    }
    function performVoid(item) { item.isVoid = true; item.price = 0; renderReceipt(); }

    function fnDiscount() {
        // ... (standard discount logic)
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "POPUST";
        content.innerHTML = `
            <h3>Izberi popust</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn" onclick="applyDiscount('USER')">üë§ ZAPOSLENI (-40%)</button>
                <button class="btn" onclick="applyDiscount('COIN')">ü™ô WII CEKIN (-70%)</button>
                <button class="btn" onclick="applyDiscount('CUSTOM')">‚úèÔ∏è ROƒåNI VNOS</button>
            </div>
            <br>
            <label><input type="checkbox" id="disc-all"> Na celoten raƒçun?</label>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    window.applyDiscount = function(type) {
        const applyToAll = document.getElementById('disc-all').checked;
        if (type === 'USER') doDiscount(40, applyToAll);
        else if (type === 'COIN') doDiscount(70, applyToAll);
        else {
             showKeypad("Vnesi odstotek popusta:", false, (val) => { doDiscount(parseInt(val), applyToAll); closeModal(); });
        }
    }
    function doDiscount(percent, applyToAll) {
        if (percent <= 0 || percent > 100) return;
        const factor = (100 - percent) / 100;
        if (applyToAll) {
            currentReceipt.forEach(i => { if (!i.isVoid && !i.isPromo) i.price = i.originalPrice * factor; });
        } else {
            const item = getSelectedItem();
            if (item && !item.isPromo) item.price = item.originalPrice * factor;
        }
        renderReceipt();
        closeModal();
    }

    /* --- ZAKLJUƒåEK --- */
    function finishReceiptSequence() {
        if (currentReceipt.length === 0) return;
        
        const rId = db.receiptCounter++;
        saveDB(); 
        currentReceipt.forEach(i => i.isFinal = true);
        currentReceipt[currentReceipt.length-1].receiptId = rId;
        renderReceipt();
        stopTimer();

        const total = currentReceipt.reduce((acc, i) => acc + (i.price * i.qty), 0);
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "PLAƒåILO";
        content.innerHTML = `
            <h3>ZNESEK: ${formatMoney(total)}</h3>
            <button class="btn" style="height:60px" onclick="paymentCash(${total})">GOTOVINA</button>
            <br><br>
            <button class="btn" style="height:60px" onclick="paymentCard(${total})">KARTICA</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.paymentCash = function(total) {
        showKeypad("Vnesi prejeto gotovino:", false, (val) => {
            const received = parseFloat(val);
            const change = received - total;
            if (change < 0) { customAlert("Premalo denarja!"); return; }
            customAlert(`VRAƒåILO: ${formatMoney(change)}`, () => finalizeTransaction(total, 'CASH'));
        });
    }

    window.paymentCard = function(total) {
        // ƒåe je kartica ≈æe skenirana, jo uporabi
        if (currentCardId && db.bankAccounts[currentCardId] !== undefined) {
            processBankPayment(currentCardId, total);
        } else {
            showKeypad("Vnesi ID banke stranke:", false, (clientId) => {
                if (db.bankAccounts[clientId] === undefined) { customAlert("Stranka ne obstaja!"); return; }
                processBankPayment(clientId, total);
            });
        }
    }
    
    window.processBankPayment = function(id, total) {
        if (db.bankAccounts[id] < total) { customAlert("Ni kritja!"); return; }
        
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "POTRDI";
        content.innerHTML = `
             <p>Stranka: ${id}</p>
             <p>Stanje: ${formatMoney(db.bankAccounts[id])}</p>
             <button class="btn" style="height:50px; background:#8f8;" onclick="execBankPay('${id}', ${total})">POTRDI</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.execBankPay = function(id, total) {
        db.bankAccounts[id] -= total;
        finalizeTransaction(total, 'CARD');
    }

    function finalizeTransaction(amount, type) {
        closeModal();
        if (type === 'CASH') db.cashInDrawer += amount;
        
        const rId = currentReceipt[currentReceipt.length-1].receiptId;
        const receiptData = {
            id: rId,
            items: [...currentReceipt],
            total: amount,
            type: type,
            cashier: currentUser.name,
            time: new Date().toISOString()
        };

        db.receipts.push(receiptData);
        saveDB();
        
        broadcastUpdate('SUCCESS', { total: amount });
        
        // Reset state
        currentReceipt = [];
        selectedItemIndex = -1;
        currentCardId = null; // Reset card on finish
        document.getElementById('card-status-bar').style.display = 'none';
        
        saveSession();
        renderReceipt();
        updateStatusBar();
    }

    /* --- MGR OSTALO --- */
    function mgrLogout() {
        if (!currentUser) return;
        const expected = db.cashInDrawer;
        const sessionReceipts = db.receipts.filter(r => new Date(r.time) >= new Date(currentUser.loginTime));
        const soldCount = sessionReceipts.length;

        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "ZAKLJUƒåEK";
        content.innerHTML = `
            <div style="text-align:left; font-size:14px;">
                Blagajnik: ${currentUser.name}<br>
                Priƒçakovano: ${formatMoney(expected)}<br>
                Raƒçunov: ${soldCount}
            </div>
            <br>
            <button class="btn" onclick="finalizeLogout(${expected})">VNESI DEJAN. STANJE</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.finalizeLogout = function(expected) {
        showKeypad("Dejansko stanje:", false, (val) => {
            const actual = parseFloat(val);
            db.shiftLog.push({ type: 'LOGOUT', user: currentUser.name, expected: expected, actual: actual, diff: actual-expected, time: new Date() });
            
            // PDF GENERATION (Poenostavljeno)
            if (window.jspdf) {
                 // ... (pdf logika ista kot prej, izpu≈°ƒçena za preglednost)
            }

            saveDB();
            currentUser = null;
            currentReceipt = [];
            currentCardId = null;
            stopTimer();
            localStorage.removeItem('wiiShopSession'); 
            updateStatusBar();
            closeModal();
            document.getElementById('main-display').innerHTML = '';
        });
    }

    function mgrInterim() { customAlert(`TRENUTNO STANJE: ${formatMoney(db.cashInDrawer)}`); }
    
    // --- MGR SUB-MENUS ---
    function mgrArticles() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "ARTIKLI";
        let html = '<h3>UREJANJE ARTIKLOV</h3><button class="btn" style="width:100%; margin-bottom:10px" onclick="addNewArticle()">+ DODAJ ARTIKEL</button><div class="modal-list">';
        db.articles.forEach((art, idx) => {
            const style = art.enabled ? '' : 'text-decoration:line-through; color:red;';
            const extraInfo = art.type === 'MENU' ? ' (MENI)' : '';
            html += `<div class="modal-list-item" style="${style}" onclick="editArticle(${idx})"><span>[${art.code}] ${art.name}${extraInfo}</span><span>${formatMoney(art.price)}</span></div>`;
        });
        html += '</div>';
        content.innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function mgrBank() {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "BANKA";
        content.innerHTML = `
            <h3>BANKA</h3>
            <button class="btn" onclick="bankNewClient()">NOVA STRANKA</button>
            <br><br>
            <button class="btn" onclick="bankEditClient()">TRANSAKCIJA</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    window.bankNewClient = function() {
        showKeypad("ID nove stranke:", false, (id) => {
            if (db.bankAccounts[id] !== undefined) { customAlert("Obstaja!"); return; }
            showKeypad("Polog:", false, (val) => {
                db.bankAccounts[id] = parseFloat(val);
                saveDB();
                customAlert("Odprto!");
                closeModal();
            });
        });
    }
    window.bankEditClient = function() {
        showKeypad("ID stranke:", false, (id) => {
            if (db.bankAccounts[id] === undefined) { customAlert("Ni stranke!"); return; }
            showKeypad(`Stanje: ${formatMoney(db.bankAccounts[id])}\nZnesek (+/-):`, false, (val) => {
                db.bankAccounts[id] += parseFloat(val);
                saveDB();
                customAlert("Novo stanje: " + formatMoney(db.bankAccounts[id]));
                closeModal();
            });
        });
    }

    function mgrEmployees() { /* ... (enako kot prej) ... */ }
    function mgrShowHistory() { /* ... (enako kot prej) ... */ }

    /* ================= SYSTEM ================= */
    let inputCallback = null;
    function showKeypad(title, isSecret, callback) {
        inputCallback = callback;
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-overlay').style.display = 'flex';
        content.innerHTML = `
            <div id="kp-display" class="input-display"></div>
            <div class="keypad-grid">
                <button class="keypad-btn" onclick="kpIn('7')">7</button>
                <button class="keypad-btn" onclick="kpIn('8')">8</button>
                <button class="keypad-btn" onclick="kpIn('9')">9</button>
                <button class="keypad-btn" onclick="kpIn('4')">4</button>
                <button class="keypad-btn" onclick="kpIn('5')">5</button>
                <button class="keypad-btn" onclick="kpIn('6')">6</button>
                <button class="keypad-btn" onclick="kpIn('1')">1</button>
                <button class="keypad-btn" onclick="kpIn('2')">2</button>
                <button class="keypad-btn" onclick="kpIn('3')">3</button>
                <button class="keypad-btn" onclick="kpIn('.')">.</button> 
                <button class="keypad-btn" onclick="kpIn('0')">0</button>
                <button class="keypad-btn" style="background:#faa" onclick="kpIn('C')">C</button>
            </div>
            <button class="btn" style="width:100%; margin-top:10px; height:40px; background:#8f8" onclick="submitInput()">POTRDI</button>
        `;
        content.dataset.secret = isSecret; content.dataset.value = "";
    }

    function showKeyboard(title, callback) {
        inputCallback = callback;
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-overlay').style.display = 'flex';
        const keys = "QWERTYUIOPASDFGHJKLZXCVBNM".split('');
        let keysHtml = '';
        keys.forEach(k => { keysHtml += `<button class="kb-btn" onclick="kpIn('${k}')">${k}</button>`; });
        content.innerHTML = `
            <div id="kp-display" class="input-display" style="justify-content:flex-start; font-size:18px"></div>
            <div class="keyboard-grid">
                ${keysHtml}
                <button class="kb-btn kb-btn-wide" onclick="kpIn('SPACE')">_</button>
                <button class="kb-btn kb-btn-wide" style="background:#faa" onclick="kpIn('BACK')">DEL</button>
            </div>
            <button class="btn" style="width:100%; margin-top:10px; height:40px; background:#8f8" onclick="submitInput()">POTRDI</button>
        `;
        content.dataset.secret = false; content.dataset.value = "";
    }

    window.kpIn = function(val) {
        const content = document.getElementById('modal-content');
        if (document.getElementById('modal-overlay').style.display === 'none') return;
        let current = content.dataset.value || "";
        if (val === 'C') current = "";
        else if (val === 'BACK') current = current.slice(0, -1);
        else if (val === 'SPACE') current += " ";
        else current += val;
        content.dataset.value = current;
        const display = document.getElementById('kp-display');
        if(display) {
            if (content.dataset.secret === 'true') display.textContent = "*".repeat(current.length);
            else display.textContent = current;
        }
    }

    window.submitInput = function() {
        const val = document.getElementById('modal-content').dataset.value;
        if (inputCallback) inputCallback(val);
    }
    
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function customAlert(msg, callback) {
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "OBVESTILO";
        content.innerHTML = `<div class="msg-text">${msg}</div><button class="btn" style="width:100%; height:50px;" onclick="closeCustomAlert()">OK</button>`;
        document.getElementById('modal-overlay').style.display = 'flex';
        window._alertCb = callback;
    }
    window.closeCustomAlert = function() { closeModal(); if(window._alertCb) { window._alertCb(); window._alertCb=null; } }

    function requestAuthCode(title, cb) {
        showKeypad(title, true, (code) => {
            const u = db.employees.find(e => e.code === code);
            if(u && (u.role==='MANAGER'||u.role==='HOST')) { closeModal(); cb(u); } else { customAlert("Napaƒçna koda!"); }
        });
    }

    /* ================= BARCODE SCANNER HANDLER ================= */
    let barcodeBuffer = "";
    let barcodeTimer = null;

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.altKey || e.metaKey) return;
        const isModalOpen = document.getElementById('modal-overlay').style.display === 'flex';

        if (e.key === 'Enter') {
            if (barcodeBuffer.length > 0) {
                e.preventDefault();
                handleBarcodeScan(barcodeBuffer);
                barcodeBuffer = "";
                return;
            } else if (isModalOpen) {
                submitInput();
                return;
            }
        }

        if (e.key.length === 1) {
            barcodeBuffer += e.key;
            clearTimeout(barcodeTimer);
            barcodeTimer = setTimeout(() => { barcodeBuffer = ""; }, 200);
        }

        // Roƒçno tipkanje v modal ali Manager embedded
        if (isModalOpen) {
            if (e.key >= '0' && e.key <= '9') kpIn(e.key);
            if (e.key === 'Backspace') kpIn('BACK');
        } else if (mgrKpActive && currentMode === 'MANAGER') {
            // Preusmeri tipke v manager keypad ƒçe je aktiven
             if (e.key >= '0' && e.key <= '9') handleMgrKp(e.key);
        }
    });

    function handleBarcodeScan(code) {
        const isModalOpen = document.getElementById('modal-overlay').style.display === 'flex';
        if (isModalOpen) {
             // Modal handling
             const content = document.getElementById('modal-content');
             content.dataset.value = code;
             setTimeout(submitInput, 50);
        } else {
             // MAIN SCREEN LOGIC
             // 1. Check Article
             const art = db.articles.find(a => a.code === code);
             if (art) {
                 if(currentMode === 'ARTICLES') processArticleCode(code);
             } else {
                 // 2. Check Card
                 handleCardScan(code);
             }
        }
    }

    loadSession();
    updateStatusBar();
</script>
</body>
</html>
