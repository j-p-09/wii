<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olimpijske Igre 2026 - Uradni Rezultati</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Barvna paleta - Temna & Neon */
            --bg-deep: #050505;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-hover: rgba(255, 255, 255, 0.15);
            --accent: #00f2ff;
            --accent-glow: 0 0 15px rgba(0, 242, 255, 0.5);
            --text: #ffffff;
            --text-dim: #888;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
            --danger: #ff4757;
            --success: #2ed573;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 120px;
            overflow-x: hidden;
        }

        /* Ozadje - animirani gradient */
        .background-fx {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -2;
            background: radial-gradient(circle at 15% 50%, rgba(0, 40, 100, 0.4), transparent 40%),
                        radial-gradient(circle at 85% 30%, rgba(60, 0, 80, 0.3), transparent 40%);
        }

        /* --- UI ELEMENTI --- */
        h1, h2, h3 { 
            font-family: 'Rajdhani', sans-serif; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            text-align: center;
        }
        h1 { margin: 30px 0; font-size: 2.5rem; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        .section { 
            display: none; 
            padding: 20px; 
            max-width: 900px; 
            margin: 0 auto; 
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .section.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- GLASS KARTICE --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        /* --- TABELE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { 
            text-align: left; padding: 12px; 
            color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; 
            border-bottom: 1px solid var(--glass-border); 
        }
        td { padding: 15px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 1rem; }
        tr:last-child td { border-bottom: none; }
        
        .flag-img {
            width: 32px; height: 24px; object-fit: cover; border-radius: 4px;
            vertical-align: middle; margin-right: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .rank-badge {
            display: inline-block; width: 30px; height: 30px; line-height: 30px;
            text-align: center; border-radius: 50%; background: rgba(255,255,255,0.1);
            font-weight: bold; font-family: 'Rajdhani';
        }
        .rank-1 { background: var(--gold); color: black; box-shadow: 0 0 10px var(--gold); }
        .rank-2 { background: var(--silver); color: black; }
        .rank-3 { background: var(--bronze); color: black; }

        /* --- FORMS --- */
        input, select, button {
            width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 8px;
            border: 1px solid var(--glass-border); background: rgba(0,0,0,0.4); color: white;
            font-size: 1rem; transition: 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: var(--accent-glow); }
        
        .btn-primary {
            background: var(--accent); color: black; font-weight: 700; text-transform: uppercase; border: none; cursor: pointer;
        }
        .btn-primary:hover { background: white; box-shadow: 0 0 20px white; }
        
        .btn-danger { background: var(--danger); border: none; color: white; cursor: pointer; font-weight: bold; }
        .btn-sm { width: auto; padding: 5px 10px; font-size: 0.8rem; margin: 0 2px; }

        .form-row { display: flex; gap: 10px; }
        .form-row > * { flex: 1; }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px;
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            display: flex; justify-content: space-around;
            padding: 10px 5px; z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        
        .nav-item {
            color: var(--text-dim); text-decoration: none;
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; transition: 0.3s; padding: 8px 15px; border-radius: 20px;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent); background: rgba(0, 242, 255, 0.1); }
        .nav-item:hover { color: white; }

        /* --- ADMIN TABS --- */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .tab-pill {
            background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; cursor: pointer;
            border: 1px solid transparent; transition: 0.3s;
        }
        .tab-pill.active { border-color: var(--accent); color: var(--accent); background: rgba(0, 242, 255, 0.05); }

        /* Helper za urejanje */
        .edit-mode-indicator { 
            display: none; background: var(--accent); color: black; 
            padding: 5px; text-align: center; border-radius: 4px; margin-bottom: 10px; font-weight: bold; 
        }
    </style>
</head>
<body>

    <div class="background-fx"></div>

    <div id="section-medals" class="section active">
        <h1><i class="fas fa-trophy"></i> Medalje</h1>
        <div class="glass-panel">
            <table>
                <thead>
                    <tr>
                        <th style="width:50px">#</th>
                        <th>Država</th>
                        <th class="text-center"><i class="fas fa-medal" style="color:var(--gold)"></i></th>
                        <th class="text-center"><i class="fas fa-medal" style="color:var(--silver)"></i></th>
                        <th class="text-center"><i class="fas fa-medal" style="color:var(--bronze)"></i></th>
                    </tr>
                </thead>
                <tbody id="medals-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="section-categories" class="section">
        <h1>Rezultati</h1>
        <div class="glass-panel" style="text-align:center;">
            <select id="public-cat-select" onchange="renderPublicCategory()">
                <option value="">-- Izberi disciplino --</option>
            </select>
        </div>
        <div id="cat-results-box" class="glass-panel" style="display:none;">
            <h2 id="cat-title" style="color:var(--accent); margin-bottom:15px;"></h2>
            <table>
                <thead>
                    <tr>
                        <th>Mesto</th>
                        <th>Država</th>
                        <th>Rezultat</th>
                        <th>Točke</th>
                    </tr>
                </thead>
                <tbody id="cat-body"></tbody>
            </table>
            <p style="text-align:center; font-size:0.8rem; color:var(--text-dim); margin-top:20px;">
                * Imena tekmovalcev so na voljo v podrobnem poročilu sodnikov.
            </p>
        </div>
    </div>

    <div id="section-total" class="section">
        <h1>Skupni Seštevek</h1>
        <div class="admin-tabs" style="justify-content: center;">
            <div class="tab-pill active" onclick="renderTotalScore('all', this)">Vse</div>
            <div class="tab-pill" onclick="renderTotalScore('inner', this)">Notranje</div>
            <div class="tab-pill" onclick="renderTotalScore('outer', this)">Zunanje</div>
        </div>
        <div class="glass-panel">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Država</th>
                        <th style="text-align:right;">Točke</th>
                    </tr>
                </thead>
                <tbody id="total-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section-login" class="section">
        <h1>Admin</h1>
        <div class="glass-panel" style="max-width: 400px; margin: 0 auto;">
            <p style="text-align:center; margin-bottom:20px; color:var(--text-dim);">Dostop samo za sodnike in organizatorje.</p>
            <input type="password" id="admin-pass" placeholder="Geslo">
            <button class="btn-primary" onclick="login()">Vstopi</button>
        </div>
    </div>

    <div id="section-admin" class="section">
        <h1><i class="fas fa-cogs"></i> Nadzorna Plošča</h1>
        
        <div class="admin-tabs">
            <div class="tab-pill active" onclick="admTab('adm-cats', this)">Kategorije</div>
            <div class="tab-pill" onclick="admTab('adm-res', this)">Rezultati</div>
            <div class="tab-pill" onclick="admTab('adm-countries', this)">Države</div>
            <div class="tab-pill" onclick="admTab('adm-people', this)">Tekmovalci</div>
            <div class="tab-pill" style="border-color:var(--danger); color:var(--danger)" onclick="logout()">Odjava</div>
        </div>

        <div id="adm-cats" class="adm-content">
            <div class="glass-panel">
                <h3>Nova / Uredi Kategorijo</h3>
                <div id="edit-cat-indicator" class="edit-mode-indicator">UREJANJE</div>
                <input type="hidden" id="cat-id">
                <div class="form-row">
                    <input type="text" id="cat-name" placeholder="Ime (npr. Lokostrelstvo)">
                    <select id="cat-type"><option value="inner">Notranje</option><option value="outer">Zunanje</option></select>
                </div>
                <div class="form-row">
                    <input type="text" id="cat-unit" placeholder="Enota (m, s, točke)">
                    <select id="cat-sort">
                        <option value="desc">Več je bolje</option>
                        <option value="asc">Manj je bolje (Čas)</option>
                    </select>
                </div>
                <button class="btn-primary" id="btn-save-cat" onclick="saveCategory()">Dodaj Kategorijo</button>
                <button class="btn-danger" id="btn-cancel-cat" style="display:none; margin-top:5px;" onclick="resetCatForm()">Prekliči</button>
            </div>
            <div class="glass-panel">
                <ul id="list-cats" style="list-style:none;"></ul>
            </div>
        </div>

        <div id="adm-res" class="adm-content" style="display:none;">
            <div class="glass-panel">
                <h3>Vpis Rezultatov</h3>
                <select id="res-cat-select" onchange="setupResForm()"></select>
                <input type="date" id="res-date">
                <div id="res-form-area" style="margin-top:20px;"></div>
            </div>
        </div>

        <div id="adm-countries" class="adm-content" style="display:none;">
            <div class="glass-panel">
                <h3>Uredi Države</h3>
                <div id="edit-country-indicator" class="edit-mode-indicator">UREJANJE</div>
                <input type="hidden" id="country-id">
                <div class="form-row">
                    <input type="text" id="country-name" placeholder="Ime Države (Slovenija)">
                    <input type="text" id="country-code" placeholder="Koda (si, hr, it, de...) - 2 črki" maxlength="2">
                </div>
                <button class="btn-primary" id="btn-save-country" onclick="saveCountry()">Shrani Državo</button>
                <button class="btn-danger" id="btn-cancel-country" style="display:none; margin-top:5px;" onclick="resetCountryForm()">Prekliči</button>
            </div>
            <div class="glass-panel">
                <ul id="list-countries" style="list-style:none;"></ul>
            </div>
        </div>

        <div id="adm-people" class="adm-content" style="display:none;">
            <div class="glass-panel">
                <h3>Uredi Tekmovalce</h3>
                <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Če oseba tekmuje za dve državi, ustvari dva vnosa (enega za vsako).</p>
                
                <div id="edit-comp-indicator" class="edit-mode-indicator">UREJANJE</div>
                <input type="hidden" id="comp-id">
                
                <div class="form-row">
                    <input type="text" id="comp-name" placeholder="Ime in Priimek">
                    <select id="comp-country-select"></select>
                </div>
                <button class="btn-primary" id="btn-save-comp" onclick="saveCompetitor()">Shrani Tekmovalca</button>
                <button class="btn-danger" id="btn-cancel-comp" style="display:none; margin-top:5px;" onclick="resetCompForm()">Prekliči</button>
            </div>
            <div class="glass-panel">
                <div id="list-competitors"></div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <a onclick="nav('section-medals', this)" class="nav-item active"><i class="fas fa-medal"></i><span>Medalje</span></a>
        <a onclick="nav('section-categories', this)" class="nav-item"><i class="fas fa-list"></i><span>Kategorije</span></a>
        <a onclick="nav('section-total', this)" class="nav-item"><i class="fas fa-chart-bar"></i><span>Seštevek</span></a>
        <a onclick="nav('section-login', this)" class="nav-item"><i class="fas fa-user-lock"></i><span>Admin</span></a>
    </nav>

    <script>
        // --- DATA ---
        const defaultDB = {
            countries: [
                { id: 'c1', name: 'Slovenija', code: 'si' },
                { id: 'c2', name: 'Hrvaška', code: 'hr' },
                { id: 'c3', name: 'Nemčija', code: 'de' }
            ],
            competitors: [
                { id: 'p1', name: 'Janez Novak', countryId: 'c1' },
                { id: 'p2', name: 'Hans Muller', countryId: 'c3' }
            ],
            categories: [],
            results: []
        };

        let db = JSON.parse(localStorage.getItem('oly26_db')) || defaultDB;

        function saveDB() {
            localStorage.setItem('oly26_db', JSON.stringify(db));
            refresh();
        }

        // --- NAVIGATION ---
        function nav(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(el) {
                document.querySelectorAll('.nav-bar .nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }

            if(id === 'section-login' && isLoggedIn) {
                document.getElementById('section-login').classList.remove('active');
                document.getElementById('section-admin').classList.add('active');
            }
        }

        function admTab(id, el) {
            document.querySelectorAll('.adm-content').forEach(c => c.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.admin-tabs .tab-pill').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        // --- LOGIN ---
        let isLoggedIn = false;
        function login() {
            if(document.getElementById('admin-pass').value === 'admin') {
                isLoggedIn = true;
                nav('section-login'); // Will redirect to admin
                refreshAdmin();
            } else { alert('Napačno geslo!'); }
        }
        function logout() {
            isLoggedIn = false;
            document.getElementById('admin-pass').value = '';
            nav('section-medals', document.querySelector('.nav-item'));
        }

        // --- CORE LOGIC ---
        function getFlagUrl(code) {
            if(!code) return '';
            return `https://flagcdn.com/w40/${code.toLowerCase()}.png`;
        }

        function calcPoints(rank) {
            if(rank === 1) return 100;
            if(rank === 2) return 80;
            if(rank === 3) return 60;
            if(rank === 4) return 40;
            if(rank === 5) return 35;
            let p = 35 - ((rank - 5) * 0.02);
            return p > 0 ? p : 0;
        }

        function getCatResults(catId) {
            const rData = db.results.find(r => r.categoryId === catId);
            if(!rData) return [];
            
            const cat = db.categories.find(c => c.id === catId);
            let entries = [...rData.entries];

            // Sort
            entries.sort((a,b) => {
                if(a.isDNF) return 1; if(b.isDNF) return -1;
                return cat.sort === 'desc' ? b.value - a.value : a.value - b.value;
            });

            return entries.map((e, idx) => {
                const rank = e.isDNF ? null : idx + 1;
                const pts = e.isDNF ? 0 : calcPoints(rank);
                const comp = db.competitors.find(x => x.id === e.competitorId);
                const country = comp ? db.countries.find(x => x.id === comp.countryId) : null;
                return { ...e, rank, pts, comp, country };
            });
        }

        // --- RENDERING PUBLIC ---
        function renderMedals() {
            const stats = {};
            db.countries.forEach(c => stats[c.id] = { ...c, g:0, s:0, b:0 });

            db.categories.forEach(cat => {
                const res = getCatResults(cat.id);
                if(res[0] && res[0].rank===1 && res[0].country) stats[res[0].country.id].g++;
                if(res[1] && res[1].rank===2 && res[1].country) stats[res[1].country.id].s++;
                if(res[2] && res[2].rank===3 && res[2].country) stats[res[2].country.id].b++;
            });

            const sorted = Object.values(stats).sort((a,b) => (b.g - a.g) || (b.s - a.s) || (b.b - a.b));
            
            const tbody = document.getElementById('medals-body');
            tbody.innerHTML = '';
            sorted.forEach((s, i) => {
                if((s.g+s.s+s.b) === 0 && i > 5) return; // Hide empty if too many
                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}.</td>
                        <td style="font-weight:600; font-size:1.1rem;">
                            <img src="${getFlagUrl(s.code)}" class="flag-img"> ${s.name}
                        </td>
                        <td style="text-align:center; color:var(--gold); font-weight:bold;">${s.g}</td>
                        <td style="text-align:center; color:var(--silver); font-weight:bold;">${s.s}</td>
                        <td style="text-align:center; color:var(--bronze); font-weight:bold;">${s.b}</td>
                    </tr>`;
            });
        }

        function renderPublicCategory() {
            const cid = document.getElementById('public-cat-select').value;
            const box = document.getElementById('cat-results-box');
            if(!cid) { box.style.display = 'none'; return; }
            
            box.style.display = 'block';
            const cat = db.categories.find(c => c.id === cid);
            document.getElementById('cat-title').innerText = cat.name;
            
            const res = getCatResults(cid);
            const tbody = document.getElementById('cat-body');
            tbody.innerHTML = '';
            
            if(res.length === 0) { tbody.innerHTML = '<tr><td colspan="4" align="center">Ni rezultatov.</td></tr>'; return; }

            res.forEach(r => {
                const badge = r.rank <= 3 && r.rank ? `rank-${r.rank}` : '';
                tbody.innerHTML += `
                    <tr>
                        <td><span class="rank-badge ${badge}">${r.rank||'-'}</span></td>
                        <td>
                            <div style="font-weight:bold; font-size:1.1rem;">
                                <img src="${getFlagUrl(r.country.code)}" class="flag-img"> ${r.country.name}
                            </div>
                            <div style="font-size:0.85rem; color:var(--text-dim); margin-top:2px;">${r.comp.name}</div>
                        </td>
                        <td style="font-family:'Rajdhani'; font-size:1.2rem; color:var(--accent);">
                            ${r.isDNF ? 'DNF' : r.value + ' ' + cat.unit}
                        </td>
                        <td>${r.pts.toFixed(2)}</td>
                    </tr>`;
            });
        }

        function renderTotalScore(type, btn) {
            if(btn) {
                document.querySelectorAll('#section-total .tab-pill').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            }

            const scores = {};
            db.countries.forEach(c => scores[c.id] = { ...c, total: 0 });

            db.categories.forEach(cat => {
                if(type !== 'all' && cat.type !== type) return;
                const res = getCatResults(cat.id);
                res.forEach(r => {
                    if(r.country) scores[r.country.id].total += r.pts;
                });
            });

            const sorted = Object.values(scores).sort((a,b) => b.total - a.total);
            const tbody = document.getElementById('total-body');
            tbody.innerHTML = '';
            sorted.forEach((s, i) => {
                if(s.total === 0) return;
                tbody.innerHTML += `
                    <tr>
                        <td style="width:50px; font-weight:bold;">${i+1}.</td>
                        <td><img src="${getFlagUrl(s.code)}" class="flag-img"> <span style="font-size:1.1rem; font-weight:bold;">${s.name}</span></td>
                        <td style="text-align:right; font-family:'Rajdhani'; font-size:1.3rem; color:var(--accent);">${s.total.toFixed(2)}</td>
                    </tr>`;
            });
        }

        // --- ADMIN MANAGERS ---
        
        // 1. COUNTRIES CRUD
        function saveCountry() {
            const id = document.getElementById('country-id').value;
            const name = document.getElementById('country-name').value;
            const code = document.getElementById('country-code').value.toLowerCase();
            if(!name || code.length !== 2) return alert("Ime in 2-črkovna koda sta obvezna!");

            if(id) {
                // UPDATE
                const idx = db.countries.findIndex(c => c.id === id);
                db.countries[idx] = { id, name, code };
            } else {
                // CREATE
                db.countries.push({ id: 'c'+Date.now(), name, code });
            }
            saveDB(); resetCountryForm();
        }

        function editCountry(id) {
            const c = db.countries.find(x => x.id === id);
            document.getElementById('country-id').value = c.id;
            document.getElementById('country-name').value = c.name;
            document.getElementById('country-code').value = c.code;
            
            document.getElementById('btn-save-country').innerText = "Posodobi";
            document.getElementById('btn-cancel-country').style.display = 'block';
            document.getElementById('edit-country-indicator').style.display = 'block';
        }

        function deleteCountry(id) {
            // Check usage
            const hasComp = db.competitors.some(p => p.countryId === id);
            if(hasComp) return alert("Najprej izbriši tekmovalce te države!");
            if(confirm("Izbrišem državo?")) {
                db.countries = db.countries.filter(c => c.id !== id);
                saveDB();
            }
        }

        function resetCountryForm() {
            document.getElementById('country-id').value = '';
            document.getElementById('country-name').value = '';
            document.getElementById('country-code').value = '';
            document.getElementById('btn-save-country').innerText = "Shrani Državo";
            document.getElementById('btn-cancel-country').style.display = 'none';
            document.getElementById('edit-country-indicator').style.display = 'none';
        }

        // 2. COMPETITORS CRUD
        function saveCompetitor() {
            const id = document.getElementById('comp-id').value;
            const name = document.getElementById('comp-name').value;
            const cId = document.getElementById('comp-country-select').value;
            
            if(!name || !cId) return alert("Podatki manjkajo!");

            if(id) {
                const idx = db.competitors.findIndex(p => p.id === id);
                db.competitors[idx] = { id, name, countryId: cId };
            } else {
                db.competitors.push({ id: 'p'+Date.now(), name, countryId: cId });
            }
            saveDB(); resetCompForm();
        }

        function editCompetitor(id) {
            const p = db.competitors.find(x => x.id === id);
            document.getElementById('comp-id').value = p.id;
            document.getElementById('comp-name').value = p.name;
            document.getElementById('comp-country-select').value = p.countryId;

            document.getElementById('btn-save-comp').innerText = "Posodobi";
            document.getElementById('btn-cancel-comp').style.display = 'block';
            document.getElementById('edit-comp-indicator').style.display = 'block';
        }

        function deleteCompetitor(id) {
            if(confirm("Izbrišem tekmovalca? (Rezultati bodo ostali, a brez imena)")) {
                db.competitors = db.competitors.filter(p => p.id !== id);
                saveDB();
            }
        }

        function resetCompForm() {
            document.getElementById('comp-id').value = '';
            document.getElementById('comp-name').value = '';
            document.getElementById('btn-save-comp').innerText = "Shrani Tekmovalca";
            document.getElementById('btn-cancel-comp').style.display = 'none';
            document.getElementById('edit-comp-indicator').style.display = 'none';
        }

        // 3. CATEGORIES CRUD
        function saveCategory() {
            const id = document.getElementById('cat-id').value;
            const name = document.getElementById('cat-name').value;
            const type = document.getElementById('cat-type').value;
            const unit = document.getElementById('cat-unit').value;
            const sort = document.getElementById('cat-sort').value;
            
            if(!name) return alert("Ime obvezno!");
            
            const obj = { name, type, unit, sort };
            if(id) {
                const idx = db.categories.findIndex(c => c.id === id);
                db.categories[idx] = { ...db.categories[idx], ...obj };
            } else {
                db.categories.push({ id: 'k'+Date.now(), ...obj });
            }
            saveDB(); resetCatForm();
        }

        function editCat(id) {
            const c = db.categories.find(x => x.id === id);
            document.getElementById('cat-id').value = c.id;
            document.getElementById('cat-name').value = c.name;
            document.getElementById('cat-type').value = c.type;
            document.getElementById('cat-unit').value = c.unit;
            document.getElementById('cat-sort').value = c.sort;

            document.getElementById('btn-save-cat').innerText = "Posodobi";
            document.getElementById('btn-cancel-cat').style.display = 'block';
            document.getElementById('edit-cat-indicator').style.display = 'block';
        }

        function deleteCat(id) {
            if(confirm("Izbris kategorije briše tudi vse njene rezultate!")) {
                db.categories = db.categories.filter(c => c.id !== id);
                db.results = db.results.filter(r => r.categoryId !== id);
                saveDB();
            }
        }

        function resetCatForm() {
            document.getElementById('cat-id').value = '';
            document.getElementById('cat-name').value = '';
            document.getElementById('btn-save-cat').innerText = "Dodaj Kategorijo";
            document.getElementById('btn-cancel-cat').style.display = 'none';
            document.getElementById('edit-cat-indicator').style.display = 'none';
        }

        // 4. RESULTS ENTRY
        function setupResForm() {
            const cid = document.getElementById('res-cat-select').value;
            const area = document.getElementById('res-form-area');
            area.innerHTML = '';
            if(!cid) return;

            const cat = db.categories.find(c => c.id === cid);
            const existing = db.results.find(r => r.categoryId === cid);
            if(existing) document.getElementById('res-date').value = existing.date;

            let html = '';
            db.competitors.forEach(p => {
                const country = db.countries.find(c => c.id === p.countryId);
                let val = '', dnf = false;
                if(existing) {
                    const e = existing.entries.find(x => x.competitorId === p.id);
                    if(e) { val = e.value; dnf = e.isDNF; }
                }

                html += `
                <div class="glass-panel" style="padding:10px; display:flex; align-items:center; gap:10px;">
                    <div style="flex:1;">
                        <span style="font-size:0.8rem; color:var(--text-dim);">${country.name}</span><br>
                        <strong>${p.name}</strong>
                    </div>
                    <div style="flex:1;">
                        <input type="number" step="0.01" class="r-val" data-pid="${p.id}" value="${val}" placeholder="${cat.unit}">
                    </div>
                    <div style="width:60px; text-align:center;">
                        <small>DNF</small><br>
                        <input type="checkbox" class="r-dnf" data-pid="${p.id}" ${dnf?'checked':''}>
                    </div>
                </div>`;
            });
            html += `<button class="btn-primary" onclick="submitResults('${cid}')">SHRANI</button>`;
            area.innerHTML = html;
        }

        function submitResults(cid) {
            const date = document.getElementById('res-date').value;
            if(!date) return alert("Datum!");
            
            const entries = [];
            document.querySelectorAll('.r-val').forEach(inp => {
                const pid = inp.getAttribute('data-pid');
                const val = parseFloat(inp.value);
                const isDNF = document.querySelector(`.r-dnf[data-pid="${pid}"]`).checked;
                
                if(!isNaN(val) || isDNF) {
                    entries.push({ competitorId: pid, value: isNaN(val)?0:val, isDNF });
                }
            });

            const idx = db.results.findIndex(r => r.categoryId === cid);
            const obj = { categoryId: cid, date, entries };
            if(idx >= 0) db.results[idx] = obj;
            else db.results.push(obj);
            
            saveDB(); alert("Shranjeno!");
        }

        // --- RENDER ADMIN LISTS ---
        function refreshAdmin() {
            // Selects
            const countryOpts = db.countries.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('comp-country-select').innerHTML = countryOpts;
            
            const catOpts = `<option value="">-- Izberi --</option>` + db.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('res-cat-select').innerHTML = catOpts;

            // Lists
            // 1. Cats
            const clist = document.getElementById('list-cats');
            clist.innerHTML = db.categories.map(c => `
                <li style="display:flex; justify-content:space-between; margin-bottom:5px; background:rgba(255,255,255,0.05); padding:8px;">
                    <span>${c.name}</span>
                    <div>
                        <button class="btn-sm btn-primary" onclick="editCat('${c.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-sm btn-danger" onclick="deleteCat('${c.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </li>`).join('');

            // 2. Countries
            const colist = document.getElementById('list-countries');
            colist.innerHTML = db.countries.map(c => `
                <li style="display:flex; justify-content:space-between; margin-bottom:5px; background:rgba(255,255,255,0.05); padding:8px;">
                    <span><img src="${getFlagUrl(c.code)}" width="20"> ${c.name}</span>
                    <div>
                        <button class="btn-sm btn-primary" onclick="editCountry('${c.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-sm btn-danger" onclick="deleteCountry('${c.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </li>`).join('');

            // 3. Competitors
            const plist = document.getElementById('list-competitors');
            plist.innerHTML = db.competitors.map(p => {
                const c = db.countries.find(x => x.id === p.countryId);
                return `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; background:rgba(255,255,255,0.05); padding:8px;">
                    <span>${p.name} <small style="color:#888">(${c.name})</small></span>
                    <div>
                        <button class="btn-sm btn-primary" onclick="editCompetitor('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-sm btn-danger" onclick="deleteCompetitor('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function refresh() {
            renderMedals();
            renderTotalScore('all', document.querySelector('#section-total .tab-pill'));
            // Refresh selects needed for public view
            const pubSel = document.getElementById('public-cat-select');
            const oldVal = pubSel.value;
            pubSel.innerHTML = `<option value="">-- Izberi disciplino --</option>` + db.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            pubSel.value = oldVal;
            
            if(isLoggedIn) refreshAdmin();
        }

        // Init
        window.onload = function() {
            refresh();
            document.getElementById('res-date').valueAsDate = new Date();
        }

    </script>
</body>
</html>
